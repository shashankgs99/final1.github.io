"use strict";!function(){var app=angular.module("app");app.directive("handsontableDjangoReadonly",["$state","$window","$injector","$timeout","HandsonApiAdapter","UserService",function($state,$window,$injector,$timeout,HandsonApiAdapter,UserService){var directive={};directive.replace=!0,directive.restrict="AE",directive.scope={},directive.templateUrl="/assets/js/directives/handsontable/partials/handsontable-readonly.html";var rental_period_types=[];return directive.link=function(scope,el,attr){scope.$on("filtersData",function(evt,data){scope.params=data,scope.render(scope.params)}),attr.params&&(scope.params=JSON.parse(attr.params)),attr.height?scope.height=attr.height:scope.height=500,attr.minRows?scope.minRows=attr.minRows:scope.minRows=5,scope.serviceName=attr.apiService,scope.apiService=$injector.get(attr.apiService),"InventoryService"===scope.serviceName&&scope.apiService.getRentalPeriodTypes().then(function(data){rental_period_types=data.data.results}),UserService.getRoleTypes().then(function(roledata){scope.roleTypes=roledata.data.results}),scope.render=function(params){params&&(scope.params=params),($state.current.name.includes("supplierDashboard.rental")||$state.current.name.includes("marketDashboard.rental"))&&(scope.params.stock_or_inventory=["Rental"]),scope.isDataLoaded=!1,$timeout(function(){scope.apiService.getSchema().then(function(schema){scope.apiService.get(scope.params).then(function(data){scope.count=data.data.count;var data=data.data.results;"InventoryService"===scope.serviceName&&(data=mapRentalPeriod(data)),data=data.map(function(item){if(item.supplier&&item.supplier.supplier&&(item.supplier=item.supplier.supplier),item.company&&(item.company=item.company.company_name),item.logo){var attachment=item.logo.split("/");item.logo=attachment.pop()}if(item.attachments&&!angular.isArray(item.attachments)){var attachment=item.attachments.split("/");item.attachments=attachment.pop()}if(item.attachments&&angular.isArray(item.attachments)&&item.attachments.length&&(item.attachments=item.attachments.map(function(file){if(file.s3_url){var attachment=file.s3_url.split("/");return file.s3_url=attachment.pop(),file}var attachment=file.split("/");return file=attachment.pop()})),item.product_images&&angular.isArray(item.product_images)&&item.product_images.length&&(item.product_images=item.product_images.map(function(file){var attachment=file.s3_url.split("/");return file.s3_url=attachment.pop(),file})),item.image_url){var attachment=item.image_url.split("/");item.image_url=attachment.pop()}item.supplier_company&&(item.supplier_company=item.supplier_company.company_name),item.manufacturer_company&&(item.manufacturer_company=item.manufacturer_company.company_name),item.city&&item.city.city&&(item.city=item.city.city),item.category&&item.category.category_id&&(item.category=item.category.category_id),item.attachments&&angular.isArray(item.attachments)&&item.attachments.length&&(item.attachments=item.attachments.map(function(attachment){return attachment.s3_url?attachment.s3_url:attachment})),item.product_images&&angular.isArray(item.product_images)&&item.product_images.length&&(item.product_images=item.product_images.map(function(image){return image.s3_url})),item.total_quantity&&(item.total_quantity=Math.floor(parseInt(item.total_quantity))),item.discount&&(item.discount=item.discount+"%"),item.premium&&(item.premium=item.premium+"%"),item.quantity_to_show&&(item.quantity_to_show=item.quantity_to_show+"%"),item.contact_no&&item.country_code&&(item.contact_no=item.country_code+"-"+item.contact_no);var itemType=[];return item.role_type&&(item.role_type.forEach(function(item){if(item.role_type_name)itemType.push(item.role_type_name);else{var rt=scope.roleTypes.filter(function(type){return type.id===item});itemType.push(rt[0].role_type_name)}}),item.role_type=itemType),item.quantity_sold&&(item.quantity_sold=Math.floor(parseInt(item.quantity_sold))),item.project&&(item.project=item.project.name?item.project.name:item.project),item.project_type&&(item.project_type=item.project_type.name?item.project_type.name:item.project_type),item.parent_project&&(item.parent_project=item.parent_project.name?item.parent_project.name:item.parent_project),item.customer_client&&(item.customer_client=item.customer_client.name?item.customer_client.name:item.customer_client),item.customer_contractor&&(item.customer_contractor=item.customer_contractor.name?item.customer_contractor.name:item.customer_contractor),item.industries&&(item.industries=item.industries.map(function(item){return item.industry}),item.industries=item.industries.join()),item.owner&&(item.owner=item.owner.email?item.owner.email:item.owner),item.sender?item.sender=item.sender.email?item.sender.email:item.sender:(item.sender_email||item.sender_mobile)&&(item.sender=item.sender_email+(item.sender_mobile?", "+item.sender_mobile:"")),item.receiver&&(item.receiver=item.receiver.email?item.receiver.email:item.receiver),item.contacts&&(item.contacts=item.contacts.map(function(item){return item.firstname+" "+(item.lastname?item.lastname:"")}),item.contacts=item.contacts.join()),item.enquiry_type&&(item.enquiry_type=item.enquiry_type.name),item}),scope.currentPage=1,scope.limit=50,scope.next=function(){scope.currentPage*scope.limit<data.length&&(scope.currentPage++,scope.refreshData())},scope.prev=function(){scope.currentPage>1&&(scope.currentPage--,scope.refreshData())},scope.refreshData=function(){(scope.currentPage-1)*scope.limit;scope.data=data},scope.refreshData(),scope.settings={colHeaders:HandsonApiAdapter.generateColHeadersFromSchema(schema.data,attr.excludeFields,attr.includeFields,scope.serviceName),columns:HandsonApiAdapter.generateColInfoArrayFromSchema(schema.data,!0,attr.excludeFields,attr.includeFields,scope.serviceName),minRows:scope.minRows,dropdownMenu:["filter_by_value","filter_action_bar"],viewportRowRenderingOffset:200,viewportColumnRenderingOffset:30,filters:!0,height:attr.height,columnSorting:{column:0,sortOrder:!0,sortEmptyCells:!1}},scope.isDataLoaded=!0})})},2e3)};var mapRentalPeriod=function(records){return records=records.map(function(item){if("Rental"===item.stock_or_inventory){var types=rental_period_types.filter(function(type){return type.id===item.rental_period});types.length?item.rental_period=types[0].period_type:item.rental_period=null}else item.rental_period=null;return item})};attr.$observe("params",function(val){scope.params=JSON.parse(val),scope.render()}),scope.render()},directive}]),app.directive("handsontableDjangoFullaccess",["$log","$window","$injector","$timeout","HandsonApiAdapter","CsvService","$modal","s3Service","Notification","SupplierService","$http","UserService","$state","$rootScope","$stateParams","CustomerService",function($log,$window,$injector,$timeout,HandsonApiAdapter,CsvService,$modal,s3Service,Notification,SupplierService,$http,UserService,$state,$rootScope,$stateParams,CustomerService){var directive={};directive.replace=!0,directive.restrict="AE",directive.scope=!1,directive.templateUrl="/assets/js/directives/handsontable/partials/handsontable-fullaccess.html";var rental_period_types=[],_productImages=[],_fileAttachments=[];return directive.controller=["$scope","$location","$window",function($scope,$location,$window){$scope.importData=function(csvfile,service){service&&($scope.serviceName=service);$scope.csvfile;if("CustomerService"===$scope.serviceName||"CompanyService"===$scope.serviceName||"UserService"===$scope.serviceName||"MessageService"===$scope.serviceName||"CustomerContactService"==$scope.serviceName||"SupplierCategoryService"==$scope.serviceName)$scope.data=CsvService.csvParser(csvfile,$scope.serviceName);else{var company;$scope.current_user.data.company&&$scope.current_user.data.company.company_name&&"adminDashboard.directory.addMultipleProducts"!==$state.current.name&&"adminDashboard.inventory.addMultipleInventories"!==$state.current.name&&(company=$scope.current_user.data.company.company_name),$scope.selectedIndustry&&($scope.selectedIndustry=$scope.selectedIndustry.filter(function(item){return 0!==item.id})),$scope.data=CsvService.csvParser(csvfile,$scope.serviceName,company,null,$scope.selectedIndustry)}if("CustomerContactService"==$scope.serviceName){$scope.data=$scope.data.filter(function(record){return void 0!==record.name&&null!==record.name}),$scope.customerContacts=[];var contacts=$scope.data,result=_.groupBy($scope.data,"name");for(var key in result){result[key];CustomerService.getCustomerId({name:key}).then(function(data){data.data?contacts.map(function(item){item.name==data.data.name&&(item.id=data.data.id,data.data.contacts.length?item.contacts=data.data.contacts:item.contacts=[],data.data.addresses.length&&(item.addresses=data.data.addresses),data.data.attachments.length&&(item.attachments=data.data.attachments),data.data.catalogs.length&&(item.catalogs=data.data.catalogs),data.data.categories.length&&(item.categories=data.data.categories),$scope.customerContacts.push(item))}):Notification.error({message:"customer :"+key+" not in database",positionX:"right",positionY:"top"})})}}if("SupplierCategoryService"==$scope.serviceName){$scope.data=$scope.data.filter(function(record){return void 0!==record.name&&null!==record.name}),$scope.customerCategories=[];var categories=$scope.data,result=_.groupBy($scope.data,"name");for(var key in result){result[key];CustomerService.getCustomerId({name:key}).then(function(data){data.data&&categories.map(function(item){item.name==data.data.name&&(item.id=data.data.id,data.data.categories.length?item.categories=data.data.categories:item.categories=[],data.data.addresses.length&&(item.addresses=data.data.addresses),data.data.attachments.length&&(item.attachments=data.data.attachments),data.data.catalogs.length&&(item.catalogs=data.data.catalogs),data.data.contacts.length&&(item.contacts=data.data.contacts),$scope.customerCategories.push(item))})})}}$scope.importFromCsv=!0,$scope.hideButtonImport=!0,$scope.disableImport=!0,Notification.success({message:"Successfully imported file",positionX:"right",positionY:"top"}),"MessageService"===$scope.serviceName&&$scope.getRequistionData($scope.data)},$scope.deleteEnquiry=function(data,changes,totaldata){var arr=[];if($state.current.name.includes("adminDashboard.enquiries.viewEnquiries")&&arr.push(data),$state.current.name.includes("supplierDashboard.enquiries.viewEnquiries")&&arr.push(data),$state.current.name.includes("buyerDashboard.enquiries.viewEnquiries")?arr.push(data):arr=data,arr.length<1)return void Notification.error({message:"Please select atleast one item to delete",positionX:"right",positionY:"top"});var deleteRows=[];arr.forEach(function(item){deleteRows.push([item.id])}),$scope.save(changes,deleteRows,totaldata,"enquiry")},$scope.deleteCompany=function(data,changes,totaldata){var arr=[];if($state.current.name.includes("adminDashboard.company.view")?arr.push(data):arr=data,arr.length<1)return void Notification.error({message:"Please select atleast one item to delete",positionX:"right",positionY:"top"});var deleteRows=[];arr.forEach(function(item){deleteRows.push([item.id])}),$scope.save(changes,deleteRows,totaldata,"company")},$scope.deleteOffer=function(data,changes,totaldata){var arr=[];if($state.current.name.includes("adminDashboard.offers.viewOffer")?arr.push(data):$state.current.name.includes("supplierDashboard.offers.viewOffer")?arr.push(data):$state.current.name.includes("buyerDashboard.offers.viewOffer")?arr.push(data):arr=data,arr.length<1)return void Notification.error({message:"Please select atleast one item to delete",positionX:"right",positionY:"top"});var deleteRows=[];arr.forEach(function(item){deleteRows.push([item.id])}),$scope.save(changes,deleteRows,totaldata,"offer")},$scope.deleteData=function(data,changes,totaldata){if($scope.selectData){data=totaldata;var deleteRows=[];data.forEach(function(item){item.active&&deleteRows.push([item.id])})}else{if(data.length<1)return void Notification.error({message:"Please select atleast one item to delete",positionX:"right",positionY:"top"});var deleteRows=[];data.forEach(function(item){deleteRows.push([item[4]])})}$scope.save(changes,deleteRows,totaldata)},$scope.save=function(changes,deletes,initial_data,controlType,quantityToShow){if($scope.errors=[],$state.current.name.includes("adminDashboard")){if(!$state.current.name.includes("adminDashboard.user")&&!$state.current.name.includes("adminDashboard.enquiries.viewEnquiries"))var companyName=initial_data[0].supplier_company;UserService.getCompanyEmail({company:companyName}).then(function(res){$scope.supplierEmail=res.data[0]})}var post_or_put=HandsonApiAdapter.postOrPut(changes),post_records=HandsonApiAdapter.postRecords(post_or_put.post),put_records=HandsonApiAdapter.putRecords(post_or_put.put),delete_records=HandsonApiAdapter.deleteRecords(deletes);if($scope.importFromCsv&&("CustomerContactService"===$scope.serviceName||"SupplierCategoryService"===$scope.serviceName)){if(put_records=angular.copy($scope.customerContacts),"CustomerContactService"===$scope.serviceName){put_records=put_records.filter(function(record){return void 0!==record.name&&null!==record.name&&void 0!==record.firstname&&null!==record.firstname});put_records=put_records.map(function(customer){var obj={};return delete customer.name,customer.address&&(obj.addressline1=customer.address,obj.nameofaddress="default",delete customer.address),customer.city&&(obj.cityname=customer.city,delete customer.city),customer.state&&(obj.state=customer.state,delete customer.state),customer.country&&(obj.country=customer.country,delete customer.country),customer.firstname&&(obj.firstname=customer.firstname,delete customer.firstname),customer.lastname&&(obj.lastname=customer.lastname,delete customer.lastname),customer.emailid1&&(obj.emailid1=customer.emailid1,delete customer.emailid1),customer.emailid2&&(obj.emailid2=customer.emailid2,delete customer.emailid2),customer.countryCode1&&(obj.countryCode1=customer.countryCode1,delete customer.countryCode1),customer.countryCode2&&(obj.countryCode2=customer.countryCode2,delete customer.countryCode2),customer.phonenumber1&&(obj.phonenumber1=customer.phonenumber1,delete customer.phonenumber1),customer.phonenumber2&&(obj.phonenumber2=customer.phonenumber2,delete customer.phonenumber2),customer.facebook_url&&(obj.facebook_url=customer.facebook_url,delete customer.facebook_url),customer.countryCode2&&(obj.countryCode2=customer.countryCode2,delete customer.countryCode2),customer.phonenumber1&&(obj.phonenumber1=customer.phonenumber1,delete customer.phonenumber1),customer.phonenumber2&&(obj.phonenumber2=customer.phonenumber2,delete customer.phonenumber2),customer.twitter_url&&(obj.twitter_url=customer.twitter_url,delete customer.twitter_url),customer.linkedin_url&&(obj.linkedin_url=customer.linkedin_url,delete customer.linkedin_url),customer.youtube_url&&(obj.youtube_url=customer.youtube_url,delete customer.youtube_url),Object.keys(obj).length&&customer.contacts.push(obj),customer})}"SupplierCategoryService"===$scope.serviceName&&(put_records=angular.copy($scope.customerCategories),put_records=put_records.filter(function(record){return void 0!==record.name&&null!==record.name&&void 0!==record.parent_category&&null!==record.parent_category}),put_records=put_records.filter(function(record){var obj={};return record.parent_category&&(obj.parent_category=record.parent_category,delete record.parent_category,delete record.name,record.sub_category&&(obj.sub_category=record.sub_category,delete record.sub_category),record.sub_sub_category&&(obj.sub_sub_category=record.sub_sub_category,delete record.sub_sub_category),record.sub_sub_sub_category&&(obj.sub_sub_sub_category=record.sub_sub_sub_category,delete record.sub_sub_sub_category)),Object.keys(obj).length&&record.categories.push(obj),record}))}if(!$scope.importFromCsv||"InventoryService"!==$scope.serviceName&&"DirectoryService"!==$scope.serviceName&&"UserService"!==$scope.serviceName||(post_records=initial_data,post_records="UserService"===$scope.serviceName?post_records.filter(function(record){return null!==record.email&&void 0!==record.email}):post_records.filter(function(record){return null!==record.title&&void 0!==record.title&&null!=record.category_name&&void 0!=record.category_name})),($scope.importFromCsv&&"CompanyService"===$scope.serviceName||$scope.importFromCsv&&"CustomerService"===$scope.serviceName)&&(post_records=initial_data,"CustomerService"===$scope.serviceName&&(post_records=post_records.filter(function(record){return void 0!==record.name&&null!==record.name})),"CompanyService"===$scope.serviceName&&(post_records=post_records.filter(function(record){return void 0!==record.company_name&&null!==record.company_name}),post_records.filter(function(record){if(record.establishment_type){var data=record.establishment_type.toLowerCase(),result=_.includes(["public","private","llc","fze","fzc","government"],data);result?record.establishment_type=record.establishment_type:(record.establishment_type_other=record.establishment_type,record.establishment_type="")}record.profit_currency&&(record.revenue_currency=record.profit_currency),record.addresses=[];var add={};if(record.address&&(add.addressline1=record.address,add.nameofaddress="default",record.city&&(add.cityname=record.city),record.state&&(add.state=record.state),record.country&&(add.country=record.country)),Object.keys(add).length&&(record.city?record.addresses.push(add):record.addresses=[]),record.company_type){var companyType=record.company_type.toLowerCase(),companyResult=_.includes(["micro","small","medium","large","multinational","conglomorate"],companyType);companyResult?record.company_type=record.company_type:(record.company_type_other=record.company_type,record.company_type="")}if(record.role_type){var roles=[],roleType=record.role_type.toLowerCase();if(record.role_type.includes(",")){var list=record.role_type.split(",");list.map(function(r){$scope.roleTypes.map(function(o){o.role_type_name.toLowerCase()==r.toLowerCase()&&roles.push(o.id)})}),roles=_.uniq(roles)}else $scope.roleTypes.map(function(o){o.role_type_name.toLowerCase()==roleType&&roles.push(o.id)})}record.role_type=roles}))),$scope.progress=0,$scope.total_changes=post_records.length+put_records.length+delete_records.length,"InventoryService"===$scope.serviceName||"DirectoryService"===$scope.serviceName||"FaqService"===$scope.serviceName||"CustomerService"===$scope.serviceName||"CompanyService"===$scope.serviceName){if(post_records.length){if($scope.current_user.data.is_admin_supplier&&$scope.current_user.data.company&&"adminDashboard"!=$state.current.name)for(i=0;i<post_records.length;i++)post_records[i].supplier_company=$scope.current_user.data.company.company_name;"InventoryService"===$scope.serviceName&&(post_records=mapRentalPeriod(post_records,"id")),_fileAttachments&&_fileAttachments.length&&("InventoryService"===$scope.serviceName||"DirectoryService"===$scope.serviceName||"FaqService"===$scope.serviceName)&&(post_records=post_records.map(function(item){return item.attachments=_fileAttachments,item})),_productImages&&_productImages.length&&("InventoryService"===$scope.serviceName||"DirectoryService"===$scope.serviceName)&&(post_records=post_records.map(function(item){return item.product_images=_productImages,item.image_url=_productImages[0],item})),"CustomerService"===$scope.serviceName&&post_records.map(function(single_post_request){if(single_post_request.contacts=[],single_post_request.role_type){var roles=angular.copy(single_post_request.role_type);roles=roles.toLowerCase().split(","),single_post_request.role_type=[],roles.forEach(function(data){data=data.trim();var roleTypes=$scope.roleTypes.filter(function(item){return item.role_type_name.toLowerCase()===data});roleTypes.length>0&&single_post_request.role_type.push(roleTypes[0].id)})}else single_post_request.role_type=[];single_post_request.attachments=[],single_post_request.catalogs=[],single_post_request.addresses&&(single_post_request.address=single_post_request.addresses),single_post_request.addresses=[],single_post_request.categories=[];var add={};return single_post_request.address&&(add.addressline1=single_post_request.address,add.nameofaddress="Default"),single_post_request.city&&(add.cityname=single_post_request.city),single_post_request.state&&(add.state=single_post_request.state),single_post_request.country&&(add.country=single_post_request.country),Object.keys(add).length&&(single_post_request.city?single_post_request.addresses.push(add):single_post_request.addresses=[]),$state.current.name.includes("suppliers")&&(single_post_request.role_type=[8]),single_post_request}),"CompanyService"===$scope.serviceName&&post_records.map(function(single_post_request){return single_post_request.contact=[],single_post_request.role_type&&single_post_request.role_type.length||(single_post_request.role_type=[]),single_post_request.is_buyer||(single_post_request.is_buyer=!1),single_post_request.is_seller||(single_post_request.is_seller=!1),single_post_request.revenue_confidential||(single_post_request.revenue_confidential=!1),single_post_request.not_to_provide||(single_post_request.not_to_provide=!1),single_post_request}),$scope.apiService.post(post_records).then(function(response){if($scope.progress+=post_records.length,$state.current.name.includes("adminDashboard")&&$scope.supplierEmail){var link="https://www.supplierscave.com/supplier-dashboard"+$state.current.url,count=response.data.length;$http.get("/sendgrid/send-product-email/",{params:{count:count,firstName:$scope.supplierEmail,admin:$scope.current_user.data.username,link:link}}).then(function(res){Notification.success({message:"Successfully sent email to the Supplier",positionX:"right",positionY:"top"}),$scope.ok()})}refreshPage()})["catch"](function(error){if($scope.errors.push(error),400==error.status){var data=error.data;data.forEach(function(item){angular.forEach(item,function(value,key){"available_quantity"===key?Notification.error({message:"Available Quantity : "+value,positionX:"right",positionY:"top"}):"total_quantity"===key?Notification.error({message:"Total Quantity : "+value,positionX:"right",positionY:"top"}):"quantity_sold"===key?Notification.error({message:"Quantity Sold : "+value,positionX:"right",positionY:"top"}):Notification.error({message:key+" : "+value,positionX:"right",positionY:"top"})})})}else $scope.errors.push(error)})}}else for(var i=0;i<post_records.length;i+=1){var single_post_request=post_records[i];if(delete single_post_request.row,"CompanyService"===$scope.serviceName&&(single_post_request.contact=[],single_post_request.role_type||single_post_request.role_type.length||(single_post_request.role_type=[]),single_post_request.is_buyer||(single_post_request.is_buyer=!1),single_post_request.is_seller||(single_post_request.is_seller=!1),single_post_request.revenue_confidential||(single_post_request.revenue_confidential=!1),single_post_request.not_to_provide||(single_post_request.not_to_provide=!1)),"CustomerService"===$scope.serviceName){if(single_post_request.contacts=[],single_post_request.role_type){single_post_request.role_type.toLowerCase();$scope.roleTypes.map(function(item){item.role_type_name.toLowerCase()==single_post_request.role_type&&(single_post_request.role_type=[item.id])})}else single_post_request.role_type=[];single_post_request.attachments=[],single_post_request.catalogs=[],single_post_request.addresses=[],single_post_request.categories=[];var add={};single_post_request.address&&(add.addressline1=single_post_request.address,add.nameofaddress="default"),single_post_request.city&&(add.cityname=single_post_request.city),single_post_request.state&&(add.state=single_post_request.state),single_post_request.country&&(add.country=single_post_request.country),Object.keys(add).length&&(single_post_request.city?single_post_request.addresses.push(add):single_post_request.addresses=[]),$state.current.name.includes("suppliers")&&(single_post_request.role_type=[8])}$scope.apiService.post(single_post_request).then(function(response){$scope.progress+=1,refreshPage()})["catch"](function(error){$scope.errors.push(error)})}put_records.length&&("InventoryService"===$scope.serviceName&&(put_records=mapRentalPeriod(put_records,"id")),_productImages&&_productImages.length&&("InventoryService"===$scope.serviceName||"DirectoryService"===$scope.serviceName)&&(_productImages=_productImages.filter(function(item){return null!==item&&void 0!==item}),put_records=put_records.map(function(item){return item.product_images=_productImages,item.image_url=_productImages[0],item})),_fileAttachments&&_fileAttachments.length&&("InventoryService"===$scope.serviceName||"DirectoryService"===$scope.serviceName)&&(_fileAttachments=_fileAttachments.filter(function(item){return null!==item&&void 0!==item}),put_records=put_records.map(function(item){return item.attachments=_fileAttachments,item})),controlType&&(controlType.hide_supplier&&(put_records=put_records.map(function(item){return item.hide_supplier=!0,delete item.active,item})),controlType.unhideSupplier&&(put_records=put_records.map(function(item){return item.hide_supplier=!1,delete item.active,item})),controlType.discount&&(put_records=put_records.map(function(item){return item.premium?console.log("Item: "+item.id+" already has premium value. Hence discount cannot be set."):item.discount=parseInt(controlType.discount),delete item.active,item})),controlType.premium&&(put_records=put_records.map(function(item){return item.discount?console.log("Item: "+item.id+" already has discount value. Hence premium cannot be set."):item.premium=parseInt(controlType.premium),delete item.active,item})),controlType.unhidePrice&&(put_records=put_records.map(function(item){return item.hide_price=!1,delete item.active,item})),controlType.price&&(put_records=put_records.map(function(item){return item.hide_price=controlType.price,delete item.active,item})),controlType.hide_data&&(put_records=put_records.map(function(item){return item.hide_data=!0,delete item.active,item})),controlType.unhide_data&&(put_records=put_records.map(function(item){return item.hide_data=!1,delete item.active,item})),"everything"===controlType&&(put_records=put_records.map(function(item){return item.hide_data=!0,delete item.active,item})),"price"===controlType&&(put_records=put_records.map(function(item){return item.hide_price=!0,delete item.active,item})),"supplier"===controlType&&(put_records=put_records.map(function(item){return item.hide_supplier=!0,delete item.active,item})),"quantity"===controlType&&(put_records=put_records.map(function(item){return item.quantity_to_show=quantityToShow,delete item.active,item}))));for(var j=0;j<put_records.length;j+=1){var single_put_request=put_records[j],id=single_put_request.id;delete single_put_request.row,delete single_put_request.id,"CustomerContactService"==$scope.serviceName||"SupplierCategoryService"===$scope.serviceName?CustomerService.update(id,single_put_request).then(function(response){$scope.progress+=1,refreshPage()})["catch"](function(error){$scope.errors.push(error)}):$scope.apiService.update(id,single_put_request).then(function(response){$scope.progress+=1,refreshPage()})["catch"](function(error){$scope.errors.push(error)})}for(var i=0;i<delete_records.length;i+=1){var single_delete_request=delete_records[i],id=single_delete_request[0];id&&$scope.apiService["delete"](id).then(function(response){return $scope.progress+=1,controlType?(Notification.success({message:"Successfully Deleted "+controlType,positionX:"right",positionY:"top"}),"offer"===controlType&&($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.offers.List",{type:$stateParams.type}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.offers.List",{type:$stateParams.type}):$state.go("buyerDashboard.offers.List",{type:$stateParams.type})),"company"===controlType&&$state.go("adminDashboard.company.list"),"enquiry"===controlType&&($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.list",{type:$stateParams.type}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.list",{type:$stateParams.type}):$state.go("buyerDashboard.enquiries.list",{type:$stateParams.type})),void refreshPage()):void refreshPage()})["catch"](function(error){$scope.errors.push(error)})}var refreshPage=function(){if($scope.progress==$scope.total_changes){if($state.current.name.includes("adminDashboard.inventory"))return $state.go("adminDashboard.inventory.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("adminDashboard.company.multipleCompanies"))return $state.go("adminDashboard.company.list"),void $timeout(function(){$window.location.reload()},2500);if($state.current.name.includes("adminDashboard.directory"))return $state.go("adminDashboard.directory.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("supplierDashboard.inventory"))return $state.go("supplierDashboard.inventory.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("supplierDashboard.directory"))return $state.go("supplierDashboard.directory.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("buyerDashboard.suppliers"))return $state.go("buyerDashboard.suppliers.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("buyerDashboard.customers"))return $state.go("buyerDashboard.customers.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("adminDashboard.customers"))return $state.go("adminDashboard.customers.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("supplierDashboard.rental.addMultipleRentals"))return $state.go("supplierDashboard.rental.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("marketDashboard.rental.addMultipleRentals"))return $state.go("marketDashboard.rental.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("marketDashboard.inventory"))return $state.go("marketDashboard.inventory.list"),void $timeout(function(){$window.location.reload()},1500);if($state.current.name.includes("marketDashboard.directory"))return $state.go("marketDashboard.directory.list"),void $timeout(function(){$window.location.reload()},1500);$timeout(function(){$window.location.reload()},2e3)}}};var mapRentalPeriod=function(records){return records=records.map(function(item){var types=rental_period_types.filter(function(type){return type.period_type===item.rental_period});return types.length?item.rental_period=types[0].id:item.rental_period=null,($state.current.name.includes("supplierDashboard.rental.addMultipleRentals")||$state.current.name.includes("marketDashboard.rental.addMultipleRentals"))&&(item.stock_or_inventory="Rental"),item})}}],directive.link=function(scope,el,attr){function openModal(table_changes,table_deletes,data,type){var previousAttachments,previousImages;if(!table_changes.length)return void Notification.error({message:"Please select at least one item",positionX:"right",positionY:"top"});var id,templateModal;"attachments"==type?(templateModal="attachFiles.html",id=table_changes[0][4]):"quantity"==type?templateModal="quantityPercent.html":"managePrice"==type?templateModal="manageprice.html":"manageSupplier"==type?templateModal="manageSupplier.html":"manageItem"==type&&(templateModal="manageItem.html");var params={templateUrl:templateModal,resolve:{},controller:function($scope,$modalInstance){if($scope.productImages=[],$scope.documents=[],"attachFiles.html"===templateModal&&data.forEach(function(item){item.id===id&&(item.attachments&&(previousAttachments=item.attachments),item.product_images&&(previousImages=item.product_images))}),$scope.reposition=function(){$modalInstance.reposition()},"manageSupplier.html"===templateModal&&($scope.SaveSupplier=function(hideSupplier){
var item={};"hideSupplier"===hideSupplier?item.hide_supplier=!0:item.unhideSupplier=!0,$modalInstance.close({manageSupplier:"manageSupplier"}),scope.save(table_changes,table_deletes,data,item)}),$scope.SaveItem=function(data){var item={};"hideItem"===data?item.hide_data=!0:item.unhide_data=!0,$modalInstance.close({manageItem:"manageItem"}),scope.save(table_changes,table_deletes,data,item)},"manageprice.html"===templateModal&&($scope.SaveData=function(price,discount,premium,unhidePrice){if(discount>100)return void Notification.error({message:"discount must be less than 100",positionX:"right",positionY:"top"});if(discount&&premium)return void Notification.error({message:"Please enter either discount or premium. Not both",positionX:"right",positionY:"top"});var item={};"hideprice"==price&&(item.price=!0),"unhideprice"==price&&(item.unhidePrice=!0),discount&&(item.discount=discount),premium&&(item.premium=premium),$modalInstance.close({managePrice:"managePrice"}),scope.save(table_changes,table_deletes,data,item)}),$scope.ok=function(quantity){quantity?quantity>100?$scope.error="Please select quantity less than or equal to 100":quantity<0?$scope.error="Please select quantity greater than or equal to 0":($scope.error=void 0,$modalInstance.close({quantity:quantity})):$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.AddImages=function(){var file={};file.remove=!0,$scope.productImages.push(file)},!$scope.productImages.length){var file={};file.add=!0,$scope.productImages.push(file)}if($scope.uploadData=function(file,$index,type){var upload=!1;if($state.current.name.includes("inventory"))var path="user/"+scope.current_user.data.id+"/inventory/multiFile";if($state.current.name.includes("directory"))var path="user/"+scope.current_user.data.id+"/directory/multiFile";if($state.current.name.includes("Rental"))var path="user/"+scope.current_user.data.id+"/rental/multiFile";s3Service.uploadFile(path,file,function(url){"product-images"===type?(_productImages.length?(_productImages.forEach(function(item){item.index==$index&&(upload=!0,item.url=url)}),upload||_productImages.push({url:url,index:$index})):_productImages.push({url:url,index:$index}),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})):"file-attachments"===type&&(_fileAttachments.length?(_fileAttachments.forEach(function(item){item.index==$index&&(upload=!0,item.url=url)}),upload||_fileAttachments.push({url:url,index:$index})):_fileAttachments.push({url:url,index:$index}),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}))},function(error){$scope.saveFile=!1,$scope.saveImages=!1,$scope.disabled=!1,errorCallback(error)})},$scope.removeImages=function(files,index){files.splice(index,1),_productImages.splice(index,1)},!$scope.documents.length){var file={};file.add=!0,$scope.documents.push(file)}$scope.addDocuments=function(){var file={};file.remove=!0,$scope.documents.push(file)},$scope.removeDocuments=function(files,index){files.splice(index,1),_fileAttachments.splice(index,1)}}};params.closeOnClick=!1,params.size="attachments"===type?"medium":"tiny";var modalInstance=$modal.open(params);modalInstance.result.then(function(result){result?result.quantity?scope.save(table_changes,table_deletes,data,"quantity",result.quantity):result.managePrice||(_productImages.length&&(_productImages=_productImages.map(function(item){return item.url}),previousImages.length&&(_productImages=_productImages.concat(previousImages))),_fileAttachments.length&&(_fileAttachments=_fileAttachments.map(function(item){return item.url}),previousAttachments.length&&(_fileAttachments=_fileAttachments.concat(previousAttachments))),scope.save(table_changes,table_deletes,data,"attachments")):(_productImages.length&&(_productImages=_productImages.map(function(item){return item.url}),previousImages.length&&(_productImages=_productImages.concat(previousImages))),_fileAttachments.length&&(_fileAttachments=_fileAttachments.map(function(item){return item.url}),previousAttachments.length&&(_fileAttachments=_fileAttachments.concat(previousAttachments))),scope.save(table_changes,table_deletes,data,"attachments"))},function(){$log.info("Modal dismissed at: "+new Date)})}scope.serviceName=attr.apiService,scope.apiService=$injector.get(attr.apiService),"InventoryService"===scope.serviceName&&scope.apiService.getRentalPeriodTypes().then(function(data){rental_period_types=data.data.results}),attr.height?scope.height=attr.height:scope.height=500,attr.minRows?scope.minRows=attr.minRows:scope.minRows=5,attr.minSpareRows?scope.minSpareRows=attr.minSpareRows:scope.minSpareRows=10,attr.params&&(scope.params=JSON.parse(attr.params)),attr.populateData?scope.populateData=attr.populateData:scope.populateData=!0,UserService.getRoleTypes().then(function(roledata){scope.roleTypes=roledata.data.results}),scope.table_changes=[],scope.table_deletes=[],scope.errors=[],scope.render=function(params){params&&(scope.params=params),($state.current.name.includes("supplierDashboard.rental")||$state.current.name.includes("marketDashboard.rental"))&&(scope.params.stock_or_inventory=["Rental"]),($state.current.name.includes("supplierDashboard.inventory")||$state.current.name.includes("marketDashboard.inventory"))&&(scope.params.stock_or_inventory={value:"Rental",operator:"!="}),scope.isDataLoaded=!1,scope.apiService.getSchema().then(function(schema){scope.apiService.get(scope.params).then(function(data){scope.count=data.data.count,"false"==scope.populateData?scope.data=[]:(scope.data=data.data.results,scope.data=scope.data.map(function(item){if(item.active=!1,item.category&&item.category.category_id&&(item.category=item.category.category_id),item.city&&item.city.city&&(item.city=item.city.city),item.company&&item.company.company_name&&(item.company=item.company.company_name),item.supplier_company&&(item.supplier_company=item.supplier_company.company_name),item.manufacturer_company&&(item.manufacturer_company=item.manufacturer_company.company_name),item.attachments&&angular.isArray(item.attachments)&&item.attachments.length&&(item.attachments=item.attachments.map(function(attachment){return attachment.s3_url?attachment.s3_url:attachment})),item.logo){var attachment=item.logo.split("/");item.logo=attachment.pop()}if(item.product_images&&angular.isArray(item.product_images)&&item.product_images.length&&(item.product_images=item.product_images.map(function(image){var attachment=image.s3_url.split("/");return image.s3_url=attachment.pop(),image.s3_url})),item.attachments&&angular.isArray(item.attachments)&&item.attachments.length&&(item.attachments=item.attachments.map(function(file){if(file.s3_url){var attachment=file.s3_url.split("/");return file.s3_url=attachment.pop(),file}if((""===file.s3_url||void 0===file.s3_url||!file.s3_url)&&file&&file.includes("/")){var attachment=file.split("/");return file=attachment.pop()}})),item.attachments&&!angular.isArray(item.attachments)){var attachment=item.attachments.split("/");item.attachments=attachment.pop()}if(item.aboutus_images&&angular.isArray(item.aboutus_images)&&item.aboutus_images.length&&(item.aboutus_images=item.aboutus_images.map(function(file){var attachment=file.split("/");return file=attachment.pop()})),item.catalogs&&angular.isArray(item.catalogs)&&item.catalogs.length&&(item.catalogs=item.catalogs.map(function(file){var attachment=file.split("/");return file=attachment.pop()})),item.image_url){var attachment=item.image_url.split("/");item.image_url=attachment.pop()}item.total_quantity&&(item.total_quantity=Math.floor(parseInt(item.total_quantity))),item.quantity_sold&&(item.quantity_sold=Math.floor(parseInt(item.quantity_sold))),item.quantity_to_show&&(item.quantity_to_show=item.quantity_to_show+"%"),item.discount&&(item.discount=item.discount+"%"),item.premium&&(item.premium=item.premium+"%"),item.contact_no&&item.country_code&&(item.contact_no=item.country_code+"-"+item.contact_no);var itemType=[];return item.role_type&&(item.role_type.forEach(function(item){if(item.role_type_name)itemType.push(item.role_type_name);else{var rt=scope.roleTypes.filter(function(type){return type.id===item});itemType.push(rt[0].role_type_name)}}),item.role_type=itemType),item.project&&(item.project=item.project.name?item.project.name:item.project),item.project_type&&(item.project_type=item.project_type.name?item.project_type.name:item.project_type),item.parent_project&&(item.parent_project=item.parent_project.name?item.parent_project.name:item.parent_project),item.customer_client&&(item.customer_client=item.customer_client.name?item.customer_client.name:item.customer_client),item.customer_contractor&&(item.customer_contractor=item.customer_contractor.name?item.customer_contractor.name:item.customer_contractor),item.industries&&(item.industries=item.industries.map(function(item){return item.industry}),item.industries=item.industries.join()),item.owner&&(item.owner=item.owner.email?item.owner.email:item.owner),item.sender?item.sender=item.sender.email?item.sender.email:item.sender:(item.sender_email||item.sender_mobile)&&(item.sender=item.sender_email+(item.sender_mobile?", "+item.sender_mobile:"")),item.receiver&&(item.receiver=item.receiver.email?item.receiver.email:item.receiver),item.contacts&&(item.contacts=item.contacts.map(function(item){return item.firstname+" "+(item.lastname?item.lastname:"")}),item.contacts=item.contacts.join()),item.enquiry_type&&(item.enquiry_type=item.enquiry_type.name),item.categories&&item.categories.length&&(item.categories=item.categories.map(function(category){return category.category_id})),item.addresses&&item.addresses.length&&(item.addresses=item.addresses.map(function(add){var add=add.nameofaddress+"\n                              "+add.addressline1+"\n                              "+add.country+"\n                              "+add.state+"\n                              "+add.cityname;return add})),item}),"CompanyService"==scope.serviceName&&(scope.data=_.sortBy(scope.data,"company_name","created_date")),"InventoryService"===scope.serviceName&&(scope.data=mapRentalPeriod(scope.data))),scope.params&&(scope.params.mode?scope.value=!0:scope.value=!1,"disablecolumns"==scope.params.type&&(scope.disable=!0)),scope.settings={colHeaders:HandsonApiAdapter.generateColHeadersFromSchema(schema.data,attr.excludeFields,!1,scope.serviceName,scope.presentPage),columns:HandsonApiAdapter.generateColInfoArrayFromSchema(schema.data,!1,attr.excludeFields,!1,scope.serviceName,scope.value,scope.presentPage,scope.disable),minRows:scope.minRows,minSpareRows:scope.minSpareRows,dropdownMenu:["filter_by_value","filter_action_bar"],filters:!0,viewportRowRenderingOffset:500,viewportColumnRenderingOffset:20,contextMenu:["remove_row"],columnSorting:{column:0,sortOrder:!0,sortEmptyCells:!1},onAfterInit:function(){},onAfterChange:function(changes){if("Id"==this.getColHeader()[0]||"Id"==this.getColHeader()[1]){if(scope.hData=this,changes){for(var i=0;i<changes.length;i+=1){changes[i]&&changes[i][3]&&""===changes[i][3]&&(changes[i][3]=null);var id;if(id="Id"==this.getColHeader()[0]?0:1,null!=changes[i]&&this.getDataAtCell(changes[i][0],id)&&(changes[i][4]=this.getDataAtCell(changes[i][0],id)),null!=changes[i]&&"active"===changes[i][1]&&changes[i][3]===!1)return void(scope.table_changes=scope.table_changes.filter(function(item){return item[4]!==changes[i][4]}))}scope.table_changes=scope.table_changes.concat(changes)}}else if(changes){if(this.getColHeader().indexOf("Created")==-1)var auto_gen_col_id=this.getColHeader().indexOf("Created Date");else var auto_gen_col_id=this.getColHeader().indexOf("Created");for(var i=0;i<changes.length;i+=1)""===changes[i][3]&&(changes[i][3]=null),this.getDataAtCell(changes[i][0],auto_gen_col_id)&&(changes[i][4]=this.getDataAtCell(changes[i][0],0));scope.table_changes=scope.table_changes.concat(changes)}},onBeforeRemoveRow:function(index,amount,logicalRows){var id;id="Id"==this.getColHeader()[0]?0:1;var deletes=this.getData(index,id,index+amount-1,id);scope.$apply(function(){scope.table_deletes=scope.table_deletes.concat(deletes)})}},scope.isDataLoaded=!0})})},scope.checkAll=function(data){data?(scope.selectData=!1,scope.data=scope.data.map(function(item){return item.active=!1,item})):(scope.selectData=!0,scope.data=scope.data.map(function(item){return item.active=!0,item}))};var mapRentalPeriod=function(records){return records=records.map(function(item){if("Rental"===item.stock_or_inventory){var types=rental_period_types.filter(function(type){return type.id===item.rental_period});types.length?item.rental_period=types[0].period_type:item.rental_period=null}else item.rental_period=null;return item})};scope.openModal=openModal,attr.$observe("params",function(val){scope.params=JSON.parse(val),scope.render()}),scope.render(),scope.uploadImages=function(files,type){_productImages=[],scope.ImagesLength=files.length,files.forEach(function(file){uploadMultipleFilesFn(file,type)}),files=[]},scope.uploadFiles=function(files,type){_fileAttachments=[],scope.filesLength=files.length,files.forEach(function(file){uploadMultipleFilesFn(file,type)}),files=[]},scope.removeFile=function(files,index){files.splice(index,1),_fileAttachments.splice(index,1)},scope.removeImg=function(img,index){img.splice(index,1),_productImages.splice(index,1)},scope.removeProducts=function(files,index){files.splice(index,1),_productImages.splice(index,1)},scope.removeDocuments=function(files,index){files.splice(index,1),_fileAttachments.splice(index,1)};scope.imagesData=[],scope.documentsData=[],scope.uploadProducts=function(file,$index,type){var path="user/"+scope.current_user.data.id+"/inventory/multiFile";s3Service.uploadFile(path,file,function(url){"product-images"===type?(document.getElementById("upload-images").value=null,_productImages.push(url),scope.imagesData.push(url),scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})):"file-attachments"===type&&(_fileAttachments.push(url),document.getElementById("upload-documents").value=null,scope.documentsData.push(url),scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}))},function(error){errorCallback(error)})}},directive}])}();