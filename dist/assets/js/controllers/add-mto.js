"use strict";!function(){var app=angular.module("app");app.controller("add.MTO",["$scope","$window","$modal","$log","$state","Notification","ProjectService","$http","s3Service","dateService","$rootScope","$stateParams","MTOService","MTOGroupService","$mdDialog","CsvService",function($scope,$window,$modal,$log,$state,Notification,ProjectService,$http,s3Service,dateService,$rootScope,$stateParams,MTOService,MTOGroupService,$mdDialog,CsvService){$scope.mto={};var currentData=[];$scope.fileList=[],$scope.projectNames=[],$scope.uploadedFilesList=[],$scope.disabledData=!1,$scope.disableImport=!1;var fileName;ProjectService.getMainProjects().then(function(data){$scope.projectsInfo=data.data,$scope.projectsInfo.forEach(function(item){$scope.projectNames.push({id:item.id,label:item.name})}),$scope.projectNames=_.uniqBy($scope.projectNames,"id")}),$scope.getFileName=function(){var file=document.getElementById("mto-file");fileName=file.value.split("\\").pop()},$scope.importData=function(csvfile){return currentData=[],fileName?($scope.data=CsvService.csvParser(csvfile,"MTOService"),currentData.push($scope.data),$scope.fileList.push($scope.data),$scope.uploadedFilesList.push({fileName:fileName}),Notification.success({message:"Successfully imported file",positionX:"right",positionY:"top"}),document.getElementById("mto-file").value=null,$scope.disabledData=!0,$scope.disableImport=!0,void 0):void Notification.error({message:"please select file to import",positionX:"right",positionY:"top"})},$scope.save=function(data,$index){var arr=[];if(!data.project)return void Notification.error({message:"please select project",positionX:"right",positionY:"top"});var path="user/"+$scope.current_user.data.id+"/mto";s3Service.uploadFile(path,$scope.csvfile,function(url){var group={};group.project=data.subproject?data.subproject:data.project,group.description=data.notes,group.attachment=url,MTOGroupService.post(group).then(function(result){currentData.map(function(mto){mto.map(function(item){Object.keys(item).length&&(item.project=data.subproject?data.subproject:data.project,item.buyer_notes=data.notes,item.group=result.data.id,arr.push(item))})}),MTOService.post(arr).then(function(data){var uploadedId=[],res=data.data;res.map(function(item){uploadedId.push(item.id)}),Notification.success({message:"Successfully Saved",positionX:"right",positionY:"top"}),$scope.uploadedFilesList.map(function(item,index){$index==index&&(item.save=!0,item.recordId=uploadedId)}),$scope.disabledData=!1,$scope.disableImport=!1})})})},$scope.ViewInfo=function(ev,$index){if(!$scope.mto.project)return void Notification.error({message:"please select project",positionX:"right",positionY:"top"});var final=[],info=$scope.fileList[$index],fileAccess=$scope.uploadedFilesList[$index];if(fileAccess&&fileAccess.save)fileAccess.save=!0,final=info;else{var project=$scope.mto.subproject?$scope.mto.subproject:$scope.mto.project,path="user/"+$scope.current_user.data.id+"/mto";final=info;var group={};group.project=project,group.description=$scope.mto.notes}$mdDialog.show({controller:"viewProductDatatable",templateUrl:"assets/partials/dashboard/buyer/view-product-datatable.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{finalData:final,fileAccess:fileAccess,project:project,path:path,csvfile:$scope.csvfile,groupData:group}}}).then(function(res){res&&res.save&&($scope.disabledData=!1,$scope.disableImport=!1,$scope.uploadedFilesList.map(function(item,index){$index==index&&(item.save=!0)}))},function(){})},$scope.deleteMTO=function($index){var info=[],data=$scope.uploadedFilesList[$index],deleteRecords=data.recordId;deleteRecords?(deleteRecords.map(function(item){MTOService["delete"](item).then(function(data){info.push(data.data),deleteRecords.length===info.length&&Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"})})}),console.log("successfully deleted all records"),$scope.uploadedFilesList.splice($index,1),$scope.fileList.splice($index,1),$scope.disabledData=!1,$scope.disableImport=!1,fileName=null):($scope.disabledData=!1,$scope.disableImport=!1,$scope.fileList.splice($index,1),$scope.uploadedFilesList.splice($index,1),fileName=null)},$scope.Done=function(){$state.go("buyerDashboard.MTO.list")},$scope.subProjectFilter=function(project){$scope.subProjectNames=[],ProjectService.getSubProjects(project).then(function(data){$scope.sub_projects=data.data,$scope.sub_projects&&$scope.sub_projects.forEach(function(item){$scope.subProjectNames.push({id:item.id,label:item.name})})})}}])}();