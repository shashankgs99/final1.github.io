"use strict";!function(){var app=angular.module("app");app.controller("buyers.MTO",["$scope","$window","$modal","$log","$state","Notification","UserService","$http","s3Service","dateService","$rootScope","$stateParams","MTOGroupService","MTOService","ProjectService","$mdDialog","$timeout",function($scope,$window,$modal,$log,$state,Notification,UserService,$http,s3Service,dateService,$rootScope,$stateParams,MTOGroupService,MTOService,ProjectService,$mdDialog,$timeout){function loadMTOList(data){MTOGroupService.get(data).then(function(data){$scope.count=data.data.count,$scope.mtoList=data.data.results,$scope.showLoader=!1,$scope.mtoList=$scope.mtoList.map(function(item){return item.project&&ProjectService.getOne(item.project).then(function(data){item.projectName=data.data.name}),item.attachment&&(item.fileName=item.attachment.split("/").pop()),item})})}$scope.projectNames=[],$scope.selectedEnquiries=[];$scope.showLoader=!0,$scope.currentPage=1,$scope.maxSize=10,$scope.$on("MTOData",function(event,MTO){MTO&&($scope.showLoader=!0,loadMTOList(MTO))}),$scope.setPage=function(pageNo){$scope.currentPage=pageNo,loadMTOList({page_size:10,page:pageNo})},$scope.addMTO=function(){$state.go("buyerDashboard.MTO.add")},ProjectService.getMainProjects().then(function(data){$scope.projectsInfo=data.data,$scope.projectsInfo.forEach(function(item){$scope.projectNames.push({id:item.id,label:item.name})}),$scope.projectNames=_.uniqBy($scope.projectNames,"id"),MTOGroupService.get().then(function(data){$scope.count=data.data.count,$scope.mtoList=data.data.results,$scope.showLoader=!1,$scope.mtoList=$scope.mtoList.map(function(item){var date=new Date(item.created);return item.dateFormate=date.toLocaleDateString(),item.project&&ProjectService.getOne(item.project).then(function(data){item.projectName=data.data.name}),item.attachment&&(item.fileName=item.attachment.split("/").pop()),item})})}),$scope.selectedValue=function(data,index,value){console.log(value),value?$scope.selectedEnquiries.push(data):$scope.selectedEnquiries.map(function(item,index){item.id===data.id&&($scope.selectedEnquiries.splice(index,1),$scope.selectedEnquiries.length-1)})},$scope.viewMTOItems=function(ev,data){var items;MTOService.get({groupId:data.id}).then(function(data){return items=data.data.results,$mdDialog.show({controller:"layout.standard.viewMTOData",templateUrl:"assets/js/modules/manage-enquiry/view-mto-data.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{items:items,disableSave:!0,showmtoList:!0,visible:!0}}})}).then(function(res){res&&res["delete"]&&$timeout(function(){$window.location.reload()},2250)},function(){})},$scope.deleteMTO=function(data,$index){var enquiry=!1;if(0===data.length)return void Notification.error({message:"Please select atleast one item to Delete",positionX:"right",positionY:"top"});if(data.length>1)return void Notification.error({message:"Please select one item to Delete",positionX:"right",positionY:"top"});var groupId=data[0].id;MTOService.get({groupId:data[0].id}).then(function(data){var results=data.data.results;if(results.length){if(results.forEach(function(item){item.enquiry&&(enquiry=!0)}),enquiry)return void Notification.error({message:"Already part of an enquiry cannot delete",positionX:"right",positionY:"top"});results.forEach(function(item){MTOService["delete"](item.id).then(function(data){console.log("deleted each record")}),MTOGroupService["delete"](groupId).then(function(res){Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}),$scope.selectedEnquiries=[],loadMTOList({page_size:10,page:1})})})}else MTOGroupService["delete"](groupId).then(function(res){Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}),$scope.selectedEnquiries=[],loadMTOList({page_size:10,page:1})})})}}])}();