"use strict";!function(){angular.module("app").controller("layout.order.GRNItemsController",["$scope","$window","$modal","$log","$state","Notification","$http","s3Service","POService","$dialogScope","dateService","$stateParams","$mdDialog","$q",function($scope,$window,$modal,$log,$state,Notification,$http,s3Service,POService,$dialogScope,dateService,$stateParams,$mdDialog,$q){function LoadPOColumns(){$scope.uiGridOptions.columnDefs=[],$scope.uiGridOptions.columnDefs=[{name:"checked",displayName:"",cellTemplate:'<input type="checkbox" ng-model="row.entity.checked">'},{name:"displayId",displayName:"#",width:75,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,visible:$scope.showNext},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,visible:$scope.showNext},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,visible:$scope.showNext},{field:"quantity",displayName:"Quantity",width:100,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"unit_measure",displayName:"Unit Of Measure",width:100,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"unit_price",displayName:"Unit Price",width:100,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"vat",displayName:"VAT",width:65,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"total_price",displayName:"Total Price",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"delivery_date",displayName:"Delivery Date",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"other_charges",displayName:"Other Charges",width:70,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"deliver_basis",displayName:"Delivery Basis",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"delivery_date",displayName:"Delivery Date",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"batch",displayName:"Batch",width:65,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave},{field:"serial",displayName:"Serial",width:65,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave},{field:"production_date",displayName:"Production Date",width:70,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave},{field:"expiry_date",displayName:"Expiry Date",width:125,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave},{field:"delivery_date",displayName:"Delivery Date",width:70,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave},{field:"yard_receipt_date",displayName:"Yard Receipt Date",width:125,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showsave}]}function LoadGRNColumns(){$scope.uiGridOptions.columnDefs=[],$scope.uiGridOptions.columnDefs=[{name:"checked",displayName:"",cellTemplate:'<input type="checkbox" ng-model="row.entity.checked">',width:50},{name:"displayId",displayName:"#",width:75,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"quantity",displayName:"Quantity",width:100,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"received",displayName:"Received",width:100,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!0},{field:"manufacturer",displayName:"Manufacturer",width:100,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"unit_measure",displayName:"Unit Of Measure",width:100,pinnedLeft:!0,enableCellEdit:!1},{field:"batch",displayName:"Batch",width:100,pinnedLeft:!0,enableCellEdit:!0},{field:"serial",displayName:"Serial",width:100,pinnedLeft:!0,enableCellEdit:!0},{field:"production_date",displayName:"Production Date",width:125,pinnedLeft:!0,enableCellEdit:!0},{field:"expiry_date",displayName:"Expiry Date",width:100,pinnedLeft:!0,enableCellEdit:!0},{field:"delivery_date",displayName:"Delivery Date",width:125,pinnedLeft:!0,enableCellEdit:!0},{field:"yard_receipt_date",displayName:"Yard Receipt Date",width:125,pinnedLeft:!0,enableCellEdit:!0}]}function getRowId(row){return row.id}$scope.showNext=!1,$scope.showsave=!1,$scope.checked=!1,$scope.showEdit=!1,$scope.disableSave=!1;var filterItems=[];$scope.grn=$dialogScope.grn,$scope.uiGridOptions={enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,rowIdentity:getRowId,getRowIdentity:getRowId,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},"create"==$dialogScope.type&&($dialogScope.items.map(function(item){item.quantity_received?item.quantity=item.selected_quantity-item.quantity_received:item.quantity=item.selected_quantity,item.checked=!1,item.displayId=item.item_number.split("-").pop().split("_").pop(),filterItems.push(item)}),$scope.showNext=!0,$scope.items=filterItems,LoadPOColumns(),$scope.uiGridOptions.data=_.sortBy(filterItems,"id")),"edit"==$dialogScope.type&&($dialogScope.items.map(function(item){item.quantity=item.selected_quantity,item.checked=!1,filterItems.push(item)}),$scope.showEdit=!0,$scope.items=filterItems,LoadGRNColumns(),$scope.uiGridOptions.data=filterItems),$scope.deleteData=function(){var data=$scope.uiGridOptions.data,arr1=[],arr2=[];return data.map(function(item){item.checked?arr1.push(item):arr2.push(item)}),arr1.length?($scope.uiGridOptions.data=[],void($scope.uiGridOptions.data=arr2)):void Notification.error({message:"please select items to delete",positionX:"right",positionY:"top"})},$scope.selectAll=function(value){value?$scope.items=$scope.items.map(function(item){return item.checked=!1,item}):$scope.items=$scope.items.map(function(item){return item.checked=!0,item})},$scope.next=function(){var data=[];return $scope.items.map(function(item){item.checked&&data.push(item)}),data.length?($scope.uiGridOptions.data=_.sortBy(data,"id"),$scope.showNext=!1,$scope.showsave=!0,$scope.gridApi.grid.refresh(),LoadGRNColumns(),void 0):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})},$scope.save=function(){$scope.disableSave=!0;var data=$scope.uiGridOptions.data,error=!1;data=data.map(function(item){if(!error)return item.received?item.yard_receipt_date?(item.grn=$dialogScope.grn.id,item.po_item=item.id,item.quantity_received=item.received,item.company=$dialogScope.company,item):(Notification.error({message:"please enter yard receipt date",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1)):(Notification.error({message:"please enter received quantity",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1))}),error||POService.postGRNItem(data).then(function(res){$scope.disableSave=!1,Notification.success({message:"successfully saved",positionX:"right",positionY:"top"}),$mdDialog.hide($scope.grn)},function(err){$scope.disableSave=!1})},$scope.cancel=function(){$mdDialog.cancel()},$scope.updateDetails=function(ev){var data=[];return $scope.uiGridOptions.data.map(function(item){item.checked&&data.push(item)}),data.length?$mdDialog.show({controller:"layout.order.updateGRNItems",templateUrl:"assets/js/modules/po/GRN/update-grn-details/update-grn-details.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{display:"grn",type:"create",delivery_date:dateService.convertDateToJS($scope.grn.delivery_date),yard_receipt_date:dateService.convertDateToJS($scope.grn.receipt_date)}}}).then(function(res){$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){return item.checked&&(res&&res.quantity_received&&(item.received=res.quantity_received),res&&res.manufacturer&&(item.manufacturer=res.manufacturer),res&&res.batch&&(item.batch=res.batch),res&&res.serial&&(item.serial=res.serial),res&&res.production_date&&(item.production_date=res.production_date),res&&res.expiry_date&&(item.expiry_date=res.expiry_date),res&&res.delivery_date&&(item.delivery_date=res.delivery_date),res&&res.yard_receipt_date&&(item.yard_receipt_date=res.yard_receipt_date)),item})}):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})}}]).controller("layout.order.updateGRNItems",["$scope","$window","$modal","MessageService","$state","dateService","$http","ProjectService","POService","$dialogScope","$stateParams","$mdDialog","$q",function($scope,$window,$modal,MessageService,$state,dateService,$http,ProjectService,POService,$dialogScope,$stateParams,$mdDialog,$q){$scope.display=$dialogScope.display,$scope.type=$dialogScope.type,$scope.data={},$dialogScope.delivery_date&&($scope.data.delivery_date=$dialogScope.delivery_date),$dialogScope.yard_receipt_date&&($scope.data.yard_receipt_date=$dialogScope.yard_receipt_date),"project"==$dialogScope.display&&ProjectService.getProjectStatus().then(function(item){$scope.statusList=item.data.results}),"supplierProject"==$dialogScope.display&&ProjectService.getProjectStatus().then(function(item){$scope.projectStatus=item.data.results}),"enquiry"==$dialogScope.display&&MessageService.getEnquiryStates().then(function(res){$scope.statusList=res.data.results,$scope.statusList=_.sortBy($scope.statusList,"id")}),$scope.cancel=function(){$mdDialog.cancel()},POService.getIMINStatus().then(function(res){$scope.status=res.data.results}),POService.getPaymentStatus().then(function(res){$scope.prStatus=res.data.results}),$scope.reverse=!1,"reverse"==$dialogScope.type?($scope.reverse=!0,$scope.title="Quantity Reversed"):$scope.title="Quantity Received",$scope.viewPaymentReceipt=function(data,ev){$mdDialog.show({controller:"layout.standard.paymentReceiptController",templateUrl:"assets/js/modules/invoice/payment-receipt-details/payment-receipt-details.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{customer:$dialogScope.customer,order:$dialogScope.order,company:$dialogScope.company,invoiceStatus:!1}}})},$scope.save=function(data){data&&("reverse"==$dialogScope.type&&(data.quantity_received=-Math.abs(data.quantity_received)),data&&data.imin_status&&(data.imin_status=data.imin_status),data&&data.inspected_remarks&&(data.inspected_remarks=data.inspected_remarks),data&&data.production_date&&(data.production_date=dateService.convertDateToPython(data.production_date)),data&&data.expiry_date&&(data.expiry_date=dateService.convertDateToPython(data.expiry_date)),data&&data.delivery_date&&(data.delivery_date=dateService.convertDateToPython(data.delivery_date)),data&&data.yard_receipt_date&&(data.yard_receipt_date=dateService.convertDateToPython(data.yard_receipt_date)),data&&data.payment_due_date&&(data.payment_due_date=dateService.convertDateToPython(data.payment_due_date)),data&&data.invoiced_quantity&&(data.invoiced_quantity=data.invoiced_quantity),data&&data.invoice_item_quantity&&(data.invoice_item_quantity=data.invoice_item_quantity),data&&data.invoice_item_remark&&(data.invoice_item_remark=data.invoice_item_remark),data&&data.packing_dimenssion&&(data.packing_dimenssion=data.packing_dimenssion),data&&data.packing_packing&&(data.packing_packing=data.packing_packing),data&&data.packing_net_weight&&(data.packing_net_weight=data.packing_net_weight),data&&data.packing_gross_weight&&(data.packing_gross_weight=data.packing_gross_weight),data&&data.packing_remarks&&(data.packing_remarks=data.packing_remarks),$mdDialog.hide(data))}}])}();