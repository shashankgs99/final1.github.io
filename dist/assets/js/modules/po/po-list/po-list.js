"use strict";!function(){var app=angular.module("app");app.controller("po.list",["$scope","$window","$log","$state","$http","$mdDialog","POService","ProjectService","BuyerSupplierService","Notification","$stateParams","$q",function($scope,$log,$window,$state,$http,$mdDialog,POService,ProjectService,BuyerSupplierService,Notification,$stateParams,$q){function NumInWords(number){for(var first=["","one ","two ","three ","four ","five ","six ","seven ","eight ","nine ","ten ","eleven ","twelve ","thirteen ","fourteen ","fifteen ","sixteen ","seventeen ","eighteen ","nineteen "],tens=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],mad=["","thousand","million","billion","trillion"],word="",i=0;i<mad.length;i++){var tempNumber=number%(100*Math.pow(1e3,i));0!==Math.floor(tempNumber/Math.pow(1e3,i))&&(word=Math.floor(tempNumber/Math.pow(1e3,i))<20?first[Math.floor(tempNumber/Math.pow(1e3,i))]+mad[i]+" "+word:tens[Math.floor(tempNumber/(10*Math.pow(1e3,i)))]+"-"+first[Math.floor(tempNumber/Math.pow(1e3,i))%10]+mad[i]+" "+word),tempNumber=number%Math.pow(1e3,i+1),0!==Math.floor(tempNumber/(100*Math.pow(1e3,i)))&&(word=first[Math.floor(tempNumber/(100*Math.pow(1e3,i)))]+"hunderd "+word)}return word}function loadPOList(data){$scope.current_user.data&&$scope.current_user.data.company&&$state.current.name.includes("buyerDashboard")&&(data.buyer_company_id=$scope.current_user.data.company.id),$scope.current_user.data&&$state.current.name.includes("supplierDashboard")&&(data.supplier_email=$scope.current_user.data.email),POService.get(data).then(function(data){$scope.showLoader=!1,$scope.count=data.data.count,$scope.poList=data.data.results,$scope.poList=$scope.poList.map(function(item){return item.sub_project&&(item.subProjectName=item.sub_project.name),item.project&&(item.projectName=item.project.name),item.po_type&&(item.poType=item.po_type.name),item.selected=!1,item})})}function OpenTemplate(data){var content=window.open("","newWindow","width=1200,height=800");content.document.body.innerHTML=data}loadPOList({page_size:10,page:1}),$scope.projectNames=[],$scope.PoName=[],$scope.selectedOffers=[],$scope.currentPage=1,$scope.maxSize=10,$scope.supplierAcess=!1,$scope.showLoader=!0;$scope.$on("POFilters",function(event,data){data&&($scope.showLoader=!0,loadPOList(data))}),POService.getPOType().then(function(types){$scope.poTypes=types.data.results}),$scope.createOrder=function(){$state.go("buyerDashboard.order.create-order")},$state.current.name.includes("supplierDashboard")&&($scope.supplierAcess=!0),$scope.setPage=function(pageNo){$scope.currentPage=pageNo,loadPOList({page_size:10,page:pageNo})},$scope.selectedValue=function(data,index,value){value?$scope.selectedOffers.push(data):$scope.selectedOffers.splice(index,1)},$scope.EditOrder=function(data){return data.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):data.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):void $state.go("buyerDashboard.order.editOrder",{orderId:data[0].id})},$scope.SendEmail=function(ev,data){return data.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):data.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):$mdDialog.show({controller:"layout.standard.sendPO",templateUrl:"assets/js/modules/po/po-email/po-email.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{data:data[0],userData:$scope.current_user.data}}}).then(function(res){})},$scope.PrintOrder=function(info){if(info.length>1)return void Notification.error({message:"please select one item",positionX:"right",positionY:"top"});if(info.length<1)return void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"});var data=info[0],reference=data.po_reference.slice(0,200)+" .......",poData={buyer_company:data.buyer_company,buyer_logo:$scope.current_user.data.company.logo,buyer_address:{addressline1:$scope.current_user.data.company.addresses[0].addressline1,addressline2:$scope.current_user.data.company.addresses[0].addressline2,cityname:$scope.current_user.data.company.addresses[0].cityname,state:$scope.current_user.data.company.addresses[0].state,country:$scope.current_user.data.company.addresses[0].country},po_number:data.po_number,po_date:data.po_date,buyer_contact_name:data.buyer_contact_name,buyer_contact_mobile:data.buyer_contact_mobile,buyer_contact_email:data.buyer_contact_email,created:data.created,supplier_name:data.supplier_name,supplier_address:{addressline1:data.supplier_address.addressline1,addressline2:data.supplier_address.addressline2,cityname:data.supplier_address.cityname,state:data.supplier_address.state,country:data.supplier_address.country},po_reference:reference,supplier_contact_name:data.supplier_contact_name,supplier_contact_mobile:data.supplier_contact_mobile,supplier_contact_email:data.supplier_contact_email,projectName:data.projectName,subProjectName:data.subProjectName,authorized_by:data.authorized_by,lc:data.lc,currency:data.currency,delivery_date:data.delivery_date,price_words:data.price_words,ack_supplier:data.ack_supplier,accepted_by_supplier:data.accepted_by_supplier,received_by_supplier:data.received_by_supplier};data.price_number&&(poData.price_number=data.price_number.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")),data.price_basis&&(poData.price_basis=data.price_basis.slice(0,50)+"......."),data.delivery_basis&&(poData.delivery_basis=data.delivery_basis.slice(0,50)+"......."),data.po_description&&(poData.po_description=data.po_description.slice(0,200)+"......"),data.enquiry&&data.enquiry.enquiry_number&&(poData.enquiry_number=data.enquiry.enquiry_number),POService.getPOItems({poId:data.id}).then(function(item){var results=item.data.results;poData.items=results,data&&data.enquiry&&(poData.enquiry_number=data.enquiry.enquiry_number),$q.all([POService.getPOItems({poId:data.id}),POService.getReferences({poId:data.id}),POService.getScopeOfWork({poId:data.id}),POService.getPriceBasis({poId:data.id}),POService.getPaymentTerms({poId:data.id}),POService.getLiquidatedDamages({poId:data.id}),POService.getDeliveryTerms({poId:data.id}),POService.getShippingAddress({poId:data.id}),POService.getBankGuarantee({poId:data.id}),POService.getGeneralTNC({poId:data.id})]).then(function(result){if(result[0].data.results.length){var ItemsCount=result[0].data.count;poData.totalItems=JSON.parse(ItemsCount);var results=result[0].data.results;poData.items=results;var totalTax,totalVat,totalCharges;if(poData.items.map(function(item){item.s_no=item.item_number.split("-").pop().split("_").pop();var total=null;item.cgst>0&&(total=item.cgst,totalTax?totalTax+=parseFloat(item.cgst):totalTax=parseFloat(item.cgst)),item.sgst>0&&!total&&(total=item.sgst,totalTax?totalTax+=parseFloat(item.sgst):totalTax=parseFloat(item.sgst)),item.igst>0&&!total&&(total=item.igst,totalTax?totalTax+=parseFloat(item.igst):totalTax=parseFloat(item.igst)),item.vat>0&&!total&&(total=item.vat,totalVat?totalVat+=parseFloat(item.vat):totalVat=parseFloat(item.vat)),item.other_charges&&(totalCharges?totalCharges+=parseFloat(item.other_charges):totalCharges=parseFloat(item.other_charges))}),totalTax){poData.totalTax=totalTax;var totalTaxValue=(data.price_number*(totalTax/100)).toFixed(2);poData.totalTaxValue=totalTaxValue,poData.totalAmount=(parseFloat(data.price_number)+parseFloat(totalTaxValue)).toFixed(2)}if(totalVat){poData.totalVat=totalVat;var totalVatValue=(data.price_number*(totalVat/100)).toFixed(2);poData.totalVatValue=totalVatValue,poData.totalAmount=(parseFloat(data.price_number)+parseFloat(totalVatValue)).toFixed(2)}if(totalCharges){poData.totalCharges=totalCharges;var totalChargesAmount=(data.price_number*(totalCharges/100)).toFixed(2);poData.totalAmount=(parseFloat(poData.totalAmount)+parseFloat(totalChargesAmount)).toFixed(2),poData.totalChargesAmount=totalChargesAmount}poData.totalAmount||(poData.totalAmount=data.price_number),poData.totalAmount&&(poData.totalPriceInWords=NumInWords(parseInt(poData.totalAmount))),poData.totalAmount=poData.totalAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}if(result[1].data.results.length){var refData=result[1].data.results;refData.length&&(poData.referenceHeading=refData[0].heading,poData.referenceDescription=refData[0].description)}if(result[2].data.results.length){var scopeOfWork=result[2].data.results;scopeOfWork.length&&(poData.sowHeading=scopeOfWork[0].heading,poData.sowDescription=scopeOfWork[0].description)}if(result[3].data.results.length){var priceBasisInfo=result[3].data.results;priceBasisInfo.length&&(poData.priceBasisHeading=priceBasisInfo[0].heading,poData.priceBasisDescription=priceBasisInfo[0].description)}if(result[4].data.results.length){var paymentTermsInfo=result[4].data.results;paymentTermsInfo.length&&(poData.ptmsHeading=paymentTermsInfo[0].heading,poData.ptmsDescription=paymentTermsInfo[0].description)}if(result[5].data.results.length){var liquidateDamage=result[5].data.results;liquidateDamage.length&&(poData.ldssHeading=liquidateDamage[0].heading,poData.ldsDescription=liquidateDamage[0].description)}if(result[6].data.results.length){var deliveryInfo=result[6].data.results;deliveryInfo.length&&(poData.deliveryHeading=deliveryInfo[0].heading,poData.deliveryDescription=deliveryInfo[0].description)}if(result[7].data.results.length){var shippingInfo=result[7].data.results;shippingInfo.length&&(poData.shippingHeading=shippingInfo[0].heading)}if(result[8].data.results.length){var bankInfo=result[8].data.results;bankInfo.length&&(poData.bankHeading=bankInfo[0].heading,poData.bankDescription=bankInfo[0].description)}if(result[9].data.results.length){var gtcs=result[9].data.results;gtcs.length&&(poData.gtcsHeading=gtcs[0].heading,poData.gtcsDescription=gtcs[0].description)}var body={poData:poData};$http.post("/backend/print-po/",body).then(function(response){$scope.tempalte=response.data,OpenTemplate($scope.tempalte),Notification.success({message:"Successfully Printed",positionX:"right",positionY:"top"})})["catch"](function(error){Notification.error({message:"Not Successfully Printed",positionX:"right",positionY:"top"})})})})},$scope.ViewOrder=function(data){$state.go("buyerDashboard.order.view",{orderId:data.id})},$scope.deletePO=function(data){if(0===data.length)return void Notification.error({message:"Please select atleast one item to Delete",positionX:"right",positionY:"top"});var list=[];data.map(function(item){POService.update(item.id,{is_deleted:!0}).then(function(res){list.push(res.data),list.length===data.length&&(Notification.error({message:"successfully deleted",positionX:"right",positionY:"top"}),loadPOList({page_size:10,page:1}),$scope.selectedOffers=[])})})}}])}();