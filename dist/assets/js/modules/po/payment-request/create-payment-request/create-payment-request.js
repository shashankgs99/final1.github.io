"use strict";!function(){angular.module("app").controller("layout.order.paymentRequestController",["$scope","$window","CompanyService","$log","$state","Notification","$http","dateService","POService","$dialogScope","$rootScope","$stateParams","$mdDialog","$q",function($scope,$window,CompanyService,$log,$state,Notification,$http,dateService,POService,$dialogScope,$rootScope,$stateParams,$mdDialog,$q){$scope.pr={},$scope.open=$dialogScope.open,$scope.title="Generate Payment Request",$scope.installments=$dialogScope.installments,$scope.showSave=!0,$scope.showNext=!1,$scope.save=function(data){return data.milestone_number?data.milestoneDate?(data.po=$dialogScope.order,data.documentDate&&(data.document_date=dateService.convertDateToPython(data.documentDate)),data.milestoneDate&&(data.milestone_date=dateService.convertDateToPython(data.milestoneDate)),data.receiptDate&&(data.receipt_date=dateService.convertDateToPython(data.receiptDate)),void POService.postPaymentRequest(data).then(function(res){Notification.success({message:"sucessfully saved",positionX:"right",positionY:"top"}),$mdDialog.hide(res.data)})):void Notification.error({message:"please select Milestone Date",positionX:"right",positionY:"top"}):void Notification.error({message:"please select Milestone Number",positionX:"right",positionY:"top"})},$scope.cancel=function(){$mdDialog.cancel()}}]).controller("layout.order.paymentRequestItemController",["$scope","$window","CompanyService","$log","$state","Notification","$http","dateService","POService","$dialogScope","$rootScope","$stateParams","$mdDialog","$q",function($scope,$window,CompanyService,$log,$state,Notification,$http,dateService,POService,$dialogScope,$rootScope,$stateParams,$mdDialog,$q){function getRowId(row){return row.id}function loadColumns(){$scope.uiGridOptions.columnDefs=[],$scope.uiGridOptions.columnDefs=[{name:"checked",displayName:"",width:50,cellTemplate:'<input type="checkbox" ng-model="row.entity.checked">'},{name:"displayId",displayName:"#",width:75,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"selected_quantity",displayName:"Quantity",width:100,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"unit_measure",displayName:"Unit Of Measure",width:100,pinnedLeft:!0,enableCellEdit:!1},{field:"vat",displayName:"VAT",width:65,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"delivery_date",displayName:"Delivery Date",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showNext},{field:"invoiced_quantity",displayName:"Quantity Invoiced",width:150,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showSave},{field:"invoice_value",displayName:"Invoice Value",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showSave},{field:"payment_due_date",displayName:"Payment Due Date",width:150,pinnedLeft:!0,enableCellEdit:!0,visible:$scope.showSave}]}$scope.open=$dialogScope.open,$scope.pr={checked:!1},$scope.showNext=!0,$scope.showSave=!1,$scope.payment=$dialogScope.payment,$scope.title="Payment Request # "+$scope.payment.internal_reference_number+" Dated "+$scope.payment.document_date;var filterItems=[];$dialogScope.items.map(function(item){item.checked=!1;var data=item.item_number.split("-").pop();if(item.displayId=data.split("_").pop(),item.po_item_installment_quantity.length){var result=_.groupBy(item.po_item_installment_quantity,"installment");for(var key in result){var total=0;if($scope.payment.milestone_number==key){var records=result[key];records.map(function(installment){total?total+=Number(installment.invoiced_quantity):total=Number(installment.invoiced_quantity)})}}item.selected_quantity>total&&(item.selected_quantity=Number(item.selected_quantity)-Number(total),filterItems.push(item))}else filterItems.push(item)}),$dialogScope.items=filterItems,CompanyService.getCurrencyType().then(function(data){$scope.currencyTypeList=data.data.results,$scope.currencyTypeList.map(function(item){item.currency_type_name==$dialogScope.currency&&($scope.currency=item.id)})},function(err){console.log(err)}),$scope.uiGridOptions={enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,rowIdentity:getRowId,getRowIdentity:getRowId,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},loadColumns(),$scope.selectAll=function(value){value?$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){return item.checked=!1,item}):$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){return item.checked=!0,item})},$scope.uiGridOptions.data=$dialogScope.items,POService.getOnePaymentInstallments($dialogScope.payment.milestone_number).then(function(res){$scope.installmentData=res.data}),$scope.next=function(){var data=[];return $scope.uiGridOptions.data.map(function(item){item.checked&&data.push(item)}),data.length?($scope.showNext=!1,$scope.showSave=!0,loadColumns(),$scope.uiGridOptions.data=[],$scope.uiGridOptions.data=data,void 0):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})},$scope.back=function(){$scope.showSave=!1,$scope.showNext=!0,$scope.uiGridOptions.data=[],$scope.uiGridOptions.data=$dialogScope.items,$scope.pr.checked=!1,$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){return item.checked=!1,item})},$scope.updateDetails=function(ev){var data=[];return $scope.uiGridOptions.data.map(function(item){item.checked&&data.push(item)}),data.length?$mdDialog.show({controller:"layout.order.updateGRNItems",templateUrl:"assets/js/modules/po/GRN/update-grn-details/update-grn-details.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{display:"payment-request"}}}).then(function(res){$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){if(item.checked){var value=0;if(res&&res.invoiced_quantity){if(totalTax=0,item.invoiced_quantity=res.invoiced_quantity,item.sgst>0||item.cgst>0){var totalTax;item.sgst>0&&(totalTax=Number(item.sgst)),item.cgst&&(totalTax=totalTax?Number(item.cgst)+Number(totalTax):Number(item.cgst))}if(item.igst>0){var totalTax;item.igst&&(totalTax=Number(item.igst))}if(item.vat>0){var totalTax;item.vat&&(totalTax=Number(item.vat))}var percentage=$scope.installmentData.percentage,totalValue=Number(item.unit_price)*Number(item.invoiced_quantity);if(totalTax>0){item.invoice_value=totalValue*(Number(percentage)/100);var taxvalue=totalValue*(totalTax/100);value=Number(taxvalue)+Number(totalValue),item.invoice_value_with_tax=value*(Number(percentage)/100)}else item.invoice_value=totalValue*(Number(percentage)/100),item.invoice_value_with_tax=totalValue*(Number(percentage)/100)}res&&res.payment_due_date&&(item.payment_due_date=res.payment_due_date)}return item})}):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})},$scope.removeData=function(){var data=[];return $scope.uiGridOptions.data.map(function(item){item.checked&&data.push(item)}),data.length?($scope.uiGridOptions.data=[],void($scope.uiGridOptions.data=data)):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})},$scope.cancel=function(){$mdDialog.cancel()},$scope.save=function(){var arr=[],error=!1,data=$scope.uiGridOptions.data;$scope.uiGridOptions.data.map(function(item){if(!error)return item.invoiced_quantity?item.payment_due_date?item.selected_quantity&&item.invoiced_quantity&&item.invoiced_quantity>Number(item.selected_quantity)?(Notification.error({message:"item-"+item.po_item.title+" invoiced quantity must be lesser than selected quantity",positionX:"right",positionY:"top"}),void(error=!0)):void 0:(Notification.error({message:"please select payment due_date",positionX:"right",positionY:"top"}),void(error=!0)):(Notification.error({message:"please enter invoice quantity",positionX:"right",positionY:"top"}),void(error=!0))}),error||data.map(function(item){var obj={};obj.invoiced_quantity=item.invoiced_quantity,obj.invoice_value_with_tax=parseInt(item.invoice_value_with_tax),obj.cgst=item.cgst,obj.sgst=item.sgst,obj.vat=item.vat,obj.igst=item.igst,obj.invoice_value=item.invoice_value,obj.payment_due_date=item.payment_due_date,obj.currency=$scope.currency,obj.payment_request=$dialogScope.payment.id,obj.po_item=item.id,POService.postPaymentRequestItem(obj).then(function(res){arr.push(res.data),arr.length==data.length&&(Notification.success({message:"successfully saved",positionX:"right",positionY:"top"}),$mdDialog.hide())})})}}])}();