"use strict";!function(){var app=angular.module("app");app.controller("layout.standard.managecompanyController",["$scope","CompanyService","$timeout","$state","s3Service","$window","$stateParams","$filter","UserService","dateService","Notification","$mdDialog","TaxService","BankService","$log",function($scope,CompanyService,$timeout,$state,s3Service,$window,$stateParams,$filter,UserService,dateService,Notification,$mdDialog,TaxService,BankService,$log){function getCompanyDetails(companyId){BankService.get({company:companyId}).then(function(result){result.data.results.length&&($scope.bankData=result.data.results)}),TaxService.get({company:companyId}).then(function(res){$scope.taxData=res.data.results,$scope.taxData=$scope.taxData.map(function(item){return item.tax_type&&$scope.taxTypeList.map(function(tax){item.tax_type===tax.id&&(item.taxType=tax)}),item.valid_date&&(item.validDate=dateService.convertDateToJS(item.valid_date)),item.issue_date&&(item.issueDate=dateService.convertDateToJS(item.issue_date)),item})}),CompanyService.getOne(companyId).then(function(data){if($scope.companyData=data.data,$scope.companyData.countryCode1||($scope.companyData.countryCode1=$scope.current_user.data.country_code),$scope.companyData.phonenumber1||($scope.companyData.phonenumber1=$scope.current_user.data.contact_no),$scope.companyData.emailid1||($scope.companyData.emailid1=$scope.current_user.data.email),$scope.companyData.establishment_type_other?$scope.establishmentType=$scope.companyData.establishment_type_other:$scope.establishmentType=$scope.companyData.establishment_type,$scope.companyData.aboutus_images&&($scope.companyAboutusImages=[],$scope.companyData.aboutus_images.forEach(function(item){var aboutUsImage=item.split("/");$scope.companyAboutusImages.push({name:aboutUsImage.pop(),path:item})})),$scope.companyData.catalogs&&($scope.companycatalogs=[],$scope.companyData.catalogs.forEach(function(item){var catalog=item.split("/");$scope.companycatalogs.push({name:catalog.pop(),path:item})})),$scope.companyData.company_type_other?$scope.companyType=$scope.companyData.company_type_other:$scope.companyType=$scope.companyData.company_type,$scope.companyData.establishment_year&&($scope.companyData.yearOfEstablishment=dateService.convertDateToJS($scope.companyData.establishment_year)),null===$scope.companyData.revenue_currency&&($scope.companyData.revenue_currency="INR"),null===$scope.companyData.profit_currency&&($scope.companyData.profit_currency="INR"),$scope.companyData.is_buyer="true",$scope.companyData.attachments){var splitAttachment=$scope.companyData.attachments.split("/");$scope.attachmentName=splitAttachment.pop()}$scope.companyData.catalogs&&($scope.catalogNames=[],$scope.companyData.catalogs.forEach(function(item){var catalogAttachment=item.split("/");$scope.catalogNames.push({fileName:catalogAttachment.pop(),filePath:item})})),$scope.companyData.role_type?$scope.companyData.role_type=$scope.companyData.role_type.map(function(item){return{id:item,label:$scope.activitiesTwoOptions.filter(function(type){return type.id===item})[0].label}}):$scope.companyData.role_type=[],$scope.companyData.project_company&&$scope.companyData.project_company.length&&($scope.companyData.projects=$scope.companyData.project_company),$scope.companyData.company_testimonials&&$scope.companyData.company_testimonials.length&&($scope.companyData.testimonials=$scope.companyData.company_testimonials),$scope.companyData.customer_company&&$scope.companyData.customer_company.length&&($scope.companyData.customers=$scope.companyData.customer_company)})}function SaveTaxDetails(companyInfo){var arr=[];$scope.taxData.map(function(item){item.company=companyInfo.data.id,angular.isDate(item.validDate)&&(item.valid_date=dateService.convertDateToPython(item.validDate)),angular.isDate(item.issueDate)&&(item.issue_date=dateService.convertDateToPython(item.issueDate)),item&&item.id?TaxService.update(item.id,item).then(function(result){$log.log("updated Tax details")}):arr.push(item)}),arr.length?TaxService.post(arr).then(function(resp){RedirectPage(companyInfo)}):RedirectPage(companyInfo)}function DeleteTaxList(){var arr=[];$scope.deleteTaxData.map(function(item){item.id&&TaxService["delete"](item.id).then(function(resp){arr.push(resp.data),$scope.deleteTaxData.length===arr.length&&$log.log("successfully deleted")},function(error){$log.error(error)})})}function DeleteBankList(){var arr=[];$scope.deleteBankData.map(function(item){item.id&&BankService["delete"](item.id).then(function(resp){arr.push(resp.data),$scope.deleteBankData.length===arr.length&&$log.log("successfully deleted")},function(error){$log.error(error)})})}function SaveBankDetails(data,value){var arr=[],res=[];$scope.bankData.map(function(bank){bank&&bank.id&&"modified"==bank.content?BankService.update(bank.id,bank).then(function(results){res.push(results.data),$scope.bankData.length==res.length&&(value?SaveTaxDetails(data):RedirectPage(data))}):bank.content||bank.id||arr.push(bank),arr.length?BankService.post(arr).then(function(results){value?SaveTaxDetails(data):RedirectPage(data)}):RedirectPage(data)})}function RedirectPage(data){Notification.success({message:"Successfully updated company.",positionX:"right",positionY:"top"}),$state.current.name.includes("adminDashboard")&&$state.go("adminDashboard.company.list"),$state.current.name.includes("supplierDashboard")&&($scope.showload="false",company=$scope.current_user.data.company,company.company_name=data.data.company_name,console.log("Successfully created company"),$state.go($state.$current.parent.name+".view",{companyId:$state.params.companyId})),$state.current.name.includes("buyerDashboard")&&($scope.showload="false",company=$scope.current_user.data.company,company.company_name=data.data.company_name,console.log("Successfully created company"),$state.go($state.$current.parent.name+".view",{companyId:$state.params.companyId}))}var company;$scope.BackToListPageDetails=!1,$scope.countryCode="+91",$scope.deleteTaxData=[],$scope.companyData={role_type:[]},$scope.companycatalogs=[],$scope.taxData=[],$scope.companyAboutusImages=[],$scope.companyAttachments=[],$scope.catalogsInfo=[],$scope.catalogImages=[],$scope.dropdownSettings={scrollableHeight:"200px",scrollable:!0,smartButtonMaxItems:3,smartButtonTextConverter:function(itemText,originalItem){return itemText},showCheckAll:!1,showUncheckAll:!1},$scope.aboutUsInfo=[],$scope.bank={},$scope.bankData=[],$scope.deleteBankData=[],TaxService.getTaxTypes().then(function(data){$scope.taxTypeList=data.data.results}),$scope.removeBankDetails=function(data,$index){$scope.bankData.splice($index,1),$scope.deleteBankData.push(data)},$scope.AddAboutUsImages=function(){var file={};file.remove=!0,$scope.aboutUsInfo.push(file)},$scope.AddCatalogs=function(){var file={};file.remove=!0,$scope.catalogsInfo.push(file)},$scope.getAboutUs=function(){CompanyService.getAboutusText({companyId:$stateParams.supplierId}).then(function(response){$scope.companyData.aboutus_text=response.data})},$scope.uploadAboutUs=function(file,$index){var path="user/"+$scope.current_user.data.id+"/company/companyImages";s3Service.uploadFile(path,file,function(url){url&&($scope.companyAttachments.push(url),$scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}),document.getElementById("company-attachment").value=null)})},$scope.removeAboutUs=function(files,index){files.splice(index,1),$scope.companyImages.splice(index,1)},$scope.uploadCatalogs=function(file,$index){var path="user/"+$scope.current_user.data.id+"/company/companyImages";s3Service.uploadFile(path,file,function(url){url&&($scope.catalogImages.push(url),$scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}),document.getElementById("company-attachment").value=null)})},$scope.removeTaxDetails=function($index,details){$scope.taxData.splice($index,1),$scope.deleteTaxData.push(details)},$scope.uploadTaxUrl=function(file,details){var path="company/"+$scope.companyData.id+"/taxDetails";s3Service.uploadFile(path,file,function(url){details.url=url,Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})})},$scope.removeCatalogs=function(files,index){files.splice(index,1)},$state.current.name.includes("adminDashboard")&&($scope.hideBackToDetails=!0),$scope.removeFile=function(files,index){$scope.companyImagesToUpload.splice(index,1),$scope.companyImages.splice(index,1)},$scope.removeUploadedCatalogs=function(files,index){$scope.companycatalogs.splice(index,1)},CompanyService.get().then(function(data){$scope.companysData=data.data.results},function(err){console.log(err)}),$scope.companyItem&&($scope.adminCompanyId=$scope.companyItem[0][4],getCompanyDetails($scope.companyItem[0][4])),$scope.customButtonText={buttonDefaultText:"Select all applicable"},CompanyService.getCurrencyType().then(function(data){$scope.currencyTypeList=data.data.results},function(err){console.log(err)}),$scope.previewCompany=function(){var companyName=$scope.companyData.company_name;return companyName=companyName.replace(/ +/g,"-"),$state.href("layout.standard.companyIntro.intro",{companyId:$scope.companyData.id,companyName:companyName,description:$scope.companyData.aboutus_text})},$scope.removeImage=function(files,index){$scope.companyAboutusImages.splice(index,1)},$stateParams.supplierId&&getCompanyDetails($stateParams.supplierId),UserService.getRoleTypes().then(function(roledata){roledata.data.count>0&&($scope.activitiesTwoOptions=roledata.data.results.map(function(item){return{id:item.id,label:item.role_type_name}})),$stateParams.companyId?CompanyService.getOne($stateParams.companyId).then(function(supp){company=supp.data,supp.data.company&&getCompanyDetails(supp.data.company)}):$scope.current_user.data.company&&$scope.current_user.data.company.company_name&&$state.current.name.includes("supplierDashboard")?getCompanyDetails($scope.current_user.data.company.id):$scope.current_user.data.company&&!$scope.current_user.data.company.company_name&&$state.current.name.includes("supplierDashboard")?$scope.companyData.company_name=$scope.current_user.data.company.company_name:$scope.current_user.data.company&&$state.current.name.includes("buyerDashboard")&&getCompanyDetails($scope.current_user.data.company.id)}),$scope.tinymceOptions={plugins:"link image code media table paste",toolbar:"undo redo | bold italic | alignleft aligncenter alignright | code"},tinymce.init({selector:"#companytext",height:500,menubar:!0,plugins:["advlist autolink lists link image charmap print preview anchor textcolor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste code help wordcount"],toolbar:"insert | undo redo |  formatselect | bold italic backcolor  | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help",content_css:["//fonts.googleapis.com/css?family=Lato:300,300i,400,400i","//www.tinymce.com/css/codepen.min.css"]}),$scope.FileUpload=function(file,type){var path="user/"+$scope.current_user.data.id+"/company/"+type;s3Service.uploadFile(path,file,function(url){console.log("Uploaded file successfully"),"logo"===type?$scope.companyData.logo=url:$scope.companyData.attachments=url,Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})},function(error){errorCallback(error)})},$scope.addAddress=function(){var addresses={};$scope.companyData.addresses||($scope.companyData.addresses=[]),$scope.companyData.addresses.push(addresses)},$scope.addContact=function(ev){$mdDialog.show({controller:"customer.contacts",templateUrl:"assets/js/modules/customer/create-customer/customer-contact.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{type:"Add"}}}).then(function(res){res&&($scope.companyData.contact||($scope.companyData.contact=[]),$scope.companyData.contact.push(res))})},$scope.EditContact=function(ev,data,$index){$mdDialog.show({controller:"customer.contacts",templateUrl:"assets/js/modules/customer/create-customer/customer-contact.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{contactsData:data,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){res&&("Edit"==res.type?$scope.companyData.contact[$index]=res:$scope.companyData.contact[$index]=res)})},$scope.CreateAddress=function(ev){$mdDialog.show({controller:"customer.addresses",templateUrl:"assets/js/modules/customer/add-address/customer-address.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add"}}}).then(function(res){res&&Object.keys(res).length&&($scope.companyData.addresses||($scope.companyData.addresses=[]),$scope.companyData.addresses.push(res))})},$scope.OpenDialog=function(ev,source){$mdDialog.show({controller:"company.CustomerController",templateUrl:"assets/js/modules/company/company-customer/company-customer.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add",source:source,userData:$scope.current_user.data}}}).then(function(res){res&&(Object.keys(res).length&&"Add"==res.type&&"customer"==source&&($scope.companyData.customers||($scope.companyData.customers=[]),$scope.companyData.customers.push(res)),Object.keys(res).length&&"Add"==res.type&&"project"==source&&($scope.companyData.projects||($scope.companyData.projects=[]),$scope.companyData.projects.push(res)),Object.keys(res).length&&"Add"==res.type&&"testimonial"==source&&($scope.companyData.testimonials||($scope.companyData.testimonials=[]),$scope.companyData.testimonials.push(res)))})},$scope.EditDialog=function(ev,data,$index,source){$mdDialog.show({controller:"company.CustomerController",templateUrl:"assets/js/modules/company/company-customer/company-customer.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Edit",source:source,userData:$scope.current_user.data,customerData:angular.copy(data)}}}).then(function(res){res&&("customer"==source?"Edit"==res.type&&res&&res.id?$scope.companyData.customers=$scope.companyData.customers.map(function(item){return item.id==res.id&&(item=res),item}):$scope.companyData.customers[$index]=res:"project"==source?"Edit"==res.type&&res&&res.id?$scope.companyData.projects=$scope.companyData.projects.map(function(item){return item.id==res.id&&(item=res),item}):$scope.companyData.projects[$index]=res:"testimonial"==source&&("Edit"==res.type&&res&&res.id?$scope.companyData.testimonials=$scope.companyData.testimonials.map(function(item){return item.id==res.id&&(item=res),item}):$scope.companyData.testimonials[$index]=res))})},$scope.deleteCustomer=function(index){$scope.companyData.customers.splice(index,1)},$scope.deleteProject=function(index){$scope.companyData.projects.splice(index,1)},$scope.deleteTestimonials=function(index){$scope.companyData.testimonials.splice(index,1)},$scope.EditAddress=function(ev,data,$index){$mdDialog.show({controller:"customer.addresses",templateUrl:"assets/js/modules/customer/add-address/customer-address.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{addressInfo:data,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){res&&("Edit"==res.type?$scope.companyData.addresses=$scope.companyData.addresses.map(function(item){return item.id==res.id&&(item=res),item}):$scope.companyData.addresses[$index]=res)})},$scope.deleteAddress=function(index){$scope.companyData.addresses.splice(index,1)},$scope.deleteContacts=function(index){$scope.companyData.contact.splice(index,1)},$scope.saveCompanyInfo=function(data){if($scope.disabled=!0,$scope.showload="false",data.aboutus_images=[],$scope.taxData.length){var error;$scope.taxData.map(function(tax){if(!error)return tax.taxType?tax.number?void 0:(Notification.success({message:"please enter number in tax details",positionX:"right",positionY:"top"}),void(error=!0)):(Notification.success({message:"please select tax type in tax details",positionX:"right",positionY:"top"}),void(error=!0))})}$scope.companyData.addresses||($scope.companyData.addresses=[]),angular.isDate($scope.companyData.yearOfEstablishment)?data.establishment_year=dateService.convertDateToPython($scope.companyData.yearOfEstablishment):data.establishment_year=null,data.role_type&&data.role_type.length&&(data.role_type=data.role_type.map(function(item){return item.id})),data.revenue||(data.revenue="0"),data.profit||(data.profit="0"),data.catalogs||(data.catalogs=[]),data.customers&&data.customers.length&&(data.customers=data.customers.map(function(item){return item&&item.id&&delete item.id,item.customer_company=data.id,item})),data.projects&&data.projects.length&&(data.projects=data.projects.map(function(item){return item&&item.id&&delete item.id,item.company=data.id,item})),data.testimonials&&data.testimonials.length&&(data.testimonials=data.testimonials.map(function(item){return item&&item.id&&delete item.id,item.company=data.id,item})),$scope.companyAttachments.length&&(data.aboutus_images=$scope.companyAttachments),$scope.companyAboutusImages&&($scope.companyAboutusImages=$scope.companyAboutusImages.map(function(image){return image.path}),data.aboutus_images.length?data.aboutus_images=data.aboutus_images.concat($scope.companyAboutusImages):data.aboutus_images=$scope.companyAboutusImages),$scope.catalogImages.length&&(data.catalogs=$scope.catalogImages),$scope.companycatalogs&&($scope.companycatalogs=$scope.companycatalogs.map(function(item){return item.path}),data.catalogs.length?data.catalogs=data.catalogs.concat($scope.companycatalogs):data.catalogs=$scope.companycatalogs),data.id?CompanyService.update(data.id,data).then(function(data){$scope.success=!0;var tax;console.log("data saved"),$scope.deleteTaxData.length&&DeleteTaxList(),$scope.deleteBankData.length&&DeleteBankList(),$scope.taxData.length||$scope.bankData.length?($scope.taxData.length&&(tax=!0),$scope.bankData.length?SaveBankDetails(data,tax):SaveTaxDetails(data)):RedirectPage(data)},function(err){$scope.disabled=!1,$scope.error=err.data,Notification.error({message:err.data,positionX:"right",positionY:"top"}),console.log(err)}):(data.contact=[],$state.current.name.includes("adminDashboard")?CompanyService.post(data).then(function(company){$scope.success=!0,$scope.showload="false",Notification.success({message:"SuccessFully Created Company",positionX:"right",positionY:"top"}),$timeout(function(){$window.location.reload()},1200),$state.go("adminDashboard.company.list"),$scope.show.edit=!0,$scope.editOne=!1},function(error){$scope.disabled=!1,$scope.showload="false",Notification.error({message:error,positionX:"right",positionY:"top"}),console.log("error occured: "+error)}):CompanyService.post(data).then(function(company){$scope.success=!0,$scope.showload="false",Notification.success({message:"Created company. Please login.",positionX:"right",positionY:"top"}),console.log("Created company"),UserService.update($scope.current_user.data.id,{company:company.data.company_name}).then(function(){$timeout(function(){$state.go($state.$current.parent.name+".view",{companyId:company.data.id})},1200)})},function(error){$scope.disabled=!1,$scope.showload="false",Notification.error({message:error,positionX:"right",positionY:"top"}),console.log("error occured: "+error)}))},$scope.editDetails=function(){$state.current.name.includes("adminDashboard")?$state.go($state.$current.parent.name+".edit",{supplierId:$state.params.supplierId}):$state.go($state.$current.parent.name+".edit",{companyId:$state.params.companyId})},$scope.backToDetails=function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.company.list"):$state.go($state.$current.parent.name+".view",{companyId:$state.params.companyId})},$scope.establishmentTypeOther=!0,$scope.establishmentTypeClicked=function(establishment_type){"Other"==establishment_type?$scope.establishmentTypeOther=!0:($scope.establishmentTypeOther=!1,$scope.companyData.establishment_type_other=null)},$scope.companyTypeOther=!0,$scope.companyTypeClicked=function(company_type){"Other"==company_type?$scope.companyTypeOther=!0:($scope.companyTypeOther=!1,$scope.companyData.company_type_other=null)},$scope.companyImages=[],$state.current.name.includes("adminDashboard")&&($scope.BackToListPageDetails=!0),$scope.cancelPage=function(){$state.current.name.includes("adminDashboard.company.view")?$state.go("adminDashboard.company.list"):$state.go("adminDashboard.user.list")},$scope.cancelMultiple=function(){$state.go("adminDashboard.company.list")},$scope.EditTax=function(ev,data,$index){$mdDialog.show({controller:"TaxController",templateUrl:"assets/js/modules/customer/tax-details/tax-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{taxInfo:$scope.taxData,tax:data,taxTypeList:$scope.taxTypeList,companyId:$scope.companyData.id,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){res&&("Edit"==res.type?$scope.taxData=$scope.taxData.map(function(item){return item.id==res.id&&(item=res),item}):$scope.taxData[$index]=res)})},$scope.AddTax=function(ev){$mdDialog.show({controller:"TaxController",templateUrl:"assets/js/modules/customer/tax-details/tax-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add",bankInfo:$scope.taxData,taxTypeList:$scope.taxTypeList,companyId:$scope.companyData.id}}}).then(function(res){res&&$scope.taxData.push(res)})},$scope.AddBankDetails=function(ev){$mdDialog.show({controller:"BankController",templateUrl:"assets/js/modules/customer/bank-details/bank-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add",companyId:$scope.companyData.id}}}).then(function(res){res&&$scope.bankData.push(res)})},$scope.EditBankDetails=function(ev,data,$index){$mdDialog.show({controller:"BankController",templateUrl:"assets/js/modules/customer/bank-details/bank-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:data&&data.id?"Edit":"Modification",companyId:$scope.companyData.id,account:data}}}).then(function(res){res&&("Edit"==res.type?$scope.bankData=$scope.bankData.map(function(item){return item.id==res.id&&(item=res),item}):$scope.bankData[$index]=res)})}}]).controller("layout.standard.toManageCompanyController",["$scope","$timeout","$state","$window","CompanyService","$stateParams","Notification",function($scope,$timeout,$state,$window,CompanyService,$stateParams,Notification){$scope.clickEdit=function(){$scope.show.edit=!0,$scope.cancelEdit()},$scope.addMultipleCompanies=function(){$state.go("adminDashboard.company.multipleCompanies")},$scope.clickView=function(){$scope.cancelEdit()},$scope.editCompanyInfo=!1,$scope.selectedSupplier="",window.innerWidth>425&&($scope.hideMore=!0),$scope.viewCompany=function(table_changes){return $scope.companyItem=table_changes,0===table_changes.length?void Notification.error({message:"Please select atleast one item to view",positionX:"right",positionY:"top"}):table_changes.length>1?void Notification.error({message:"Please select only one item to view",positionX:"right",positionY:"top"}):void $state.go("adminDashboard.company.view",{supplierId:table_changes[0][4]})},$scope.createCompany=function(){$state.go("adminDashboard.company.create")},$scope.cancelEdit=function(){$scope.show.edit=!0,$scope.editOne=!1},$scope.cancelView=function(){$scope.editCompanyInfo=!0,$scope.editOne=!1,$scope.show={edit:!1}},$scope.cancelCompanyEdit=function(){$scope.editCompanyInfo=!1,$scope.editOne=!0,$scope.show={edit:!1}},CompanyService.get().then(function(data){console.log(data.data.results),$scope.companysData=data.data.results},function(err){console.log(err)}),$scope.onCategoryChange=function(selectedcompany){var params={companyId:selectedcompany.id};$state.go($state.$current.parent.name+".company.view",params),console.log(selectedcompany)}}])}();