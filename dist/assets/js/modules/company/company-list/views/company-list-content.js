"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}!function(){var app=angular.module("app");app.controller("company.list.content.controller",["$scope","$window","$timeout","$modal","$log","$state","MessageService","Notification","$rootScope","$http","CompanyService","s3Service",function($scope,$window,$timeout,$modal,$log,$state,MessageService,Notification,$rootScope,$http,CompanyService,s3Service){function initSearch(){var search=instantsearch(_defineProperty({appId:appId,apiKey:apiKey,indexName:"Company",routing:!0,searchParameters:{facetsRefinements:{hide_data:[!1]},facets:["hide_data"]}},"routing",{router:instantsearch.routers.history({windowTitle:function(routeState){var keywords,title="Industrial Products & Services,Suppliers-",description="Catalogue of Products , services along with the Supplier details-";return routeState.roleTypes&&(title+=""+routeState.roleTypes,description=""+routeState.roleTypes),routeState.categories&&(title+=" of "+routeState.categories,description=" "+routeState.categories,keywords=" "+routeState.categories),routeState.locations&&(title+=" in "+routeState.locations,description=""+routeState.locations),description&&document.querySelector('meta[name="description"]').setAttribute("content",description),keywords&&document.querySelector('meta[name="keywords"]').setAttribute("content",keywords),title}}),stateMapping:{stateToRoute:function(uiState){return{query:uiState.query,categories:uiState.hierarchicalMenu&&uiState.hierarchicalMenu["products.lvl0"]&&uiState.hierarchicalMenu["products.lvl0"].join("~").replace(/ /g,""),locations:uiState.hierarchicalMenu&&uiState.hierarchicalMenu["locations.lvl0"]&&uiState.hierarchicalMenu["locations.lvl0"].join("~").replace(/ /g,""),roleTypes:uiState.refinementList&&uiState.refinementList.role_type_name&&uiState.refinementList.role_type_name.join("~").replace(/ /g,""),page:uiState.page}},routeToState:function(routeState){return{query:routeState.query,refinementList:{"products.lvl0":routeState.categories&&routeState.categories.split("~"),"locations.lvl0":routeState.locations&&routeState.locations.split("~"),role_type_name:routeState.roleTypes&&routeState.roleTypes.split("~")},page:routeState.page}}}}));search.addWidget(instantsearch.widgets.searchBox({container:"#search-box",placeholder:"Search for companies"})),search.addWidget(instantsearch.widgets.stats({container:"#stats-container"})),search.addWidget(instantsearch.widgets.hierarchicalMenu({container:"#hierarchical-categories",attributes:["products.lvl0","products.lvl1","products.lvl2","products.lvl3"],templates:{header:"Categories"}})),search.addWidget(instantsearch.widgets.hierarchicalMenu({container:"#hierarchical-cities",attributes:["locations.lvl0","locations.lvl1","locations.lvl2"],templates:{header:"Location"}})),search.addWidget(instantsearch.widgets.refinementList({container:"#refinement-list1",attributeName:"role_type_name",templates:{header:"Company Type"}})),search.addWidget(instantsearch.widgets.hits({container:"#hits",templates:{empty:getNoResultsTemplate(),item:getTemplate("hit")},transformData:{item:function(_item){if(_item.logo=getImageUrl(_item),_item.aboutus_text=getAboutUs(_item),_item.locations=getLocation(_item),_item.supplier_obj&&_item.supplier_obj.company_id?_item.supplier_link="#":_item.supplier_link="#",_item.currency="AED"==_item.currency?"د.إ":"INR"==_item.currency?"₹":"USD"==_item.currency?"$":null,_item.currency&&(_item.unit_price||_item.unit_price_final))if(_item.discount){var unit_price=_item.unit_price_final?_item.unit_price_final:_item.unit_price;unit_price-=unit_price*_item.discount/100,unit_price=Math.floor(unit_price),_item.product_price=_item.currency+" "+unit_price,_item.actual_price=_item.currency+" "+_item.unit_price_final,_item.discount_text=_item.discount+"% Off"}else _item.product_price=_item.currency+" "+(_item.unit_price_final?_item.unit_price_final:_item.unit_price);else _item.product_price="N/A";return _item.products_text=_item.products.map(function(prod){return prod.lvl3?prod.lvl3:prod.lvl2?prod.lvl2:prod.lvl1?prod.lvl1:prod.lvl0?prod.lvl0:void 0}),_item.products_text=_item.products_text.join(", "),_item.products_text.length>250&&(_item.products_text=_item.products_text.substring(0,250)+"..."),_item.company_name.length>30&&(_item.company_name=_item.company_name.substring(0,30)+"..."),_item}},hitsPerPage:6})),search.on("render",function(){var $targetList=angular.element(document.querySelectorAll(".products-section .selectItem"));$targetList.bind("click",function(ev){var checked=ev.target.checked,id=ev.currentTarget.getElementsByClassName("hitObjectId")[0];if(checked||($scope.selectedCompanies=$scope.selectedCompanies.filter(function(item){return item.id!=parseInt(id.innerText)})),checked&&id&&id.innerText){var companyId=id.innerText.split(".").join("");CompanyService.getOne(parseInt(companyId)).then(function(company){$scope.selectedCompanies.push(company.data)})}});var $targetListItems=angular.element(document.querySelectorAll(".products-section .hit"));$targetListItems.bind("click",function(ev){var id=ev.currentTarget.getElementsByClassName("hitObjectId")[0];if(id&&id.innerText){var companyId=id.innerText.split(".").join("");CompanyService.getOne(companyId).then(function(data){var data=data.data,companyName=data.company_name;companyName=companyName.replace(/ +/g,"-"),$window.open($state.href("layout.standard.companyIntro.intro",{companyId:data.id,companyName:companyName,description:data.aboutus_text}),"_blank")})}})}),search.addWidget(instantsearch.widgets.pagination({container:"#pagination",scrollTo:"#search-box"})),search.addWidget(instantsearch.widgets.clearAll({container:"#clear-all",templates:{link:"Clear all"},autoHideContainer:!1,clearsQuery:!1,excludeAttributes:["hide_data","stock_or_inventory"]})),search.start()}function getLocation(item){if(item.locations){if(item.locations.length){var loc=item.locations[0].lvl0;return item.locations[0].lvl1&&(loc=item.locations[0].lvl1.replace(" >",",")),item.locations[0].lvl2&&(loc=item.locations[0].lvl2.replace(/ >/g,",")),loc}return"N/A"}return"N/A"}function getImageUrl(item){return item.logo?item.logo:"/assets/img/sample-pro.jpg"}function extractContent(s){var span=document.createElement("span");return span.innerHTML=s,span.textContent||span.innerText}function getAboutUs(item){return item.aboutus_text?extractContent(item.aboutus_text):"N/A"}function getTemplate(templateName){var messageElem=angular.element(document.querySelector("#hitTemplate"));return messageElem.contents()[0].data}function getNoResultsTemplate(){var messageElem=angular.element(document.querySelector("#no-results-template"));return messageElem.contents()[0].data}function getCurrentUser(){if($scope.current_user.data)return $scope.current_user.data}function sendEnquiry(size,message,tabCount,itemCount,closeOnClick){if(!Object.keys($scope.current_user.data).length)return void Notification.error({message:"Please Login to send enquiry",positionX:"right",positionY:"top"});var totalEmail=[],companyEmails=[],send=[];message.forEach(function(data){var companymail,companyId=data.id,companyName=data.company_name;if(data.contact.length||data.contact){if(data.contact.forEach(function(item){item.emailid1&&!totalEmail.length?(companymail=item.emailid1,totalEmail.push(item.emailid1)):!totalEmail.length&&item.emailid2&&(companymail=item.emailid2,totalEmail.push(item.emailid2))}),totalEmail.length)companyEmails=companyEmails.concat(totalEmail);else{companymail="info@supplierscave.com";var email="info@supplierscave.com";companyEmails=companyEmails.concat(email)}totalEmail=[]}else{companymail="info@supplierscave.com";var email="info@supplierscave.com";companyEmails=companyEmails.concat(email),totalEmail=[]}send.push({companyName:companyName,companyId:companyId,email:companymail})});var params={templateUrl:"companySendEnquiry.html",resolve:{items:function(){return $scope.items}},controller:function($scope,$modalInstance,items){function uploadMultipleFilesFn(file,type){var currentUserId;showUser&&(currentUserId=showUser.id);var path="user/"+currentUserId+"/directory/multiFile";s3Service.uploadFile(path,file,function(url){"product-images"===type?_productImages.push(url):"file-attachments"===type&&fileAttachments.push(url),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})},function(error){errorCallback(error)})}var showUser=getCurrentUser(),listData=[];showUser.id&&($scope.sender_name=showUser.first_name,$scope.sender_email=showUser.email);var companyNames=[];send.forEach(function(item){companyNames.push(item.companyName)}),$scope.to=companyNames,$scope.subject="Enquiry for Company",$scope.message=showUser.signature?"<br/><br/>"+showUser.signature:"",$scope.tinymceOptions={resize:!1,width:1160,height:130,plugins:"print textcolor",toolbar:"undo redo styleselect bold italic print forecolor backcolor",setup:function(ed){ed.on("NodeChange",function(e){$scope.message=ed.getContent()})}};var _productImages=[];$scope.uploadFiles=function(files,type){files.forEach(function(file){uploadMultipleFilesFn(file,type)}),files=[]};var fileAttachments=[];$scope.$on("selectedCompaniesInfo",function(event,data){var arr=[];data.forEach(function(item,$index){if(item.email.includes(",")){var emails=item.email.split(",");console.log(emails),emails.forEach(function(data){arr.push({email:data,companyName:item.companyName})}),data.splice($index,1)}}),data.length&&(send=send.concat(data)),arr.length&&(send=send.concat(arr)),companyNames=[],send.forEach(function(item){companyNames.push(item.companyName)});var final=_.uniqBy(companyNames);$scope.to=final}),$scope.send=function(to,cc,subject,message,sender_email,sender_name){if(!to.length)return void Notification.error({message:"Please Enter One Recipient",positionX:"right",positionY:"top"});if(!$scope.message)return void Notification.error({message:"Please Enter Message",positionX:"right",positionY:"top"});var buyerName,buyerEmail,currentUser=getCurrentUser(),totalData=[];buyerName=sender_name,buyerEmail=sender_email,send.forEach(function(info){var item={};return item.company_name=info.companyName,item.sender=currentUser.id,item.supplier_company=info.companyId,item.sender_email=sender_email,item.sender_name=sender_name,item.subject=subject,item.message=message,item.attachments=fileAttachments,totalData.push(item),Object.keys(currentUser).length?void $http.get("/sendgrid/company-send-Enquiry/",{params:{buyerName:buyerName,companyName:info.companyName,userEmail:buyerEmail,message:message,senderEmail:info.email}}).then(function(response){Notification.success({message:"Sent email to the Email Address specified",positionX:"right",positionY:"top"}),$scope.ok()})["catch"](function(error){Notification.error({message:"Something went wrong. Please try again.",positionX:"right",positionY:"top"})}):void Notification.error({message:"Please Login to send enquiry",positionX:"right",positionY:"top"})}),MessageService.post(totalData).then(function(result){Notification.success({message:"Message Sent",positionX:"right",positionY:"top"}),$timeout(function(){$window.location.reload()},3e3)})},$scope.reposition=function(){$modalInstance.reposition()},$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.openNested=function(){listData.length?openCompanyList("small",listData):openCompanyList()}}};angular.isDefined(closeOnClick)&&(params.closeOnClick=closeOnClick),angular.isDefined(size)&&(params.size=size);var modalInstance=$modal.open(params);modalInstance.result.then(function(){},function(){$log.info("Modal dismissed at: "+new Date)})}function openCompanyList(size,message,tabCount,itemCount,closeOnClick){var params={templateUrl:"companiesList.html",resolve:{items:function(){return $scope.items}},controller:function($scope,$modalInstance,items){var newCompany=[];$scope.reposition=function(){$modalInstance.reposition()},$scope.ok=function(){$modalInstance.close()},$scope.submit=function(companyName,companyEmail){return companyName?companyEmail?(newCompany.push({companyName:companyName,email:companyEmail}),$rootScope.$broadcast("selectedCompaniesInfo",newCompany),void $modalInstance.dismiss("cancel")):void Notification.error({message:"Please Enter Company Email",positionX:"right",positionY:"top"}):void Notification.error({message:"Please Enter Company Name",positionX:"right",positionY:"top"})},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.openNested=function(){open()}}};angular.isDefined(closeOnClick)&&(params.closeOnClick=closeOnClick),angular.isDefined(size)&&(params.size=size);var modalInstance=$modal.open(params);modalInstance.result.then(function(){},function(){$log.info("Modal dismissed at: "+new Date)})}$scope.selectedCompanies=[];var appId,apiKey;$http.get("/backend/get-aloglia-keys/").then(function(response){appId=response.data.appId,apiKey=response.data.apiKey,initSearch()}),$scope.sendEnquiry=sendEnquiry,$scope.openCompanyList=openCompanyList}])}();