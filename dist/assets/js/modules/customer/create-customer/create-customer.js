"use strict";!function(){var app=angular.module("app");app.controller("admin.customers",["$scope","CompanyTypeService","$rootScope","UserService","$state","s3Service","CustomerService","Notification","$timeout","dateService","$stateParams","$mdDialog","CategoryService","$q","TaxService","BankService","$log",function($scope,CompanyTypeService,$rootScope,UserService,$state,s3Service,CustomerService,Notification,$timeout,dateService,$stateParams,$mdDialog,CategoryService,$q,TaxService,BankService,$log){function CreateFilterFor(query){var lowercaseQuery=query.toLowerCase();return function(category){var result=category.parentCategory.toLowerCase();return 0===result.indexOf(lowercaseQuery)}}function getUserData(){return $scope.userInfo?$scope.userInfo:$scope.current_user&&$scope.current_user.data?$scope.current_user.data:void 0}function SaveTaxDetails(customer){var arr=[];$scope.taxData.map(function(item){item&&item.id?TaxService.update(item.id,item).then(function(result){$log.log("updated Tax details")}):arr.push(item)}),arr.length?TaxService.post(arr).then(function(resp){Notification.success({message:"Successfully updated customer.",positionX:"right",positionY:"top"},function(resp){$log.error(resp.data)}),RedirectPage(customer)}):RedirectPage(customer)}function DeleteTaxList(){var arr=[];$scope.deleteTaxData.map(function(item){item.id&&TaxService["delete"](item.id).then(function(resp){arr.push(resp.data),$scope.deleteTaxData.length===arr.length&&$log.log("successfully deleted")},function(error){$log.error(error.data)})})}function SaveBankDetails(data,value){var arr=[],res=[];$scope.bankData.map(function(bank){bank&&bank.id&&"modified"==bank.content?BankService.update(bank.id,bank).then(function(results){res.push(results.data),$scope.bankData.length==res.length&&(value?SaveTaxDetails(data):(Notification.success({message:"Successfully updated customer.",positionX:"right",positionY:"top"}),RedirectPage(data)))}):bank.content||bank.id||arr.push(bank),arr.length?BankService.post(arr).then(function(results){value?SaveTaxDetails(data):(Notification.success({message:"Successfully updated customer.",positionX:"right",positionY:"top"}),RedirectPage(data))}):value?SaveTaxDetails(data):(Notification.success({message:"Successfully updated customer.",positionX:"right",positionY:"top"}),RedirectPage(data))})}function RedirectPage(data){$scope.showLoader=!1,$state.current.name.includes("customers")?$state.current.name.includes("adminDashboard.projects")||$state.current.name.includes("adminDashboard.enquiries")?$mdDialog.hide(data.data):$state.current.name.includes("supplierDashboard.projects")||$state.current.name.includes("supplierDashboard.enquiries")?$mdDialog.hide(data.data):$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.customers.list"):$state.go("supplierDashboard.customers.list"):$state.current.name.includes("buyerDashboard.suppliers")&&($state.current.name.includes("adminDashboard.projects")||$state.current.name.includes("adminDashboard.enquiries")?$rootScope.$broadcast("customerClose",data.data):$state.current.name.includes("supplierDashboard.projects")||$state.current.name.includes("supplierDashboard.enquiries")?$rootScope.$broadcast("customerClose",data.data):$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.suppliers.list"):$state.go("buyerDashboard.suppliers.list"))}function DeleteBankList(){var arr=[];$scope.deleteBankData.map(function(item){item.id&&BankService["delete"](item.id).then(function(resp){arr.push(resp.data),$scope.deleteBankData.length===arr.length&&$log.log("successfully deleted")},function(error){$log.error(error)})})}$scope.showLoader=!1,$scope.attachments=[],$scope.customer={},$scope.bank={},$scope.taxTypeList=[],$scope.catalogs=[],$scope.contactList=[],$scope.taxData=[],$scope.arrowDirection=!0,$scope.existingAttachments=[],$scope.existingCatalogs=[],$scope.fileAttachments=[],$scope.catalogFiles=[],$scope.disableClient=!1,$scope.disableContractor=!1;$scope.deleteTaxData=[],$scope.addresses=[];var categoriesData;$scope.selectedCategories=[],$scope.searchText=null,$scope.bankData=[],$scope.deleteBankData=[],$scope.customerAttachments=[],$scope.customerCatalogs=[],$stateParams.customerId&&($scope.showLoader=!0),$scope.showsuppliers=!1,($state.current.name.includes("supplierDashboard.customers")||$state.current.name.includes("adminDashboard.customers"))&&($scope.showsuppliers=!0),CompanyTypeService.get().then(function(res){$scope.companyTypes=res.data.results,$scope.companyTypes.push({id:9,company_type_name:"Others(specify)"})}),TaxService.getTaxTypes().then(function(data){$scope.taxTypeList=data.data.results,$scope.taxData.length&&$scope.taxData.map(function(item){$scope.taxTypeList.map(function(tax){item.tax_type===tax.id&&(item.taxType=tax)})})}),UserService.getRoleTypes().then(function(roledata){$scope.roleTypes=[],roledata.data.count>0&&roledata.data.results.map(function(item){1!=item.id&&9!=item.id||$scope.roleTypes.push({id:item.id,label:item.role_type_name})})}),$scope.removeUploadedCategories=function($index){$scope.customer.categories.splice($index,1)},$scope.remove=function($index,data){$scope.selectedCategories.splice($index,1),data&&data.splice(0,1)},$scope.removecategory=function($index,data){data.splice($index,1)},CategoryService.get({page_size:1e4}).then(function(data){categoriesData=data.data.results,$scope.categories=categoriesData.map(function(categoryData){if(categoryData.parent_category)return{parentCategory:categoryData.parent_category}}),$scope.categories=$scope.categories.filter(function(x,i,a){return a.map(function(item){return item.parentCategory}).indexOf(x.parentCategory)==i})}),$scope.querySearch=function(query){var results=query?$scope.categories.filter(CreateFilterFor(query)):$scope.categories,deferred=$q.defer();return $timeout(function(){deferred.resolve(results)},1e3*Math.random(),!1),deferred.promise},$scope.selectedCategory=function(data,total,edit){if(data&&data.parentCategory){$scope.customer.parentCategory=data.parentCategory,edit||(total.sub_category="",total.sub_sub_category="",total.sub_sub_sub_category="",$scope.subcategories=[],$scope.subsubcategories=[],$scope.subsubsubcategories=[]);var category_temp=categoriesData.filter(function(categoryData){return categoryData.parent_category===data.parentCategory&&null!=categoryData.sub_category});$scope.subcategories=category_temp.map(function(item){return item.sub_category}),$scope.subcategories=$scope.subcategories.filter(function(x,i,a){return a.indexOf(x)==i})}},$scope.selectedSubCategory=function(data){var category_temp=categoriesData.filter(function(categoryData){return categoryData.sub_category===data&&null!=categoryData.sub_sub_category});$scope.subsubcategories=category_temp.map(function(item){if(item.sub_sub_category)return item.sub_sub_category}),$scope.subsubcategories=$scope.subsubcategories.filter(function(x,i,a){return a.indexOf(x)==i})},$scope.selectedSubSubCategory=function(data){var category_temp=categoriesData.filter(function(categoryData){return categoryData.sub_sub_category===data&&null!=categoryData.sub_sub_sub_category});$scope.subsubsubcategories=category_temp.map(function(item){if(item.sub_sub_sub_category)return item.sub_sub_sub_category})},$scope.AddCategories=function(){$scope.selectedCategories?$scope.selectedCategories.push({show:!0}):($scope.selectedCategories=[],$scope.selectedCategories.push({show:!0}))},$scope.AddNewCategories=function(data){data.newCategories=[],data.newCategories.push({}),data.show=!1},$state.current.name.includes("customers")?$stateParams.customerId?$scope.name="Edit Customer":$scope.name="Add Customer":$state.current.name.includes("buyerDashboard.suppliers")&&($stateParams.customerId?$scope.name="Edit Supplier":$scope.name="Add Supplier"),$scope.state=!0,$state.current.name.includes("adminDashboard.customers")&&($scope.state=!1),$scope.AddAttachments=function(){$scope.fileAttachments.push({})},$scope.AddCatalogs=function(){$scope.catalogFiles.push({})},$scope.fileAttachments.length||$scope.fileAttachments.push({}),$scope.catalogFiles.length||$scope.catalogFiles.push({}),$scope.removeAttachment=function(files,index){files.splice(index,1)},$scope.removeCatalog=function(files,index){files.splice(index,1),$scope.catalogs.splice(index,1)},$stateParams.customerId&&(BankService.get({customer:$stateParams.customerId}).then(function(result){result.data.results.length&&($scope.bankData=result.data.results)},function(err){$scope.showLoader=!1}),TaxService.get({customer:$stateParams.customerId}).then(function(res){$scope.taxData=res.data.results,$scope.taxData=$scope.taxData.map(function(item){return item.tax_type&&$scope.taxTypeList.length&&$scope.taxTypeList.map(function(tax){item.tax_type===tax.id&&(item.taxType=tax)}),item.valid_date&&(item.validDate=dateService.convertDateToJS(item.valid_date)),item.issue_date&&(item.issueDate=dateService.convertDateToJS(item.issue_date)),item})},function(err){$scope.showLoader=!1}),CustomerService.getOne($stateParams.customerId).then(function(data){$scope.customer=data.data,$scope.customer.countryCode1||($scope.customer.countryCode1=$scope.current_user.data.country_code),$scope.customer.phonenumber1||($scope.customer.phonenumber1=$scope.current_user.data.contact_no),$scope.customer.emailid1||($scope.customer.emailid1=$scope.current_user.data.email),$scope.customer.addresses.length&&($scope.addresses=$scope.customer.addresses),$scope.customer.role_type?$scope.roleTypes.filter(function(item){item.id==$scope.customer.role_type[0]&&($scope.customer.role_type=item)}):$scope.customer.role_type=[],$scope.customer.contacts&&$scope.customer.contacts.length&&($scope.contactList=$scope.customer.contacts),$scope.customer.attachments&&$scope.customer.attachments.map(function(item){$scope.existingAttachments.push(item)}),$scope.customer.catalogs&&$scope.customer.catalogs.map(function(item){$scope.existingCatalogs.push(item)}),$scope.showLoader=!1},function(err){$scope.showLoader=!1})),$scope.removeCatalogs=function(files,index){$scope.existingCatalogs.splice(index,1)},$scope.removeAttachments=function(files,index){$scope.existingAttachments.splice(index,1)},$scope.catalogImagesToUpload=[],$scope.removeContact=function(contacts,index){contacts.splice(index,1)};var skipClick=!1;if($scope.EditContact=function(ev,data,$index){$mdDialog.show({controller:"customer.contacts",templateUrl:"assets/js/modules/customer/create-customer/customer-contact.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{contactsData:data,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){if(res)if("Edit"==res.type){$scope.contactList[$index]}else $scope.contactList[$index]=res})},$scope.AddContact=function(ev,data,$index){$mdDialog.show({controller:"customer.contacts",templateUrl:"assets/js/modules/customer/create-customer/customer-contact.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{type:"Add"}}}).then(function(res){res&&$scope.contactList.push(res)})},$scope.companyData=[],!$scope.companyData.length){var add={};$scope.companyData.push(add)}$scope.changeDirection=function(){skipClick||($scope.arrowDirection=!$scope.arrowDirection,$scope.arrowDirection?$scope.showContent=!1:$scope.showContent=!0),skipClick=!1},$scope.dropdownSettings={scrollableHeight:"200px",scrollable:!0},$scope.customButtonText={buttonDefaultText:"Select all applicable"},$scope.uploadAttachmentsToS3=function(file,$index,type){$scope.current_user&&$scope.current_user.data||($scope.current_user={},$scope.current_user.data=getUserData());var path="user/"+$scope.current_user.data.id+"/customer/customerAttachments";s3Service.uploadFile(path,file,function(url){url&&("attachments"==type?($scope.customerAttachments.push(url),document.getElementById("customer-attachment").value=null):($scope.customerCatalogs.push(url),document.getElementById("customer-catelog").value=null),$scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}))})},$scope.cancelCustomerInternal=function(){$state.current.name.includes("customers")?$state.current.name.includes("adminDashboard.customers")&&$stateParams.customerId?$state.go("adminDashboard.customers.list"):$state.current.name.includes("adminDashboard.projects")||$state.current.name.includes("adminDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose"):$state.current.name.includes("supplierDashboard.projects")||$state.current.name.includes("buyerDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose"):$state.current.name.includes("supplierDashboard.customers")&&$stateParams.customerId?$state.go("supplierDashboard.customers.list"):$stateParams.customerId||($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.customers.list"):$state.go("supplierDashboard.customers.list")):$state.current.name.includes("buyerDashboard.suppliers")&&($state.current.name.includes("adminDashboard.suppliers")&&$stateParams.customerId?$state.go("adminDashboard.suppliers.list"):$state.current.name.includes("adminDashboard.projects")||$state.current.name.includes("adminDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose"):$state.current.name.includes("buyerDashboard.projects")||$state.current.name.includes("buyerDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose"):$state.current.name.includes("buyerDashboard.suppliers")&&$stateParams.customerId?$state.go("buyerDashboard.suppliers.list"):$stateParams.customerId||($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.suppliers.list"):$state.go("buyerDashboard.suppliers.list")))},$scope.saveCustomer=function(customer,valid){var filterCategories=[];if(!customer.name)return void Notification.error({message:"please enter customer name",positionX:"right",positionY:"top"});if(!customer.role_type&&$state.current.name.includes("customers"))return void Notification.error({message:"please select role type",positionX:"right",positionY:"top"});if(customer.attachments=[],customer.catalogs=[],$scope.showLoader=!0,$scope.customerAttachments.length&&(customer.attachments=$scope.customerAttachments),$scope.existingAttachments&&(customer.attachments.length?customer.attachments=customer.attachments.concat($scope.existingAttachments):customer.attachments=$scope.existingAttachments),$scope.customerCatalogs.length&&(customer.catalogs=$scope.customerCatalogs),$scope.existingCatalogs&&(customer.catalogs.length?customer.catalogs=customer.catalogs.concat($scope.existingCatalogs):customer.catalogs=$scope.existingCatalogs),$scope.addresses.length?customer.addresses=$scope.addresses:customer.addresses=[],$scope.contactList.length?customer.contacts=$scope.contactList:customer.contacts=[],$state.current.name.includes("buyerDashboard.suppliers")?customer.role_type=[8]:customer.role_type&&(customer.role_type=[customer.role_type.id]),$scope.selectedCategories.length){var arr=[],data=[];$scope.selectedCategories.map(function(item){var obj={};item.category_name&&(obj.parent_category=item.category_name.parentCategory),item.sub_category&&(obj.sub_category=item.sub_category),item.sub_sub_category&&(obj.sub_sub_category=item.sub_sub_category),item.sub_sub_category&&(obj.sub_sub_sub_category=item.sub_sub_sub_category),Object.keys(obj).length&&data.push(obj),item.newCategories&&item.newCategories.length&&arr.push(item.newCategories[0])}),filterCategories=arr.length?data.concat(arr):data}if(customer.categories&&customer.categories.length){var filter=[];customer.categories.map(function(item){var obj={};obj.parent_category=item.parent_category,obj.sub_category=item.sub_category,obj.sub_sub_category=item.sub_sub_category,obj.sub_sub_sub_category=item.sub_sub_sub_category,filter.push(obj)}),customer.categories=filter.concat(filterCategories)}else filterCategories.length?customer.categories=filterCategories:customer.categories=[];customer.id?CustomerService.update(customer.id,customer).then(function(data){var tax;$scope.deleteTaxData.length&&DeleteTaxList(),$scope.deleteBankData.length&&DeleteBankList(),$scope.taxData.length||$scope.bankData.length?($scope.taxData.length&&(tax=!0),$scope.bankData.length?SaveBankDetails(data,tax):SaveTaxDetails()):(Notification.success({message:"Successfully updated customer",positionX:"right",positionY:"top"}),RedirectPage(data))}):CustomerService.post(customer).then(function(data){$scope.showLoader=!1,Notification.success({message:"Successfully added customer",positionX:"right",positionY:"top"}),$state.current.name.includes("adminDashboard.projects")||$state.current.name.includes("adminDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose",data.data):$state.current.name.includes("supplierDashboard.projects")||$state.current.name.includes("buyerDashboard.enquiries.createEnquiry")?$rootScope.$broadcast("customerClose",data.data):$state.current.name.includes("supplierDashboard.customers")?$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.customers.list"):$state.go("supplierDashboard.customers.list"):$state.current.name.includes("buyerDashboard.suppliers")&&($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.suppliers.list"):$state.go("buyerDashboard.suppliers.list"))},function(err){$scope.error=err.data,$scope.showLoader=!1})},$scope.CreateAddress=function(ev){$mdDialog.show({controller:"customer.addresses",templateUrl:"assets/js/modules/customer/add-address/customer-address.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add"}}}).then(function(res){res&&Object.keys(res).length&&$scope.addresses.push(res)})},$scope.removeAddress=function($index){$scope.addresses.splice($index,1)},$scope.EditAddress=function(ev,data,$index){$mdDialog.show({controller:"customer.addresses",templateUrl:"assets/js/modules/customer/add-address/customer-address.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{addressInfo:data,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){res&&("Edit"==res.type?$scope.addresses=$scope.addresses.map(function(item){return item.id==res.id&&(item=res),item}):$scope.addresses[$index]=res)})},$scope.EditTax=function(ev,data,$index){$mdDialog.show({controller:"TaxController",templateUrl:"assets/js/modules/customer/tax-details/tax-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{taxInfo:$scope.taxData,tax:data,taxTypeList:$scope.taxTypeList,customerId:$scope.customer.id,type:data&&data.id?"Edit":"Modification"}}}).then(function(res){res&&("Edit"==res.type?$scope.taxData=$scope.taxData.map(function(item){return item.id==res.id&&(item=res),item}):$scope.taxData[$index]=res)})},$scope.AddTax=function(ev){$mdDialog.show({controller:"TaxController",templateUrl:"assets/js/modules/customer/tax-details/tax-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add",taxInfo:$scope.taxData,taxTypeList:$scope.taxTypeList,customerId:$scope.customer.id}}}).then(function(res){res&&$scope.taxData.push(res)})},$scope.removeTaxDetails=function(details,$index){$scope.taxData.splice($index,1),$scope.deleteTaxData.push(details)},$scope.removeBankDetails=function(data,$index){$scope.bankData.splice($index,1),$scope.deleteBankData.push(data)},$scope.AddBankDetails=function(ev){$mdDialog.show({controller:"BankController",templateUrl:"assets/js/modules/customer/bank-details/bank-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:"Add",customerId:$scope.customer.id}}}).then(function(res){res&&$scope.bankData.push(res)})},$scope.EditBankDetails=function(ev,data,$index){$mdDialog.show({controller:"BankController",templateUrl:"assets/js/modules/customer/bank-details/bank-details.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{type:data&&data.id?"Edit":"Modification",customerId:$scope.customer.id,account:data}}}).then(function(res){res&&("Edit"==res.type?$scope.bankData=$scope.bankData.map(function(item){return item.id==res.id&&(item=res),item}):$scope.bankData[$index]=res)})},$scope.uploadLogo=function(file,$index){$scope.current_user&&$scope.current_user.data||($scope.current_user={},$scope.current_user.data=getUserData());var path="user/"+$scope.current_user.data.id+"/customer/logo";s3Service.uploadFile(path,file,function(url){url&&($scope.customer.logo=url,Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}))})}}])}();