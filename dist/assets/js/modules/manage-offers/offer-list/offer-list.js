"use strict";!function(){var app=angular.module("app");app.controller("offer.list",["$scope","$window","$modal","$log","$state","Notification","MessageService","$mdDialog","$http","s3Service","OfferService","$stateParams",function($scope,$window,$modal,$log,$state,Notification,MessageService,$mdDialog,$http,s3Service,OfferService,$stateParams){function processOffers(data){$scope.selectedOffers=[],$scope.count=data.data.count,$scope.totalOffers=data.data.results,$scope.totalOffers=$scope.totalOffers.map(function(item){item.enquiry&&(item.enquiry_number=item.enquiry.enquiry_number,item.message=item.enquiry.message),item.supplier&&(item.companyname=item.supplier.company_name,item.website=item.supplier.website),item.owner&&(item.firstname=item.owner.first_name,item.lastname=item.owner.last_name);var date=item.created;return item.dateFormate=date.slice(0,10),item}),$scope.showLoader=!1}function loadData(params){"Sent"===$scope.type?OfferService.get(params).then(function(data){processOffers(data)}):OfferService.get(params).then(function(data){processOffers(data)})}function loadOfferDataSent(params){OfferService.getOfferSent(params).then(function(data){$scope.current_user.data?$scope.current_user.data.id:"";processOffers(data)})}function loadOfferDataReceived(params){OfferService.getOfferReceived(params).then(function(data){$scope.current_user.data?$scope.current_user.data.id:"";processOffers(data)})}function getUserData(){if($scope.current_user)return $scope.current_user.data}function sendOffer(size,record,data){record=record[0];var id=record.id;data.forEach(function(item){item.id===id&&($scope.offer=item)}),$mdDialog.show({controller:"admin-send-offer",templateUrl:"assets/js/modules/manage-offers/admin-send-offer/admin-send-offer.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,locals:{$dialogScope:{userInfo:getUserData(),offer:$scope.offer}}}).then(function(){$scope.selectedOffers=[]})}function LoadOffersData(){if($state.current.name.includes("adminDashboard")&&loadData($stateParams.emails?{owner__email:$stateParams.emails,page_size:10,page:1}:{page_size:10,page:1}),$state.current.name.includes("supplierDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataSent($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:1}:{ownerId:ownerId,page_size:10,page:1})}if($state.current.name.includes("buyerDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataReceived($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:1}:{ownerId:ownerId,page_size:10,page:1})}}if($scope.selectedOffers=[],$scope.showLoader=!0,$scope.type=$stateParams.type,$scope.$on("offersData",function(event,data){data&&($scope.showLoader=!0,$state.current.name.includes("adminDashboard")&&loadData(data),$state.current.name.includes("supplierDashboard")&&(data.ownerId=$scope.current_user.data.id,data.page_size=10,data.page=1,loadOfferDataSent(data)),$state.current.name.includes("buyerDashboard")&&(data.ownerId=$scope.current_user.data.id,data.page_size=10,data.page=1,loadOfferDataReceived(data)))}),$state.current.name.includes("adminDashboard")&&loadData($stateParams.emails?{owner__email:$stateParams.emails,page_size:10,page:1}:{page_size:10,page:1}),$state.current.name.includes("supplierDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataSent($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:1}:{ownerId:ownerId,page_size:10,page:1})}if($state.current.name.includes("buyerDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataReceived($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:1}:{ownerId:ownerId,page_size:10,page:1})}$scope.type=$stateParams.type,$scope.currentPage=1,$scope.maxSize=10,$scope.setPage=function(pageNo){if($scope.currentPage=pageNo,$state.current.name.includes("adminDashboard")&&loadData($stateParams.emails?{owner__email:$stateParams.emails,page_size:10,page:pageNo}:{page_size:10,page:pageNo}),$state.current.name.includes("supplierDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataSent($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:pageNo}:{ownerId:ownerId,page_size:10,page:pageNo})}if($state.current.name.includes("buyerDashboard")){var ownerId=$scope.current_user.data.id;loadOfferDataReceived($stateParams.emails?{owner__email:$stateParams.emails,ownerId:ownerId,page_size:10,page:pageNo}:{ownerId:ownerId,page_size:10,page:pageNo})}},$scope.type=$stateParams.type;var skipClick=!1;$scope.viewOffer=function(data,skip){skip?skipClick=skip:(skipClick||($state.current.name.includes("adminDashboard.offers.List")?$state.go("adminDashboard.offers.viewOffer",{offerId:data.id}):$state.current.name.includes("supplierDashboard.offers.List")?$state.go("supplierDashboard.offers.viewOffer",{offerId:data.id}):$state.go("buyerDashboard.offers.viewOffer",{offerId:data.id})),skipClick=!1)},$scope.editOffer=function(item){if($scope.selectedOffers<1)return void Notification.error({message:"please select one item",positionX:"right",positionY:"top"});if($scope.selectedOffers>1)return void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"});var data=$scope.selectedOffers[0];$state.go("adminDashboard.offers.editOffer",{offerId:data.id})},$scope.selectedValue=function(data,index,value){console.log(value),value?$scope.selectedOffers.push(data):$scope.selectedOffers.splice(index,1)},$scope.sendOffer=sendOffer,$scope.deleteOffer=function(data){if(0===data.length)return void Notification.error({message:"Please select atleast one item to delete",positionX:"right",positionY:"top"});if(data.length>1)return void Notification.error({message:"Please select one item to delete",positionX:"right",positionY:"top"});var offerId=data[0].id;OfferService["delete"](offerId).then(function(data){LoadOffersData(),Notification.error({message:"successfully deleted",positionX:"right",positionY:"top"}),$scope.selectedOffers=[]})}}])}();