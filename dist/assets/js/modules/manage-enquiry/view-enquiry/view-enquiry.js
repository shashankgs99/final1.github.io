"use strict";!function(){angular.module("app").controller("view.enquiries",["$scope","$modal","$log","$state","Notification","MessageService","OfferService","$stateParams","EnquiryHistoryService","$mdDialog","MTOService","$timeout","UserService","CustomerService","$q",function($scope,$modal,$log,$state,Notification,MessageService,OfferService,$stateParams,EnquiryHistoryService,$mdDialog,MTOService,$timeout,UserService,CustomerService,$q){function getUserData(){if($scope.current_user)return $scope.current_user.data}function loadData(){MessageService.getOne($stateParams.enquiryId).then(function(data){$scope.viewenquiry=data.data,$scope.viewenquiry.enquiry_type&&($scope.viewenquiry.enquiry_type.name=$scope.viewenquiry.enquiry_type.name),$scope.viewenquiry.project&&($scope.viewenquiry.project.customer_contractor&&($scope.viewenquiry.project.customer_contractor.name=$scope.viewenquiry.project.customer_contractor.name),$scope.viewenquiry.project.parent_project?($scope.viewenquiry.parent_project=$scope.viewenquiry.project.parent_project.name,$scope.viewenquiry.sub_project=$scope.viewenquiry.project.name):$scope.viewenquiry.parent_project=$scope.viewenquiry.project.name),$scope.viewenquiry.attachments&&($scope.viewEnquiryImages=[],$scope.viewenquiry.attachments.forEach(function(item){item.split("/");$scope.viewEnquiryImages.push(item)}))}),"Received"===$stateParams.type?$scope.current_user&&$scope.current_user.data&&$scope.current_user.data.company&&OfferService.get({enquiry:$stateParams.enquiryId,supplier:$scope.current_user.data.company.id}).then(function(data){$scope.offers=data.data.results}):"Sent"===$stateParams.type&&OfferService.getOfferReceived({enquiryId:$stateParams.enquiryId}).then(function(data){$scope.offers=data.data.results});var params={};params.enquiryId=$stateParams.enquiryId,"Received"===$stateParams.type&&(params.receiver_email=$scope.current_user.data.email),EnquiryHistoryService.get(params).then(function(data){$scope.receiverHistory=data.data.results,$scope.UiGridOptions.data=$scope.receiverHistory,$scope.UiGridOptions.data=$scope.UiGridOptions.data.map(function(item,$index){return item.checked=!1,item.index=$index+1,item.changed=!1,item})}),MTOService.get({enquiryId:$stateParams.enquiryId}).then(function(response){$scope.mtoItems=response.data.results})}function sendEnquiry(ev,record,data){return $scope.userInfo=getUserData(),$mdDialog.show({controller:"admin-send-enquiry",templateUrl:"assets/js/modules/directory/states/list/views/content/modalpopup/admin-send-enquiry/admin-send-enquiry.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScopeList:{message:record,userInfo:$scope.userInfo}}}).then(function(){loadData()})}function getCompanyId(){return $scope.current_user&&$scope.current_user.data&&$scope.current_user.data.company?$scope.current_user.data.company.id:void 0}function getUserData(){if($scope.current_user)return $scope.current_user.data}function makeOffer(ev,record,totalData){var companyId=getCompanyId();return companyId?record.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):record.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):void $mdDialog.show({controller:"manage.offerDialogController",templateUrl:"assets/js/modules/manage-offers/offer-modal.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,multiple:!0,locals:{$dialogScope:{enquiry:record.id,mtoEnquiryId:record.id,supplier:companyId,userData:$scope.current_user.data}}}).then(function(res){"Received"===$stateParams.type&&(getOfferSent(),loadData())},function(){}):void Notification.error({message:"Register as supplier-admin to create offer",positionX:"right",positionY:"top"})}function getOfferSent(){OfferService.get({enquiry:$stateParams.enquiryId,supplier:$scope.current_user.data.company.id}).then(function(data){$scope.offers=data.data.results})}MessageService.getEnquiryStates().then(function(res){$scope.statusList=res.data.results}),$scope.type=$stateParams.type,$stateParams.enquiryId&&loadData(),MessageService.get().then(function(data){$scope.count=data.data.count,$scope.totalEnquiries=data.data.results}),$scope.editEnquiry=function(data){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.editEnquiry",{messageId:data.id}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.editEnquiry",{messageId:data.id}):$state.go("buyerDashboard.enquiries.editEnquiry",{messageId:data.id})},$scope.sendEnquiry=sendEnquiry,$scope.back=function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.list"):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.list"):$state.go("buyerDashboard.enquiries.list")},$scope.makeOffer=makeOffer,$scope.viewOffer=function(offer){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.offers.viewOffer",{offerId:offer.id,type:"Sent"===$stateParams.type?"Received":"Sent"}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.offers.viewOffer",{offerId:offer.id,type:"Sent"}):$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.offers.viewOffer",{offerId:offer.id,type:"Received"})},$scope.openDialog=function(ev){$mdDialog.show({controller:"viewProductDatatable",templateUrl:"assets/partials/dashboard/buyer/view-product-datatable.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{finalData:$scope.mtoItems,fileAccess:{save:!0}}}}).then(function(res){},function(){})},$scope.deleteOneEnquiry=function(enquiry){enquiry&&enquiry.id&&MessageService["delete"](enquiry.id).then(function(response){Notification.success({message:"Successfully deleted enquiry",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.list"):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.list"):$state.go("buyerDashboard.enquiries.list")},1e3)})},$scope.viewStatus=function(){$state.go("buyerDashboard.enquiries.enquiryStatus")},$scope.UiGridOptions={enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,columnDefs:[{name:"checked",displayName:"",cellTemplate:'<input type="checkbox" ng-model="row.entity.checked">'},{name:"index",displayName:"S.NO",width:75,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!1},{field:"contact.name",displayName:"Company",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!1},{field:"contact.contacts[0].firstname",displayName:"Contact",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!1},{field:"contact.emailid1",displayName:"Email",width:150,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1,visible:!$scope.reverseGrnData},{field:"enquiry.enquiry_state",displayName:"Status",width:150,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"remarks",displayName:"Remarks",width:150,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1}]},$scope.UpdateStatus=function(data,ev){var checked=[];return data.map(function(record){record.checked&&checked.push(record)}),checked.length?$mdDialog.show({controller:"layout.order.updateGRNItems",templateUrl:"assets/js/modules/po/GRN/update-grn-details/update-grn-details.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{display:"enquiry"}}}).then(function(res){res&&($scope.UiGridOptions.data=$scope.UiGridOptions.data.map(function(item,$index){return item&&item.checked&&(res.status&&(item.status=res.status,item.changed=!0),res.remarks&&(item.remarks=res.remarks,item.changed=!0)),item}),$scope.saveStatus())}):void Notification.error({message:"please select items",positionX:"right",positionY:"top"})},$scope.selectAll=function(data){data?$scope.UiGridOptions.data=$scope.UiGridOptions.data.map(function(item){return item.checked=!1,item.index=$index+1,item}):$scope.UiGridOptions.data=$scope.UiGridOptions.data.map(function(item){return item.checked=!0,item.index=$index+1,item})},$scope.saveStatus=function(){var data=[],resp=[];$scope.UiGridOptions.data.map(function(item){item&&item.changed&&data.push(item)}),data.length?data.map(function(item){var obj={};item.status&&(obj.status=item.status),item.remarks&&(obj.remarks=item.remarks),EnquiryHistoryService.update(item.id,obj).then(function(res){if(resp.push(res.data),data.length==resp.length){var status={};"Offers Received"==obj.status&&$scope.statusList.map(function(rec){obj.status==rec.name&&(status.enquiry_state=rec.id)}),"Offers Evaluated"!=obj.status&&"Offers Rejected"!=obj.status&&"Under Negotiations"!=obj.status||$scope.statusList.map(function(rec){"Offers Evaluated"==rec.name&&(status.enquiry_state=rec.id)}),"Letter of Intent"==obj.status&&$scope.statusList.map(function(rec){"Awarded"==rec.name&&(status.enquiry_state=rec.id)}),"Regretted"==obj.status&&$scope.statusList.map(function(rec){"Regretted"==rec.name&&(status.enquiry_state=rec.id)}),Object.keys(status).length?MessageService.update($stateParams.enquiryId,status).then(function(res){loadData(),Notification.success({message:"successfully saved",positionX:"right",positionY:"top"})}):(loadData(),Notification.success({message:"successfully saved",positionX:"right",positionY:"top"}))}})}):Notification.error({message:"please change status",positionX:"right",positionY:"top"})}}])}();