"use strict";!function(){var app=angular.module("app");app.controller("createEnquiry",["$scope","$window","$modal","$log","$state","s3Service","ProjectService","MessageService","Notification","$timeout","$stateParams","CsvService","PurchaseRequisitionService","ProjectGroupService","MTOService","$mdDialog","MTOGroupService","CustomerService",function($scope,$window,$modal,$log,$state,s3Service,ProjectService,MessageService,Notification,$timeout,$stateParams,CsvService,PurchaseRequisitionService,ProjectGroupService,MTOService,$mdDialog,MTOGroupService,CustomerService){function getUserInfo(){if($scope.current_user)return $scope.current_user.data}function getProjectData(info){$scope.getProjectMTO(info.id),$scope.displayProject=info,$scope.displayProject.customer&&CustomerService.getOne($scope.displayProject.customer).then(function(data){$scope.displayProject.customer=data.data}),$scope.displayProject.customer_contractor&&CustomerService.getOne($scope.displayProject.customer_contractor).then(function(data){$scope.displayProject.customer_contractor=data.data}),ProjectService.getMainProjects().then(function(data){$scope.projects=data.data,$scope.projects.map(function(item){item.id==info.id&&($scope.enquiry.parent_project=item)}),$scope.displayProject&&$scope.displayProject.project_type&&projectTypes.map(function(item){item.id===$scope.displayProject.project_type&&($scope.displayProject.project_type=item)})})}function getSubProject(info){$scope.displayProject=info,$scope.displayProject.customer_client&&CustomerService.getOne($scope.displayProject.customer_client).then(function(data){$scope.displayProject.customer_client=data.data}),$scope.displayProject.customer_contractor&&CustomerService.getOne($scope.displayProject.customer_contractor).then(function(data){$scope.displayProject.customer_contractor=data.data}),$scope.enquiry.parent_project&&ProjectService.getSubProjects($scope.enquiry.parent_project.id).then(function(data){$scope.sub_projects=data.data,$scope.enquiry.sub_project=info,$scope.displayProject.project_type&&projectTypes.map(function(item){item.id===$scope.displayProject.project_type&&($scope.displayProject.project_type=item)})})}function createProject(ev,type){$mdDialog.show({controller:"projectController",templateUrl:"assets/js/modules/project/project-modal.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{userInfo:getUserInfo(),disable:!0,title:type,parentProject:"Sub-Project"===type?$scope.enquiry.parent_project:null}}}).then(function(res){res&&("Project"===type?getProjectData(res):getSubProject(res))},function(){})}$scope.arrowDirection=!0,$scope.fileUploads=[];var currentData=[];$scope.fileList=[],$scope.viewMtoList=[],$scope.projectNames=[],$scope.uploadedFilesList=[],$scope.disabledData=!1,$scope.disableImport=!1;var enquiryTypes,projectTypes,fileName=null;if($scope.enquiry={message:""},!$scope.fileUploads.length){var file={};file.add=!0,$scope.fileUploads.push(file)}$stateParams.messageId&&($scope.showLoader=!0),$scope.PRFiles=[],$scope.productFiles=[];var parentProject,subProject;if($scope.buttonName="Create Enquiry",ProjectService.getProjectTypes().then(function(data){projectTypes=data.data.results}),$scope.deleteMTO=function($index){var data=$scope.uploadedFilesList[$index];if(data&&data.recordId)var deleteRecords=data.recordId[0];deleteRecords?(data.map(function(item){MTOService["delete"](item).then(function(data){Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"})})}),console.log("successfully deleted all records"),$scope.uploadedFilesList.splice($index,1),$scope.fileList.splice($index,1),$scope.disabledData=!1,$scope.disableImport=!1,$scope.csvfile=null,fileName=null):($scope.disabledData=!1,$scope.disableImport=!1,$scope.fileList.splice($index,1),$scope.uploadedFilesList.splice($index,1),fileName=null)},$scope.cancelEdit=function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.list"):$state.current.name.includes("supplierDashbord")?$state.go("supplierDashboard.enquiries.list"):$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.enquiries.list")},$scope.removePRFiles=function(files,index){$scope.PRFiles.splice(index,1)},!$scope.PRFiles.length){var file={};$scope.PRFiles.push(file)}$stateParams.messageId&&($scope.messageId=$stateParams.messageId,$scope.buttonName="Edit Enquiry",MTOService.get({enquiryId:$stateParams.messageId}).then(function(data){var result=data.data.results;result.length&&($scope.enquiryMtoList=[],result.map(function(item){item.group&&MTOGroupService.getOne(item.group).then(function(data){$scope.enquiryMtoList.push(data.data)})}))}),MessageService.getOne($stateParams.messageId).then(function(data){$scope.showLoader=!1,$scope.enquiry=data.data,data.data.project?(data.data.project.parent_project?(parentProject=data.data.project.parent_project,subProject=data.data.project):parentProject=data.data.project,$scope.enquiry.parent_project=parentProject,$scope.selectedProject($scope.enquiry.parent_project,"project")):data.data.project&&($scope.enquiry.parent_project=parentProject,$scope.selectedProject($scope.enquiry.parent_project,"project")),$scope.enquiry.attachments&&$scope.enquiry.attachments.forEach(function(item){var fileAttachment=item.split("/");$scope.productFiles.push({fileName:fileAttachment.pop(),filePath:item})})})),MessageService.getEnquiryTypes().then(function(data){enquiryTypes=data.data.results}),$scope.enquiry={},$scope.uploadedFiles=[],ProjectService.getMainProjects().then(function(data){$scope.projects=data.data,$scope.enquiry&&$scope.enquiry.parent_project&&$scope.projects.map(function(item){item.id==$scope.enquiry.parent_project.id&&($scope.enquiry.parent_project=item)})}),$scope.AddUploadFiles=function(){var file={};file.remove=!0,$scope.fileUploads.push(file)},$scope.removeFiles=function(files,index,removeFromS3Files){files.splice(index,1),removeFromS3Files&&$scope.uploadedFiles.splice(index,1)},$scope.uploadFile=function(file,$index){var upload=!1,path="user/"+$scope.current_user.data.id+"/enquiry/enquiryAttachments";s3Service.uploadFile(path,file,function(url){$scope.uploadedFiles.length?($scope.uploadedFiles.forEach(function(item){item.index==$index&&(upload=!0,item.url=url)}),upload||$scope.uploadedFiles.push({url:url,index:$index})):$scope.uploadedFiles.push({url:url,index:$index}),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"})},function(error){errorCallback(error)})},$scope.selectedMTOList=[],$scope.selectedMTOGroups=[],$scope.selectedMTO=function(data,$index,value){value?$scope.selectedMTOGroups.map(function(item,index){item.id===data.id&&($scope.selectedMTOGroups.splice(index,1),$scope.selectedMTOGroups.length-1)}):$scope.selectedMTOGroups.push(data)},$scope.getFileName=function(data){var file=document.getElementById("mto-file");fileName=file.value.split("\\").pop(),$scope.csvfile=data},$scope.importData=function(csvfile){return currentData=[],fileName?($scope.data=CsvService.csvParser(csvfile,"MTOService"),currentData.push($scope.data),$scope.fileList.push($scope.data),$scope.uploadedFilesList.push({fileName:fileName}),Notification.success({message:"Successfully imported file",positionX:"right",positionY:"top"}),document.getElementById("mto-file").value=null,$scope.disabledData=!0,$scope.disableImport=!0,void 0):void Notification.error({message:"please select file to import",positionX:"right",positionY:"top"})},$scope.ViewInfo=function(ev,$index){if(!$scope.enquiry.parent_project)return void Notification.error({message:"please select project",positionX:"right",positionY:"top"});var final=[],info=$scope.fileList[$index],fileAccess=$scope.uploadedFilesList[$index];if(fileAccess&&fileAccess.save)fileAccess.save=!0,final=info;else{var project=$scope.enquiry.parent_project.id,path="user/"+$scope.current_user.data.id+"/mto";final=info;var group={};group.project=project}$mdDialog.show({controller:"viewProductDatatable",templateUrl:"assets/partials/dashboard/buyer/view-product-datatable.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{finalData:final,fileAccess:fileAccess,project:project,path:path,csvfile:$scope.csvfile,groupData:group}}}).then(function(res){res&&res.save&&(fileName=null,$scope.disabledData=!1,$scope.disableImport=!1,$scope.uploadedFilesList.map(function(item,index){$index==index&&(item.save=!0)}))},function(){})},$scope.save=function(data,$index){var arr=[];if(!$scope.enquiry.parent_project)return void Notification.error({message:"please select project",positionX:"right",positionY:"top"});var path="user/"+$scope.current_user.data.id+"/mto";s3Service.uploadFile(path,$scope.csvfile,function(url){var group={};group.project=$scope.enquiry.parent_project.id,group.attachment=url,MTOGroupService.post(group).then(function(result){currentData.map(function(mto){mto.map(function(item){Object.keys(item).length&&(item.project=$scope.enquiry.parent_project.id,item.group=result.data.id,arr.push(item))})}),MTOService.post(arr).then(function(data){var uploadedId=[],res=data.data;res.map(function(item){uploadedId.push(item.id)}),Notification.success({message:"Successfully Saved",positionX:"right",positionY:"top"}),$scope.selectedMTOList.length?$scope.selectedMTOList=$scope.selectedMTOList.concat(data.data):$scope.selectedMTOList=data.data,$scope.uploadedFilesList.map(function(item,index){$index==index&&(item.save=!0,item.recordId=uploadedId)}),$scope.disabledData=!1,$scope.disableImport=!1,fileName=null})})})},$scope.tinymceOptions={plugins:"link image code media table paste",toolbar:"undo redo | bold italic | alignleft aligncenter alignright | code"},tinymce.init({selector:"#mytextarea",height:500,menubar:!0,plugins:["advlist autolink lists link image charmap print preview anchor textcolor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste code help wordcount"],toolbar:"insert | undo redo |  formatselect | bold italic backcolor  | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help",content_css:["//fonts.googleapis.com/css?family=Lato:300,300i,400,400i","//www.tinymce.com/css/codepen.min.css"]}),$scope.importform=function(csvfile){CsvService.csvParser(csvfile,$scope.serviceName)},$scope.selectedProject=function(project,type){$scope.selectedMTOGroups=[],$scope.viewMtoList=[],$scope.mtoSelection=!1,$scope.getProjectMTO(project.id),project&&($scope.displayProject=project),"project"===type&&ProjectService.getSubProjects(project.id).then(function(data){$scope.sub_projects=data.data,parentProject&&subProject&&($scope.enquiry.sub_project=subProject,$scope.displayProject=subProject)})},$scope.getProjectMTO=function(id){ProjectGroupService.get({projectId:id}).then(function(data){$scope.MTOList=data.data.results,$scope.MTOList=$scope.MTOList.map(function(item){return item.fileName=item.attachment.split("/").pop(),item.checked=!1,item.indeterminate=!1,item})})},$scope.saveEnquiry=function(enquiry){var arr=[],finalMtoList=[],totalRecords=[];if($scope.selectedMTOGroups.length?($scope.viewMtoList.length&&(arr=_.flattenDeep([finalMtoList,$scope.selectedMTOList])),$scope.selectedMTOGroups.map(function(item){MTOService.get({groupId:item.id}).then(function(data){finalMtoList.length?finalMtoList=finalMtoList.concat(data.data.results):finalMtoList.push(data.data.results),totalRecords=_.flattenDeep([finalMtoList,$scope.selectedMTOList,arr])})})):($scope.viewMtoList.length&&(arr=_.flattenDeep([finalMtoList,$scope.selectedMTOList])),totalRecords=_.flattenDeep([$scope.selectedMTOList,arr])),!enquiry.subject)return void Notification.error({message:"Please enter subject",positionX:"right",positionY:"top"});if(!enquiry.message)return void Notification.error({message:"Please enter email-body",positionX:"right",positionY:"top"});if(enquiry.attachments=[],enquiry.id&&!enquiry.edit_notes)return void Notification.error({message:"Please input edit notes to continue",positionX:"right",positionY:"top"});enquiry.sub_project?(enquiry.project=enquiry.sub_project.id,delete enquiry.sub_project,delete enquiry.parent_project):enquiry.parent_project&&(enquiry.project=enquiry.parent_project.id,delete enquiry.parent_project),$scope.uploadedFiles.length&&$scope.uploadedFiles.forEach(function(item){enquiry.attachments.push(item.url)}),$scope.productFiles&&$scope.productFiles.forEach(function(item){enquiry.attachments.push(item.filePath)});var enquirytype=enquiryTypes.filter(function(item){return"Enquiry"===item.name});enquiry.enquiry_type=enquirytype[0].id,enquiry.owner&&delete enquiry.owner,delete enquiry.enquiry_state,enquiry.id?(enquiry.supplier||delete enquiry.supplier,enquiry.sender&&(enquiry.sender=enquiry.sender.id),enquiry.supplier_company||delete enquiry.supplier_company,enquiry.supplier_company&&(enquiry.supplier_company=enquiry.supplier_company.id),enquiry.sender||delete enquiry.sender,enquiry.receiver||delete enquiry.receiver,enquiry.project&&enquiry.project.id&&(enquiry.project=enquiry.project.id),MessageService.update(enquiry.id,enquiry).then(function(data){console.log("success"),totalRecords.length&&totalRecords.forEach(function(item,$index){MTOService.update(item.id,{enquiry:data.data.id}).then(function(res){$index===totalRecords.length-1&&Notification.success({message:"Successfully added MTO to enquiry",positionX:"right",positionY:"top"})})}),Notification.success({message:"Successfully updated enquiry",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id}):$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id})},1e3)},function(err){$scope.error=err.data,console.log($scope.error)})):($scope.current_user&&$scope.current_user.data&&(enquiry.sender=$scope.current_user.data.id),MessageService.post(enquiry).then(function(data){console.log(totalRecords),totalRecords.length?totalRecords.forEach(function(item,$index){MTOService.update(item.id,{enquiry:data.data.id}).then(function(res){$index===totalRecords.length-1&&Notification.success({message:"Successfully created enquiry",positionX:"right",positionY:"top"})})}):Notification.success({message:"Successfully created enquiry",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id}):$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.enquiries.viewEnquiries",{enquiryId:data.data.id})},1e3)}))},$scope.getRequistionData=function(data){$scope.purchaseInfo?$scope.purchaseInfo=$scope.purchaseInfo.concat(data):$scope.purchaseInfo=data},$scope.saveEnquiryNewVersion=function(enquiry){return enquiry.revision_notes?(delete enquiry.id,enquiry.supplier||delete enquiry.supplier,enquiry.supplier_company||delete enquiry.supplier_company,enquiry.receiver||delete enquiry.receiver,void $scope.saveEnquiry(enquiry)):void Notification.error({message:"Please enter new revision notes to continue",positionX:"right",positionY:"top"})},$scope.createProject=createProject,$scope.viewMtoData=function(ev,data,$index){var items,result=data;MTOService.get({groupId:data.id}).then(function(data){return items=data.data.results,$mdDialog.show({controller:"layout.standard.viewMTOData",templateUrl:"assets/js/modules/manage-enquiry/view-mto-data.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{items:items,disableSave:!1,visible:!0}}}).then(function(res){if(res&&res.length){var data=[];res.indeterminate?$scope.MTOList=$scope.MTOList.map(function(item){return item.id==result.id&&(item.indeterminate=!0,item.checked=!1),item}):res.indeterminate||($scope.MTOList=$scope.MTOList.map(function(item){return item.id==result.id&&(item.indeterminate=!1,item.checked=!0),item})),$scope.selectedMTOGroups.length?($scope.selectedMTOGroups.map(function(item){item.id!==res[0].group&&data.push(item)}),$scope.selectedMTOGroups=data,res.length&&($scope.viewMtoList.length?$scope.viewMtoList=$scope.viewMtoList.concat(res):$scope.viewMtoList.push(res))):res.length&&($scope.viewMtoList.length?$scope.viewMtoList=$scope.viewMtoList.concat(res):$scope.viewMtoList.push(res))}},function(){})})},$scope.remove=function(mto,$index){mto.enquiry=null,MTOService.get({groupId:mto.id}).then(function(data){var result=data.data.results;result.forEach(function(item){MTOService.update(item.id,{enquiry:null}).then(function(data){console.log("successfully updated")})}),$scope.enquiryMtoList.splice($index,1),Notification.error({message:"Successfully deleted",positionX:"right",positionY:"top"})})}}])}();