"use strict";!function(){var app=angular.module("app");app.controller("admin.enquiries",["$scope","$window","$modal","$log","$state","Notification","MessageService","$http","$mdDialog","OfferService","dateService","$rootScope","$stateParams","$filter",function($scope,$window,$modal,$log,$state,Notification,MessageService,$http,$mdDialog,OfferService,dateService,$rootScope,$stateParams,$filter){function loadEnquiriesSent(params){$scope.selectedEnquiries=[],MessageService.getEnquirySent(params).then(function(data){$scope.count=data.data.count,$scope.showLoader=!1,$scope.totalEnquiries=data.data.results,$scope.totalEnquiries=$scope.totalEnquiries.map(function(item){var date=item.created;return item.dateFormate=date.slice(0,10),("Enquiry Created"===item.enquiry_state||"Enquiry Sent"===item.enquiry_state)&&"Received"===$scope.type?item.status="Enquiry Received":item.status=item.enquiry_state,item})})}function loadEnquiries(params){$scope.selectedEnquiries=[],MessageService.get(params).then(function(data){$scope.count=data.data.count,$scope.showLoader=!1,$scope.totalEnquiries=data.data.results,$scope.totalEnquiries.map(function(item){var date=item.created;item.dateFormate=date.slice(0,10),("Enquiry Created"===item.enquiry_state||"Enquiry Sent"===item.enquiry_state)&&"Received"===$scope.type?item.status="Enquiry Received":item.status=item.enquiry_state})})}function loadEnquiriesReceived(params){$scope.selectedEnquiries=[],MessageService.getEnquiryReceived(params).then(function(data){$scope.count=data.data.count,$scope.totalEnquiries=data.data.results,$scope.showLoader=!1,$scope.totalEnquiries=$scope.totalEnquiries.map(function(item){var date=item.created;return item.dateFormate=date.slice(0,10),("Enquiry Created"===item.enquiry_state||"Enquiry Sent"===item.enquiry_state)&&"Received"===$scope.type?item.status="Enquiry Received":item.status=item.enquiry_state,item})})}function loadEnquiriesOuter(page_size,page,data){var params={};if(data&&(params=data),params.page_size=page_size,params.page=page,$state.current.name.includes("adminDashboard")&&($stateParams.enquiryEmails?(params.receiver_history__receiver_email=$stateParams.enquiryEmails,loadEnquiries(params)):loadEnquiries(params)),$state.current.name.includes("supplierDashboard")){var email=$scope.current_user.data.email;email&&(params.email=email,$stateParams.enquiryEmails?(params.receiver_history__receiver_email=$stateParams.enquiryEmails,loadEnquiriesReceived(params)):loadEnquiriesReceived(params))}if($state.current.name.includes("buyerDashboard")){var ownerId=$scope.current_user.data.id;ownerId&&(params.ownerId=ownerId),$stateParams.enquiryEmails?(params.receiver_history__receiver_email=$stateParams.enquiryEmails,loadEnquiriesSent(params)):loadEnquiriesSent(params)}}function getCompanyId(){return $scope.current_user&&$scope.current_user.data&&$scope.current_user.data.company?$scope.current_user.data.company.id:void 0}function getUserData(){if($scope.current_user)return $scope.current_user.data}function makeOffer(size,record,data,backdrop,closeOnClick){var companyId=getCompanyId();if($scope.showOfferDialog=!0,!companyId)return void Notification.error({message:"Register as supplier-admin to create offer",positionX:"right",positionY:"top"});if(record.length>1)return void Notification.error({message:"please select one item",positionX:"right",positionY:"top"});if(record.length<1)return void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"});record=record[0];var params={templateUrl:"makeOffer.html",resolve:{},controller:function($scope,$rootScope,$modalInstance){$scope.offer={},$scope.offer.enquiry=record.id,$scope.mtoEnquiryId=record.id,$scope.offer.supplier=getCompanyId();var userData=getUserData();$scope.offer.userId=userData.id,$scope.$on("offerClose",function(ev,data){loadEnquiriesOuter(10,1),$modalInstance.dismiss("cancel")}),$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};angular.isDefined(closeOnClick)&&(params.closeOnClick=closeOnClick),angular.isDefined(size)&&(params.size=size);var modalInstance=$modal.open(params);modalInstance.result.then(function(selectedItem){$scope.setPage($scope.currentPage)},function(){$log.info("Modal dismissed at: "+new Date)})}function sendEnquiry(record,data,ev){if(record.length>1)return void Notification.error({message:"please select one item",positionX:"right",positionY:"top"});if(record.length<1)return void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"});record=record[0],$scope.userInfo=getUserData();var id=record.id;return data.forEach(function(item){item.id===id&&($scope.message=item)}),$mdDialog.show({controller:"admin-send-enquiry",templateUrl:"assets/js/modules/directory/states/list/views/content/modalpopup/admin-send-enquiry/admin-send-enquiry.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScopeList:{message:$scope.message,userInfo:$scope.userInfo}}}).then(function(){$scope.selectedEnquiries=[],loadEnquiriesOuter(10,1)})}$scope.editOne=!1,$scope.showLoader=!0,$scope.showOfferDialog=!1,$scope.$on("filtersData",function(event,data){data&&($scope.showLoader=!0,loadEnquiriesOuter(10,1,data))}),$scope.type=$stateParams.type,loadEnquiriesOuter(10,1),$scope.currentPage=1,$scope.maxSize=10,$scope.setPage=function(pageNo){$scope.currentPage=pageNo,loadEnquiriesOuter(10,pageNo)},$scope.editEnquiry=function(table_changes){return $scope.enquiryItem=table_changes,0===table_changes.length?void Notification.error({message:"Please select atleast one item to edit",positionX:"right",positionY:"top"}):table_changes.length>1?void Notification.error({message:"Please select one item to edit",positionX:"right",positionY:"top"}):($state.current.name.includes("adminDashboard")&&$state.go("adminDashboard.enquiries.editEnquiry",{messageId:table_changes[0].id}),$state.current.name.includes("supplierDashboard")&&$state.go("supplierDashboard.enquiries.editEnquiry",{messageId:table_changes[0].id}),void($state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.enquiries.editEnquiry",{messageId:table_changes[0].id})))},$scope.selectedValue=function(data,index,value){console.log(value),value?$scope.selectedEnquiries.push(data):$scope.selectedEnquiries.map(function(item,index){item.id===data.id&&($scope.selectedEnquiries.splice(index,1),$scope.selectedEnquiries.length-1)})};var skipClick=!1;$scope.viewEnquiry=function(data,skip){skip?skipClick=skip:(skipClick||($state.current.name.includes("adminDashboard.enquiries.list")?$state.go("adminDashboard.enquiries.viewEnquiries",{enquiryId:data.id}):$state.current.name.includes("supplierDashboard.enquiries.list")?$state.go("supplierDashboard.enquiries.viewEnquiries",{enquiryId:data.id}):$state.go("buyerDashboard.enquiries.viewEnquiries",{enquiryId:data.id})),skipClick=!1)},$scope.cancelEnquiry=function(){$scope.editOne=!1,$scope.show={edit:!0}},$scope.createEnquiry=function(){$state.current.name.includes("adminDashboard")&&$state.go("adminDashboard.enquiries.createEnquiry"),$state.current.name.includes("supplierDashboard")&&$state.go("supplierDashboard.enquiries.createEnquiry"),$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.enquiries.createEnquiry")},$scope.makeOffer=makeOffer,$scope.sendEnquiry=sendEnquiry,$scope.viewEnquiryOffers=function(data){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.offers.list",{data:data,type:"Received"}):$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.offers.list",{data:data,type:"Sent"}):$state.current.name.includes("buyerDashboard")&&$state.go("buyerDashboard.offers.list",{data:data,type:"Received"})},$scope.deleteEnquiry=function(data){if(0===data.length)return void Notification.error({message:"Please select atleast one item to Delete",positionX:"right",positionY:"top"});var list=[];data.map(function(item){MessageService["delete"](item.id).then(function(res){list.push(res.data),list.length==data.length&&(loadEnquiriesOuter(10,1),Notification.error({message:"successfully deleteed",positionX:"right",positionY:"top"}),$timeout(function(){$window.location.reload()},1800))})})}}])}();