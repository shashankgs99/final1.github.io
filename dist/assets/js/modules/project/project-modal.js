"use strict";!function(){var app=angular.module("app");app.controller("projectController",["$scope","$window","$modal","$timeout","$state","ProjectService","dateService","Notification","IndustryService","CustomerService","$log","$rootScope","$stateParams","$mdDialog","$dialogScope",function($scope,$window,$modal,$timeout,$state,ProjectService,dateService,Notification,IndustryService,CustomerService,$log,$rootScope,$stateParams,$mdDialog,$dialogScope){function getUserInfo(){return $dialogScope.userInfo?$dialogScope.userInfo:$scope.current_user?$scope.current_user.data:void 0}function getCustomerData(info,type){var userInfo=getUserInfo();userInfo.id;CustomerService.get({page_size:1e4}).then(function(data){$scope.customers=data.data.results;var customers=data.data.results;customers.forEach(function(item){item.role_type.length&&(1==item.role_type[0]?$scope.contractors.push(item):9==item.role_type[0]&&$scope.clients.push(item))}),"client"===type?$scope.project?($scope.project.customer=info.id,$scope.selectContacts({customer:$scope.project.customer})):($scope.project={customer:info.id},$scope.selectContacts({customer:$scope.project.customer})):$scope.project?($scope.project.customer_contractor=info.id,$scope.contractor({customer_contractor:$scope.project.customer_contractor})):($scope.project={customer_contractor:info.id},$scope.contractor({customer_contractor:$scope.project.customer_contractor}))})}function createClient(ev,type){$mdDialog.show({controller:"layout.standard.createCustomer",templateUrl:"assets/js/modules/customer/customer-modal.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{userInfo:getUserInfo(),type:type}}}).then(function(res){res&&getCustomerData(res,type)},function(){})}$scope.disableProject=$dialogScope.disable,$scope.selectedIndustry=[],$scope.project={due_date:new Date},$scope.clientcontacts=[],$scope.contractorContacts=[],$scope.selectedContacts=[],$scope.clients=[],$scope.contractors=[],$scope.hide=!0,$scope.title=$dialogScope.title,$stateParams.projectId?$scope.name="Edit":$scope.name="Add",ProjectService.getMainProjects().then(function(data){$scope.projectsData=data.data,$dialogScope.parentProject&&($scope.project.parent_project=$dialogScope.parentProject)}),ProjectService.getProjectTypes().then(function(data){projectTypes=data.data.results}),CustomerService.get({page_size:1e4}).then(function(data){$scope.customers=data.data.results;var customers=data.data.results;customers.forEach(function(item){item.role_type.length&&(1==item.role_type[0]?$scope.contractors.push(item):9==item.role_type[0]&&$scope.clients.push(item))})}),IndustryService.get().then(function(data){$scope.industries=data.data.results,$scope.industries=$scope.industries.map(function(item){return{id:item.id,label:item.industry}})});var projectTypes;$stateParams.projectId&&ProjectService.getOne($stateParams.projectId).then(function(data){$scope.project=data.data,$scope.project.due_date&&($scope.project.due_date=dateService.convertDateToJS($scope.project.due_date)),$scope.project.industries&&$scope.project.industries.forEach(function(item){$scope.selectedIndustry.push({id:item.id})}),$scope.project.customer_client&&($scope.project.customer_client=$scope.project.customer_client.id,$scope.selectContacts({customer_client:$scope.project.customer_client})),$scope.project.customer_contractor&&($scope.project.customer_contractor=$scope.project.customer_contractor.id,$scope.contractor({customer_contractor:$scope.project.customer_contractor})),$scope.project.client_contacts.length&&($scope.clientcontacts=[],$scope.project.client_contacts.map(function(item){$scope.clientcontacts.push({id:item.id})})),$scope.project.contractor_contacts.length&&($scope.selectedContacts=[],$scope.project.contractor_contacts.map(function(item){$scope.selectedContacts.push({id:item.id})})),$scope.project.project_type&&(1==$scope.project.project_type.id?$scope.project.project_type="Budgetary":$scope.project.project_type="Firm")}),$scope.createClient=createClient,$scope.dropDownSettings={smartButtonMaxItems:3,smartButtonTextConverter:function(itemText,originalItem){return itemText}},$scope.cancelProjectInternal=function(){$mdDialog.hide()},$scope.selectContacts=function(data){$scope.clientContacts=[],CustomerService.getOne(data.customer).then(function(data){var result=data.data;result.contacts&&result.contacts.map(function(item){var name;item.firstname?(name=item.firstname,item.lastname&&(name+=" "+item.lastname)):item.lastname&&(name=item.lastname),name?$scope.clientContacts.push({id:item.id,label:name}):""})})},$scope.contractor=function(data){$scope.contractorContacts=[],CustomerService.getOne(data.customer_contractor).then(function(data){var result=data.data;result.contacts&&result.contacts.map(function(item){var name;item.firstname?name=item.firstname:"",item.lastname?name+=" "+item.lastname:"",name?$scope.contractorContacts.push({id:item.id,label:name}):""})})},$scope.saveProject=function(project,valid){if($scope.submitted=!0,!project.name)return void Notification.error({message:"please enter project name",positionX:"right",positionY:"top"});if($scope.clientcontacts.length){var contacts=$scope.clientcontacts.map(function(item){return item.id});project.customer_contacts=contacts}if($scope.contractorContacts.length){var contacts=$scope.contractorContacts.map(function(item){return item.id});project.contractor_contacts=contacts}if($scope.selectedIndustry.length&&(project.industries=$scope.selectedIndustry.map(function(item){return item.id})),project.project_type){var types=projectTypes.filter(function(item){return item.name===project.project_type});types&&types.length&&(project.project_type=types[0].id)}angular.isDate(project.due_date)&&(project.due_date=dateService.convertDateToPython(project.due_date)),project.parent_project&&(project.parent_project=project.parent_project.id),ProjectService.post(project).then(function(data){console.log("success"),Notification.success({message:"Successfully added Project",positionX:"right",positionY:"top"}),$mdDialog.hide(data.data)},function(err){$scope.error=err.data,console.log($scope.error)})}}])}();