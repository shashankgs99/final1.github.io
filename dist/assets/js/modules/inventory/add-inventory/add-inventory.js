"use strict";!function(){angular.module("angucomplete-alt",[]);angular.module("app").controller("dashboard.supplier.addInventory",["$scope","$window","$interval","CityService","InventoryService","CategoryService","$timeout","$injector","Notification","s3Service","CurrencyTypeService","IndustryService","$state","$stateParams",function($scope,$window,$interval,CityService,InventoryService,CategoryService,$timeout,$injector,Notification,s3Service,CurrencyTypeService,IndustryService,$state,$stateParams){function loadRentalPeriodTypes(){InventoryService.getRentalPeriodTypes().then(function(data){if($scope.rental_period_types=data.data.results,$scope.inventoryData.rental_period){var types=$scope.rental_period_types.filter(function(item){return item.id===$scope.inventoryData.rental_period});$scope.inventoryData.rental_period=types[0].period_type}})}function loadCities(){CityService.get({page_size:1e4}).then(function(data){locs=data.data.results,$scope.countries=locs.map(function(loc){return{name:loc.country}}),$scope.countries=$scope.countries.filter(function(x,i,a){return a.map(function(item){return item.name}).indexOf(x.name)==i}),$scope.inventoryData&&$scope.inventoryData.country&&($scope.selectedCountry({title:$scope.inventoryData.country},!0),$scope.inventoryData.state&&$scope.selectedState($scope.inventoryData.state))},function(error){console.log(error)})}function loadCategories(){CategoryService.get({page_size:1e4}).then(function(data){categoriesData=data.data.results,$scope.categories=categoriesData.map(function(categoryData){if(categoryData.parent_category)return{parentCategory:categoryData.parent_category}}),$scope.categories=$scope.categories.filter(function(cat){return void 0!=cat&&null!=cat}),$scope.categories=_.uniqBy($scope.categories,"parentCategory"),$scope.inventoryData&&$scope.inventoryData.category_name&&($scope.selectedCategory({title:$scope.category_name},!0),$scope.inventoryData.sub_category&&($scope.selectedSubCategory($scope.inventoryData.sub_category),$scope.inventoryData.sub_sub_category&&$scope.selectedSubSubCategory($scope.inventoryData.sub_sub_category)))},function(error){console.log(error)})}$scope.errors=[],$scope.inventoryData={};var allIndustries;$scope.industries=[],$scope.inventoryImg=[],$scope.documents=[],$scope.inventoryImages=[],$scope.selectedIndustry=[],$scope.inventoryFiles=[],$scope.inventoryAttachments=[],$scope.inventoryDocs=[],$scope.rentalProduct=!1,CurrencyTypeService.get().then(function(data){$scope.currencyTypeList=data.data.results}),$stateParams.inventoryId&&InventoryService.getOne($stateParams.inventoryId).then(function(result){$scope.inventoryData=result.data,$scope.inventoryData.industry&&allIndustries.forEach(function(industry){$scope.inventoryData.industry.map(function(item){industry.industry===item&&$scope.selectedIndustry.push({label:industry.industry,id:industry.id})})}),$scope.inventoryData.attachments&&$scope.inventoryData.attachments.forEach(function(item){var attachment=item.s3_url.split("/");$scope.inventoryFiles.push({name:attachment.pop(),path:item.s3_url})}),$scope.inventoryData.product_images&&$scope.inventoryData.product_images.forEach(function(item){var image=item.s3_url.split("/");$scope.inventoryImages.push({name:image.pop(),path:item.s3_url})}),$scope.inventoryData.manufacturer_company&&($scope.inventoryData.manufacturer=$scope.inventoryData.manufacturer_company.company_name),loadCategories(),loadCities(),loadRentalPeriodTypes(),$scope.category_name=$scope.inventoryData.category_name,$scope.country=$scope.inventoryData.country,$scope.inventoryData.city&&($scope.inventoryData.city=$scope.inventoryData.city.city),$scope.inventoryData.attachments&&$scope.inventoryData.attachments.length&&($scope.inventoryData.attachments=$scope.inventoryData.attachments.map(function(item){return item.s3_url})),$scope.inventoryData.product_images&&$scope.inventoryData.product_images.length&&($scope.inventoryData.product_images=$scope.inventoryData.product_images.map(function(item){return item.s3_url}))}),$state.current.name.includes("marketDashboard.rental.add")&&($scope.inventoryData.stock_or_inventory="Rental",$scope.rentalProduct=!0),$state.current.name.includes("marketDashboard.rental.addMultipleRentals")&&($scope.rentalProduct=!0),$scope.removeInventoryFile=function(files,index){$scope.inventoryData.attachments.splice(index,1),$scope.inventoryFiles.splice(index,1)},$scope.dropDownSettings={smartButtonMaxItems:3,smartButtonTextConverter:function(itemText,originalItem){return itemText},showCheckAll:!0,showUncheckAll:!0},$scope.selectEvents={onItemSelect:function(industry){},onItemDeselect:function(industry){}},$scope.removeInventoryImg=function(img,index){$scope.inventoryData.product_images.splice(index,1),$scope.inventoryImages.splice(index,1)},IndustryService.get().then(function(data){allIndustries=data.data.results,allIndustries.map(function(item){$scope.industries.push({id:item.id,label:item.industry})})},function(error){console.log(error)}),$scope.inventoryItem?InventoryService.getOne($scope.inventoryItem[0][4]).then(function(result){$scope.inventoryData=result.data,$scope.inventoryData.industry&&allIndustries.forEach(function(industry){$scope.inventoryData.industry.map(function(item){industry.industry===item&&$scope.selectedIndustry.push({label:industry.industry,id:industry.id})})}),$scope.inventoryData.attachments&&$scope.inventoryData.attachments.forEach(function(item){var attachment=item.s3_url.split("/");$scope.inventoryFiles.push({name:attachment.pop(),path:item.s3_url})}),$scope.inventoryData.product_images&&$scope.inventoryData.product_images.forEach(function(item){var image=item.s3_url.split("/");$scope.inventoryImages.push({name:image.pop(),path:item.s3_url})}),$scope.inventoryData.product_images&&$scope.inventoryData.product_images.forEach(function(item){var image=item.s3_url.split("/");$scope.inventoryAttachments.push({name:image.pop(),path:item.s3_url})}),$scope.inventoryData.manufacturer_company&&($scope.inventoryData.manufacturer=$scope.inventoryData.manufacturer_company.company_name),loadCategories(),loadCities(),loadRentalPeriodTypes(),$scope.category_name=$scope.inventoryData.category_name,$scope.country=$scope.inventoryData.country,$scope.inventoryData.city&&($scope.inventoryData.city=$scope.inventoryData.city.city),$scope.inventoryData.attachments&&$scope.inventoryData.attachments.length&&($scope.inventoryData.attachments=$scope.inventoryData.attachments.map(function(item){return item.s3_url})),$scope.inventoryData.product_images&&$scope.inventoryData.product_images.length&&($scope.inventoryData.product_images=$scope.inventoryData.product_images.map(function(item){return item.s3_url}))}):(loadCategories(),loadCities(),loadRentalPeriodTypes()),$scope.removeInventoryFiles=function(files,index){$scope.inventoryFiles.splice(index,1)},$scope.removeInventoryImages=function(files,index){$scope.inventoryImages.splice(index,1)},$scope.cancel=function(){$state.current.name.includes("rental")?$state.go("marketDashboard.rental.list"):$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.inventory.list"):$state.go("marketDashboard.inventory.list")};var firstTime=!0;$scope.saveInventoryInfo=function(data){if(!data.title)return void Notification.error({message:"Please enter title",positionX:"right",positionY:"top"});if(!data.category_name)return void Notification.error({message:"Please select category",positionX:"right",positionY:"top"});if(!data.total_quantity)return void Notification.error({message:"Please enter total quantity",positionX:"right",positionY:"top"});if(data.discount>0&&data.premium>0)return void Notification.error({message:"Please enter either discount or premium. Not both",positionX:"right",positionY:"top"});if(!data.quantity_sold)return void Notification.error({message:"Please enter quantity sold",positionX:"right",positionY:"top"});if(!data.available_quantity)return void Notification.error({message:"Please enter available quantity",positionX:"right",positionY:"top"});if("hidePrice"==data.price&&(data.hide_price=!0,delete data.price),"unhidePrice"==data.price&&(data.hide_price=!1,delete data.price),data.product_images||(data.product_images=[]),data.attachments||(data.attachments=[]),$scope.productImages&&$scope.productImages.length&&!_productImages.length&&firstTime)return Notification.error({message:'Please click on "Upload Images" to upload the selected product images. To ignore click save again',positionX:"right",positionY:"top"}),void(firstTime=!1);if($scope.fileAttachments&&$scope.fileAttachments.length&&!_fileAttachments.length&&firstTime)return Notification.error({message:'Please click on "Upload Files" to upload the selected files. To ignore click save again',positionX:"right",positionY:"top"}),void(firstTime=!1);if(data.quantity_to_show>100)return void Notification.error({message:'Please select "Quantity to show" less than or equal to 100',positionX:"right",positionY:"top"});if(data.quantity_to_show<0)return void Notification.error({message:'Please select "Quantity to show" greater than or equal to 0',positionX:"right",positionY:"top"});if($scope.inventoryImages.length&&($scope.inventoryImages=$scope.inventoryImages.map(function(item){return item.path}),data.product_images=$scope.inventoryImages),$scope.inventoryAttachments.length&&(data.product_images=data.product_images.concat($scope.inventoryAttachments)),data.product_images.length&&(data.image_url=data.product_images[0]),_productImages.length&&(_productImages=_productImages.map(function(item){return item.url}),data.product_images?(data.product_images=data.product_images.concat(_productImages),data.image_url=_productImages[0]):(data.product_images=_productImages,data.image_url=_productImages[0])),$scope.inventoryDocs.length&&(data.attachments=$scope.inventoryDocs),$scope.inventoryFiles&&($scope.inventoryFiles=$scope.inventoryFiles.map(function(image){return image.path}),data.attachments.length?data.attachments=data.attachments.concat($scope.inventoryFiles):data.attachments=$scope.inventoryFiles),_fileAttachments.length&&(_fileAttachments=_fileAttachments.map(function(item){return item.url}),data.attachments?data.attachments=data.attachments.concat(_fileAttachments):data.attachments=_fileAttachments),$scope.selectedIndustry&&$scope.selectedIndustry.length&&($scope.selectedIndustry=$scope.selectedIndustry.filter(function(item){return 0!==item.id}),data.industry=$scope.selectedIndustry.map(function(item){if(item.id>0)return item.id})),$state.current.name.includes("adminDashboard")?data.supplier_company&&(data.supplier_company=data.supplier_company.company_name):$scope.current_user.data.company&&$scope.current_user.data.company.company_name&&(data.supplier_company=$scope.current_user.data.company.company_name),""===$scope.inventoryData.sub_category&&($scope.inventoryData.sub_category=null),""===$scope.inventoryData.sub_sub_category&&($scope.inventoryData.sub_sub_category=null),""===$scope.inventoryData.sub_sub_sub_category&&($scope.inventoryData.sub_sub_sub_category=null),data.manufacturer&&(data.manufacturer_company=data.manufacturer,delete data.manufacturer),data.id){if($scope.inventoryData.category){var newCat=categoriesData.filter(function(cat){return cat.parent_category===$scope.inventoryData.category_name&&cat.sub_category===$scope.inventoryData.sub_category&&cat.sub_sub_category===$scope.inventoryData.sub_sub_category&&cat.sub_sub_sub_category===$scope.inventoryData.sub_sub_sub_category});newCat=newCat.filter(function(x,i,a){return a.indexOf(x)==i}),newCat.length&&($scope.inventoryData.category=newCat[0].id)}if("Rental"===$scope.inventoryData.stock_or_inventory&&$scope.inventoryData.rental_period){var types=$scope.rental_period_types.filter(function(type){return type.period_type===$scope.inventoryData.rental_period});$scope.inventoryData.rental_period=types[0].id}else $scope.inventoryData.rental_period=null;data.supplier&&delete data.supplier;var productId;$scope.inventoryItem&&(productId=$scope.inventoryItem[0][4]),$stateParams.inventoryId&&(productId=$stateParams.inventoryId),InventoryService.update(productId,data).then(function(response){$state.current.name.includes("rental")?(Notification.success({message:"Successfully updated Rental",positionX:"right",positionY:"top"}),$timeout(function(){$state.go("marketDashboard.rental.list")},1500)):(Notification.success({message:"Successfully updated inventory",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("adminDashboard")?$state.go("adminDashboard.inventory.list"):$state.go("marketDashboard.inventory.list")},2500))})["catch"](function(error){$scope.errors.push(error)})}else{if("Rental"===$scope.inventoryData.stock_or_inventory&&$scope.inventoryData.rental_period){var types=$scope.rental_period_types.filter(function(type){return type.period_type===$scope.inventoryData.rental_period});$scope.inventoryData.rental_period=types[0].id}else $scope.inventoryData.rental_period=null;InventoryService.post(data).then(function(response){$state.current.name.includes("rental")?(Notification.success({message:"Successfully added Rental",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("rental")&&$state.go("marketDashboard.rental.list")},2500)):(Notification.success({message:"Successfully added inventory",positionX:"right",positionY:"top"}),$timeout(function(){$state.current.name.includes("inventory")&&($state.current.name.includes("adminDashboard")?$state.go("adminDashboard.inventory.list"):$state.go("marketDashboard.inventory.list"))},2500))})["catch"](function(error){if(400==error.status){var data=error.data;angular.forEach(data,function(value,key){"title"===key?Notification.error({message:"Title : "+value,positionX:"right",positionY:"top"}):"category_name"===key?Notification.error({message:"Category Name : "+value,positionX:"right",positionY:"top"}):"total_quantity"===key?Notification.error({message:"Total Quantity : "+value,positionX:"right",positionY:"top"}):"quantity_sold"===key?Notification.error({message:"Quantity Sold : "+value,positionX:"right",positionY:"top"}):"available_quantity"===key?Notification.error({message:"Available Quantity : "+value,positionX:"right",positionY:"top"}):Notification.error({message:key+" : "+value,positionX:"right",positionY:"top"})})}else $scope.errors.push(error)})}};var locs=[];$scope.countries=[],$scope.states=[],$scope.cities=[],$scope.selectedCountry=function(data,edit){if(data&&data.title){$scope.inventoryData.country=data.title,edit||($scope.inventoryData.state="",$scope.inventoryData.city="");var locs_temp=locs.filter(function(loc){return loc.country===data.title});locs_temp.length||($scope.showNewLocation=!0),$scope.states=locs_temp.map(function(item){if(item.state)return item.state}),$scope.states=$scope.states.filter(function(x,i,a){return a.indexOf(x)==i})}},$scope.selectedState=function(data){var locs_temp=locs.filter(function(loc){return loc.state===data});locs_temp.length||($scope.showNewLocation=!0),$scope.cities=locs_temp.map(function(item){if(item.city)return item.city})};var categoriesData=[];$scope.categories=[],$scope.subcategories=[],$scope.subsubcategories=[],$scope.subsubsubcategories=[],$scope.selectedCategory=function(data,edit){if(data&&data.title){$scope.inventoryData.category_name=data.title,edit||($scope.inventoryData.sub_category="",$scope.inventoryData.sub_sub_category="",$scope.inventoryData.sub_sub_sub_category="");var category_temp=categoriesData.filter(function(categoryData){return categoryData.parent_category===data.title&&null!=categoryData.sub_category});$scope.subcategories=category_temp.map(function(item){return item.sub_category}),$scope.subcategories=$scope.subcategories.filter(function(x,i,a){return a.indexOf(x)==i})}},$scope.selectedSubCategory=function(data){var category_temp=categoriesData.filter(function(categoryData){return categoryData.sub_category===data&&null!=categoryData.sub_sub_category});$scope.subsubcategories=category_temp.map(function(item){if(item.sub_sub_category)return item.sub_sub_category}),$scope.subsubcategories=$scope.subsubcategories.filter(function(x,i,a){return a.indexOf(x)==i})},$scope.selectedSubSubCategory=function(data){var category_temp=categoriesData.filter(function(categoryData){return categoryData.sub_sub_category===data&&null!=categoryData.sub_sub_sub_category});$scope.subsubsubcategories=category_temp.map(function(item){if(item.sub_sub_sub_category)return item.sub_sub_sub_category})};var _productImages=[],_fileAttachments=[];if($scope.uploadFiles=function(files,type){$scope.saveFile=!0,$scope.disabled=!0,_fileAttachments=[],$scope.filesLength=files.length,files.forEach(function(file){uploadMultipleFilesFn(file,type)}),files=[]},$scope.removeFile=function(files,index){$scope.saveFile||($scope.fileAttachments.splice(index,1),_fileAttachments.splice(index,1),$scope.fileAttachments.length||($scope.disabled=!1))},$scope.removeImg=function(img,index){$scope.saveImages||($scope.productImages.splice(index,1),_productImages.splice(index,1),$scope.productImages.length||($scope.disabled=!1))},$scope.AddImages=function(){var file={};file.remove=!0,$scope.inventoryImg.push(file)},!$scope.inventoryImg.length){var file={};file.add=!0,$scope.inventoryImg.push(file)}if($scope.uploadInventories=function(file,$index,type){var path="user/"+$scope.current_user.data.id+"/inventory/multiFile";s3Service.uploadFile(path,file,function(url){url&&("product-images"==type?($scope.inventoryAttachments.push(url),document.getElementById("inventory-image").value=null):($scope.inventoryDocs.push(url),document.getElementById("inventory-doc").value=null),$scope.$apply(),Notification.success({message:"Successfully uploaded file",positionX:"right",positionY:"top"}))})},$scope.removeImages=function(files,index){files.splice(index,1),_productImages.splice(index,1)},!$scope.documents.length){var file={};file.add=!0,$scope.documents.push(file)}$scope.addDocuments=function(){var file={};file.remove=!0,$scope.documents.push(file)},$scope.removeDocuments=function(files,index){files.splice(index,1),_fileAttachments.splice(index,1)}}])}();