"use strict";!function(){var app=angular.module("app");app.controller("layout.standard.SOItemController",["$scope","$window","$mdDialog","$log","$state","Notification","MessageService","$http","s3Service","dateService","$rootScope","$timeout","$stateParams","$dialogScope","$filter","SalesOrderService",function($scope,$window,$mdDialog,$log,$state,Notification,MessageService,$http,s3Service,dateService,$rootScope,$timeout,$stateParams,$dialogScope,$filter,SalesOrderService){function getRowId(row){return row.id}function inWords(num){var str;if((num=num.toString()).length>9)return"overflow";var n=("000000000"+num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);if(n){var str="";return str+=0!=n[1]?(a[Number(n[1])]||b[n[1][0]]+" "+a[n[1][1]])+"crore ":"",str+=0!=n[2]?(a[Number(n[2])]||b[n[2][0]]+" "+a[n[2][1]])+"lakh ":"",str+=0!=n[3]?(a[Number(n[3])]||b[n[3][0]]+" "+a[n[3][1]])+"thousand ":"",str+=0!=n[4]?(a[Number(n[4])]||b[n[4][0]]+" "+a[n[4][1]])+"hundred ":"",str+=0!=n[5]?(""!=str?"and ":"")+(a[Number(n[5])]||b[n[5][0]]+" "+a[n[5][1]])+"only ":""}}function UpdateSalesAmount(){var totalSalesCost=null,itemsInfo={};SalesOrderService.getSOItems({soId:$dialogScope.SOId}).then(function(data){if(data.data.results.length){$scope.totalLength=data.data.results.length;var currency=data.data.results[0].currency;if($scope.disableDelete){var result=[];$scope.items.map(function(item){item.checked||result.push(item)}),$scope.items=result,$scope.uiGridOptions.data=result,savedItems=$scope.items}data.data.results.map(function(item){item.total_price&&(currency=item.currency,totalSalesCost=totalSalesCost?parseInt(totalSalesCost)+parseInt(item.total_price):item.total_price)});var priceWords=inWords(totalSalesCost);SalesOrderService.update($dialogScope.SOId,{price_number:totalSalesCost,currency:currency,price_words:priceWords}).then(function(res){$scope.orderInfo=res.data,$scope.disableDelete?(Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}),$scope["delete"]=!0,$scope.disableDelete=!1):(Notification.success({message:"Successfully saved",positionX:"right",positionY:"top"}),$scope.disableSave=!1,itemsInfo.SOData=res.data,"add"==$dialogScope.type&&(itemsInfo.count=savedItems.length,itemsInfo.savedItems=savedItems,itemsInfo.totalLength=$scope.totalLength,$mdDialog.hide(itemsInfo)),"edit"==$dialogScope.type&&(itemsInfo.savedItems=$scope.items,itemsInfo.totalLength=$scope.totalLength,itemsInfo.count=itemsInfo.savedItems.length,$mdDialog.hide(itemsInfo)))},function(error){$scope.disableSave=!1})}else $scope.totalLength=data.data.results.length,$scope.items=[],$scope.uiGridOptions.data=result,savedItems=$scope.items,totalSalesCost=0,currency=null,priceWords=null,SalesOrderService.update($dialogScope.SOId,{price_number:totalSalesCost,currency:currency,price_words:priceWords}).then(function(res){$scope.disableDelete?(Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}),$scope["delete"]=!0,$scope.disableDelete=!1):(Notification.success({message:"Successfully saved",positionX:"right",positionY:"top"}),$scope.disableSave=!1,itemsInfo.SOData=res.data,"edit"==$dialogScope.type&&(itemsInfo.showTotal=!1,itemsInfo.savedItems=$scope.items,itemsInfo.count=itemsInfo.savedItems.length,itemsInfo.totalLength=$scope.totalLength,$mdDialog.hide(itemsInfo)))})})}$scope.showDelete=$dialogScope["delete"],$scope.saveItem=$dialogScope.save,$scope.SOData=[],$scope.type=$dialogScope.type,$scope.items=angular.copy($dialogScope.items),$scope.items=_.sortBy($scope.items,"displayId");var savedItems;$scope.disableSave=!1,$scope.disableUpdate=!1,$scope.disableDelete=!1,$scope["delete"]=!1,$scope.selectedItems=function(entity){entity.checked=!0},$scope.uiGridOptions={data:$scope.items,enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,rowIdentity:getRowId,getRowIdentity:getRowId,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},columnDefs:[{name:"checked",displayName:"",cellTemplate:'<input type="checkbox" ng-model="row.entity.checked">',visible:$dialogScope.showCheckbox},{name:"displayId",displayName:"S No#",width:65,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,visible:$dialogScope.showCheckbox},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"customer_po_number",displayName:"Customer PO S.No",width:200,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"buyer_part_number",displayName:"Buyer part Number",width:200,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"supplier_part_number",displayName:"Supplier Part Number",width:200,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"quantity_ordered",displayName:"Quantity Ordered",width:200,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"unit_measure",displayName:"Unit Of Measure",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"unit_price",displayName:"Unit Price",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"price_basis",displayName:"Price Basis",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"delivery_date",displayName:"Delivery Date",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"delivery_basis",displayName:"Delivery Basis",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"vat",displayName:"VAT",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"other_charges",displayName:"Other Charges",width:200,pinnedLeft:!0,enableCellEdit:!0}],onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi,$scope.gridApi.edit.on.afterCellEdit($scope,function(rowEntity,colDef,newValue,oldValue){if("quantity_ordered"==colDef.name&&rowEntity.unit_price&&(rowEntity.total_price=parseInt(newValue)*parseInt(rowEntity.unit_price)),"unit_price"==colDef.name&&rowEntity.quantity_ordered&&(rowEntity.total_price=parseInt(newValue)*parseInt(rowEntity.quantity_ordered)),newValue!=oldValue){var data=newValue;if(data=!data){newValue=null;var name=colDef.field;rowEntity[name]=newValue}if(("cgst"==colDef.field||"sgst"==colDef.field)&&(rowEntity.vat=0,newValue>10)){var name=colDef.field;rowEntity[name]=0,Notification.error({message:"Please enter gst value less than 10",positionX:"right",positionY:"top"})}if("vat"==colDef.field&&(rowEntity.sgst=0,rowEntity.cgst=0,newValue>10)){var name=colDef.field;rowEntity[name]=0,Notification.error({message:"Please enter vat value less than 10",positionX:"right",positionY:"top"})}rowEntity.state=!0}})}},$scope.cancel=function(){$scope["delete"]?($scope.items=$scope.items.map(function(item){return item.state&&$dialogScope.items.map(function(info){info.id==item.id&&(item=info)}),item}),$mdDialog.hide({savedItems:$scope.items,SOData:$scope.orderInfo,totalLength:$scope.totalLength,exisitingItemsCount:$scope.items.length})):$mdDialog.cancel()},$scope.AddDetails=function(ev,type){var arr=[];return $scope.items.map(function(item){item.checked&&item.id&&arr.push(item)}),arr&&arr.length?$mdDialog.show({controller:"layout.standard.annexureDetails",templateUrl:"assets/js/modules/po/orders/annexure-details/annexure-details.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{type:type}}}).then(function(data){data&&($scope.items=$scope.items.map(function(info){return info.checked&&(data.sgst&&(info.sgst=data.sgst,info.vat=null),data.cgst&&(info.cgst=data.cgst,info.vat=null),data.igst&&(info.igst=data.igst),data.vat&&(info.vat=data.vat,info.sgst=null,info.cgst=null),data.selected_quantity&&(info.quantity_ordered=data.selected_quantity),data.unitPrice&&(info.unit_price=data.unitPrice),data.deliveryDate&&(info.delivery_date=dateService.convertDateToPython(data.deliveryDate)),info.quantity_ordered&&info.unit_price&&(info.total_price=parseInt(info.quantity_ordered)*parseInt(info.unit_price)),data.other_charges&&(info.other_charges=data.other_charges),info.state=!0),info}))},function(err){}):(Notification.error({message:"Please select items to add details",positionX:"right",positionY:"top"}),void(error=!0))},$scope.saveSO=function(){$scope.disableSave=!0;var error;$scope.items=$scope.items.map(function(item){if(error)return void($scope.disableSave=!1);if(!item.unit_measure)return Notification.error({message:"Please Enter Unit Measure",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1);if(!item.unit_price)return Notification.error({message:"Please Enter Unit Price",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1);if(!item.quantity_ordered)return Notification.error({message:"Please Enter Selected Quantity",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1);if(!item.delivery_date)return Notification.error({message:"Please Enter Delivery date",positionX:"right",positionY:"top"}),error=!0,void($scope.disableSave=!1);var totalTax=0;item.vat&&(totalTax=Number(item.vat)),item.other_charges&&(totalTax?totalTax+=Number(item.other_charges):totalTax=Number(item.other_charges)),item.delivery_date.includes("-")&&(item.delivery_date=item.delivery_date.split("-").join("/"));var total=Number(item.unit_price)*Number(item.quantity_ordered),value=(total*(totalTax/100)).toFixed(2);return item.total_price_with_tax=Number(total)+Number(value),item}),error||SalesOrderService.saveSOItems($scope.items).then(function(res){savedItems=res.data,UpdateSalesAmount()},function(err){$scope.disableSave=!1})},$scope.checkAll=function(value){value?$scope.items=$scope.items.map(function(item){return item.checked=!1,item}):$scope.items=$scope.items.map(function(item){return item.checked=!0,item})};var a=["","one ","two ","three ","four ","five ","six ","seven ","eight ","nine ","ten ","eleven ","twelve ","thirteen ","fourteen ","fifteen ","sixteen ","seventeen ","eighteen ","nineteen "],b=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];$scope.updateItems=function(){$scope.disableUpdate=!0;var error,editedItems=[],arr=[];if($scope.items.map(function(item){if(item.state||item.checked){if(error)return void($scope.disableUpdate=!1);if(!item.unit_measure)return Notification.error({message:"Please Enter Unit Measure",positionX:"right",positionY:"top"}),error=!0,void($scope.disableUpdate=!1);if(!item.unit_price)return Notification.error({message:"Please Enter Unit Price",positionX:"right",positionY:"top"}),error=!0,void($scope.disableUpdate=!1);if(!item.quantity_ordered)return Notification.error({message:"Please Enter Selected Quantity",positionX:"right",positionY:"top"}),error=!0,void($scope.disableUpdate=!1);if(!item.delivery_date)return Notification.error({message:"Please Enter Delivery date",positionX:"right",positionY:"top"}),error=!0,void($scope.disableUpdate=!1);editedItems.push(item)}}),editedItems.length)editedItems.map(function(soItem){SalesOrderService.updateSOItems(soItem.id,soItem).then(function(resp){arr.push(resp.data),editedItems.length==arr.length&&UpdateSalesAmount()})},function(error){$scope.disableUpdate=!1});else if(error)return void($scope.disableUpdate=!1)},$scope.deleteItems=function(){var deletedData=[],arr=[];return $scope.items.map(function(item){item.checked&&deletedData.push(item)}),deletedData.length?($scope.disableDelete=!0,void deletedData.map(function(data){SalesOrderService.deleteSOItems(data.id).then(function(resp){arr.push(resp.data),deletedData.length==arr.length&&UpdateSalesAmount()},function(err){$scope.disableDelete=!1})})):void Notification.error({message:"Please select items to delete",positionX:"right",positionY:"top"})}}]).controller("layout.standard.SOViewItems",["$scope","$window","$mdDialog","$log","$state","Notification","MessageService","$http","s3Service","dateService","$rootScope","$timeout","$stateParams","$dialogScope","$filter","SalesOrderService",function($scope,$window,$mdDialog,$log,$state,Notification,MessageService,$http,s3Service,dateService,$rootScope,$timeout,$stateParams,$dialogScope,$filter,SalesOrderService){$scope.saveItem=!0,$scope.showDelete=!1,$scope.uiGridOptions={data:$dialogScope.items,enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},columnDefs:[{name:"id",displayName:"#",width:50,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"notes",displayName:"Buyer PO S.No",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"buyer_part_number",displayName:"Buyer part Number",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"supplier_part_number",displayName:"Supplier Part Number",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"quantity_ordered",displayName:"Quantity Ordered",width:200,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"unit_measure",displayName:"Unit Of Measure",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"unit_price",displayName:"Unit Price",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"price_basis",displayName:"Price Basis",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"delivery_date",displayName:"Delivery Date",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"delivery_basis",displayName:"Delivery Basis",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"vat",displayName:"VAT",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"other_charges",displayName:"Other Charges",width:200,pinnedLeft:!0,enableCellEdit:!1}],onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},$scope.cancel=function(){$mdDialog.cancel()}}])}();