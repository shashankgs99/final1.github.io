"use strict";!function(){angular.module("app").controller("layout.salesOrder.ViewSO",["$scope","$window","$modal","$log","$state","Notification","InvoiceService","$http","POService","OfferService","dateService","$rootScope","$stateParams","SalesOrderService","$mdDialog","$q",function($scope,$window,$modal,$log,$state,Notification,InvoiceService,$http,POService,OfferService,dateService,$rootScope,$stateParams,SalesOrderService,$mdDialog,$q){function getRowId(row){return row.id}function cashflows(){InvoiceService.get({soId:$stateParams.soId}).then(function(res){$scope.soInvoices=res.data.results,$scope.soInvoiceItems=res.data.results;var pendingItems=[],pendingItemsValue=0,completedItemsValue=0,paymentspendingValue=0,installmentsItems=[],value=0;if($scope.soInvoices.length){var installmentsFilter=_.groupBy($scope.soInvoices,function(item){return item.installment}),existInstallments=[],createdInstallments=[];$scope.SOInstallments.map(function(item){existInstallments.push(Number(item.id))});for(var i in installmentsFilter)createdInstallments.push(Number(i));var diff=_.differenceWith(existInstallments,createdInstallments,_.isEqual);diff&&diff.length&&diff.map(function(a){var installment=_.find($scope.SOInstallments,{id:a});$scope.existingSOItems.map(function(item){var obj={};if(installment&&installment.expected_milestone_date)var expectedDate=dateService.convertDateToJS(installment.expected_milestone_date);var result=expectedDate.addDays(installment.credit);obj.payment_date=dateService.convertDateToPython(result),obj.value=item.total_price*(Number(installment.percentage)/100),obj.currency=$scope.order.currency,obj.title=item.title,obj.type=installment.type,obj.s_no=item.item_number.split("-").pop().split("_").pop(),value=value?Number(obj.value)+Number(value):Number(obj.value),installmentsItems.push(angular.copy(obj))})}),console.log(diff);var result=_.groupBy($scope.soInvoices,function(item){return item.invoice_state.name});console.log(result);for(var key in result)if("Created"==key|"Partially Received"==key|"Received"==key){var arr=result[key];arr.map(function(item){$scope.pendingPaymentList=$scope.pendingPaymentList.concat(item.invoice_items),item.invoice_items&&item.invoice_items.length&&item.invoice_items.map(function(rec){var price=Number(rec.quantity)*Number(rec.item_price);pendingItemsValue?pendingItemsValue+=price:pendingItemsValue=price,rec.so_item.installment_item_details&&rec.so_item.installment_item_details.length&&rec.so_item.installment_item_details.map(function(ins){if(ins.invoiced_quantity<ins.total_quantity){var obj={},installment=_.find($scope.SOInstallments,{id:ins.installment});if(obj.type=installment.type,obj.title=rec.so_item.title,installment&&installment.expected_milestone_date)var expectedDate=dateService.convertDateToJS(installment.expected_milestone_date);var result=expectedDate.addDays(installment.credit);obj.payment_date=dateService.convertDateToPython(result),obj.value=rec.so_item.total_price*(Number(installment.percentage)/100),obj.currency=$scope.order.currency,obj.s_no=rec.so_item.item_number.split("-").pop().split("_").pop(),value=value?Number(obj.value)+Number(value):Number(obj.value),pendingItems.push(obj)}})})}),$scope.pendingPaymentList.total_price=pendingItemsValue}else if("Completed"==key){var arr=result[key];arr.map(function(item){$scope.paidPaymentData=$scope.paidPaymentData.concat(item.invoice_items),item.invoice_items&&item.invoice_items.length&&item.invoice_items.map(function(rec){var price=Number(rec.quantity)*Number(rec.item_price);completedItemsValue?completedItemsValue+=price:completedItemsValue=price,rec.so_item.installment_item_details&&rec.so_item.installment_item_details.length&&rec.so_item.installment_item_details.map(function(ins){if(ins.invoiced_quantity<ins.total_quantity){var obj={},installment=_.find($scope.SOInstallments,{id:ins.installment});if(obj.type=installment.type,obj.title=rec.so_item.title,installment&&installment.expected_milestone_date)var expectedDate=dateService.convertDateToJS(installment.expected_milestone_date);var result=expectedDate.addDays(installment.credit);obj.payment_date=dateService.convertDateToPython(result),obj.value=rec.so_item.total_price*(Number(installment.percentage)/100),obj.currency=$scope.order.currency,obj.s_no=rec.so_item.item_number.split("-").pop().split("_").pop(),value=value?Number(obj.value)+Number(value):Number(obj.value),pendingItems.push(obj)}})})}),$scope.paidPaymentData.total_price=completedItemsValue}}else{var value=0,data=[];$scope.SOInstallments&&$scope.SOInstallments.length&&$scope.existingSOItems&&$scope.existingSOItems.length&&($scope.SOInstallments.map(function(installment){$scope.existingSOItems.map(function(item){var obj={};if(installment&&installment.expected_milestone_date)var expectedDate=dateService.convertDateToJS(installment.expected_milestone_date);var result=expectedDate.addDays(installment.credit);obj.payment_date=dateService.convertDateToPython(result),obj.value=item.total_price*(Number(installment.percentage)/100),obj.currency=$scope.order.currency,obj.title=item.title,obj.type=installment.type,obj.s_no=item.item_number.split("-").pop().split("_").pop(),value=value?Number(obj.value)+Number(value):Number(obj.value),data.push(angular.copy(obj))})}),$scope.PaymentsExpectedList=data,$scope.PaymentsExpectedList.total_price=value)}$scope.PaymentsExpectedList=$scope.PaymentsExpectedList.concat(pendingItems,installmentsItems),$scope.PaymentsExpectedList.map(function(record){paymentspendingValue?paymentspendingValue+=Number(record.value):paymentspendingValue=Number(record.value)}),$scope.PaymentsExpectedList.total_price=paymentspendingValue})}function OpenTemplate(data){var content=window.open("","newWindow","width=1200,height=800");content.document.body.innerHTML=data}$scope.paidPaymentData=[],$scope.pendingPaymentList=[],$scope.PaymentsExpectedList=[],SalesOrderService.getInstallments({so:$stateParams.soId}).then(function(res){$scope.SOInstallments=res.data.results}),Date.prototype.addDays=function(days){var date=new Date(this.valueOf());return date.setDate(date.getDate()+days),date},$scope.PLItems={enableCellEditOnFocus:!0,enableColumnResizing:!0,enableFiltering:!0,enableGridMenu:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,rowIdentity:getRowId,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},columnDefs:[{name:"index",displayName:"#",width:50,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"details",displayName:"Details",width:200,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"quantity",displayName:"Quantity",width:150,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"units",displayName:"Units",width:150,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"packing",displayName:"Packing",width:150,pinnedLeft:!0,enableCellEdit:!0,enableSorting:!0},{field:"dimensions",displayName:"Dimensions",width:150,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"net_weight",displayName:"Net Weight",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"gross_weight",displayName:"Gross Weight",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"remarks",displayName:"Remarks",width:150,pinnedLeft:!0,enableCellEdit:!0},{field:"invoice",displayName:"invoice",width:150,pinnedLeft:!0,enableCellEdit:!0}],onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},SalesOrderService.getpackingItems({so:$stateParams.soId}).then(function(res){$scope.packingItems=res.data.results,$scope.PLItems.data=$scope.packingItems,$scope.PLItems.data=$scope.PLItems.data.map(function(item,$index){return item.index=$index+1,item})}),$stateParams.soId&&$q.all([SalesOrderService.getOne($stateParams.soId),SalesOrderService.getSOItems({soId:$stateParams.soId})]).then(function(result){result[0].data&&($scope.order=result[0].data,$scope.order.so_reference.length>150?($scope.readMore=!1,$scope.showContent()):$scope.myObj={"overflow-wrap":"break-word","text-align":"justify"},$scope.order&&$scope.order.so_description&&$scope.order.so_description.length>150?($scope.readDesc=!1,$scope.showDescription()):$scope.description={"overflow-wrap":"break-word","text-align":"justify"}),result[1].data.results.length&&($scope.existingSOItems=result[1].data.results,$scope.uiGridOptions.data=$scope.existingSOItems,$scope.uiGridOptions.data=$scope.uiGridOptions.data.map(function(item){return item.displayId=item.item_number.split("-").pop().split("_").pop(),item}),$scope.uiGridOptions.data=_.sortBy($scope.uiGridOptions.data,"displayId"),cashflows())}),POService.getPOStatus().then(function(result){$scope.soStatus=result.data.results}),$scope.viewPaymentDetails=function(ev,data,type){var items=angular.copy(data);return delete items.total_price,$mdDialog.show({controller:"layout.standard.viewPaymentRequestItems",templateUrl:"assets/js/modules/po/payment-request/view-payment-items/view-payment-items.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{type:type,data:items,order:$scope.order,SOInstallments:$scope.SOInstallments}}})},$scope.changeStatus=function(type,order){var data={};$scope.soStatus.map(function(item){item.name==type&&(data.so_status=item.id)}),SalesOrderService.update(order.id,data).then(function(res){Notification.success({message:"successfully "+type,positionX:"right",positionY:"top"})})},$scope.showContent=function(){return $scope.readMore?($scope.readMore=!$scope.readMore,$scope.myObj={},void($scope.myObj={overflow:"visible",height:"auto","overflow-wrap":"break-word","text-align":"justify"})):$scope.readMore?void 0:($scope.readMore=!$scope.readMore,$scope.myObj={},void($scope.myObj={height:"44px","overflow-wrap":"break-word",overflow:"hidden","text-align":"justify"}))},$scope.showDescription=function(){return $scope.readDesc?($scope.readDesc=!$scope.readDesc,$scope.description={},void($scope.description={overflow:"visible",height:"auto","overflow-wrap":"break-word","text-align":"justify"})):$scope.readDesc?void 0:($scope.readDesc=!$scope.readDesc,$scope.description={},void($scope.description={height:"44px","overflow-wrap":"break-word",overflow:"hidden","text-align":"justify"}))},$scope.EditOrder=function(data){$state.go("supplierDashboard.SO.edit",{soId:data.id})},$scope.GenerateInvoice=function(res){$state.go("supplierDashboard.invoice.create",{SO:res})},$scope.PrintSO=function(info){var data=info,soData={so_number:data.so_number,so_date:data.so_date,supplier_name:data.supplier_name,supplier_address:{addressline1:data.supplier_address.addressline1,addressline2:data.supplier_address.addressline2,cityname:data.supplier_address.cityname,state:data.supplier_address.state,country:data.supplier_address.country},supplier_contact_name:data.supplier_contact_name,supplier_contact_mobile:data.supplier_contact_mobile,supplier_contact_email:data.supplier_contact_email,buyer_company:data.buyer_company,buyer_logo:$scope.current_user.data.company.logo,buyer_contact_name:data.buyer_contact_name,buyer_contact_mobile:data.buyer_contact_mobile,buyer_contact_email:data.buyer_contact_email,created:data.created,so_reference:data.so_reference,so_description:data.so_description.slice(0,200)+"......",projectName:data.project.name,price_number:data.price_number.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),price_basis:data.price_basis.slice(0,50)+".......",delivery_basis:data.delivery_basis.slice(0,50)+".......",delivery_date:data.delivery_date,price_words:data.price_words,lc:data.lc,currency:data.currency,authorized_by:data.authorized_by,edit_notes:data.edit_notes};$scope.current_user&&$scope.current_user.data&&$scope.current_user.data.company&&$scope.current_user.data.company.addresses&&(soData.buyer_address={addressline1:$scope.current_user.data.company.addresses[0].addressline1,addressline2:$scope.current_user.data.company.addresses[0].addressline2,cityname:$scope.current_user.data.company.addresses[0].cityname,state:$scope.current_user.data.company.addresses[0].state,country:$scope.current_user.data.company.addresses[0].country}),SalesOrderService.getSOItems({soId:data.id}).then(function(item){var results=item.data.results;soData.items=results;var totalVat;if(soData.items.map(function(item){var total=null;item.vat>0&&!total&&(total=item.vat,totalVat?totalVat+=parseFloat(item.vat):totalVat=parseFloat(item.vat))}),totalVat){soData.totalVat=totalVat;var totalVatValue=(data.price_number*(totalVat/100)).toFixed(2);soData.totalVatValue=totalVatValue,soData.totalAmount=(parseFloat(data.price_number)+parseFloat(totalVatValue)).toFixed(2)}var body={soData:soData};$http.post("/backend/print-so/",body).then(function(response){$scope.tempalte=response.data,OpenTemplate($scope.tempalte),Notification.success({message:"Successfully Printed",positionX:"right",positionY:"top"})})["catch"](function(error){Notification.error({message:"Not Successfully Printed",positionX:"right",positionY:"top"})})})},$scope.uiGridOptions={enableCellEditOnFocus:!0,enableFiltering:!0,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},columnDefs:[{name:"displayId",displayName:"S.No#",width:75,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"customer_po_number",displayName:"Customer PO S.No#",width:100,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"quantity_ordered",displayName:"Quantity",width:125,pinnedLeft:!0,enableSorting:!0,enableCellEdit:!1},{field:"unit_measure",displayName:"Unit Of Measure",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"unit_price",displayName:"Unit Price",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"total_price",displayName:"Total Price",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"vat",displayName:"VAT",width:80,pinnedLeft:!0,enableCellEdit:!1},{field:"total_price_with_tax",displayName:"Total Price(Inc Taxes)",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"delivery_date",displayName:"Delivery Date",width:100,pinnedLeft:!0,enableCellEdit:!1},{field:"price_basis",displayName:"Price Basis",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"delivery_basis",displayName:"Delivery Basis",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"buyer_part_number",displayName:"Buyer part Number",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"supplier_part_number",displayName:"Supplier Part Number",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0}],onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},$scope.Viewinvoice=function(data){$state.go("supplierDashboard.invoice.view",{invoiceId:data.id})},$scope.ListPage=function(data){$state.go("supplierDashboard.SO.list")}}])}();