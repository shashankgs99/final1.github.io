"use strict";!function(){var app=angular.module("app");app.controller("SalesOrderController",["$scope","$q","$log","$state","$http","$mdDialog","dateService","Notification","$stateParams","SalesOrderService","POService","ProjectService","CustomerService","CsvService","CompanyService","UserService",function($scope,$q,$log,$state,$http,$mdDialog,dateService,Notification,$stateParams,SalesOrderService,POService,ProjectService,CustomerService,CsvService,CompanyService,UserService){function LoadSOData(){$q.all([SalesOrderService.getOne($stateParams.soId),SalesOrderService.getSOItems({soId:$stateParams.soId})]).then(function(result){result[0].data&&($scope.order=result[0].data,$scope.existingItemsPrice=$scope.order.price_number,$scope.order.price_number>0&&($scope.disableCurrency=!0),$scope.order.so_supply_type=$scope.order.so_supply_type.id,$scope.order.project=$scope.order.project.id,$scope.subProject($scope.order.project,!0),$scope.order.buyer_company&&$scope.customers.length&&$scope.customers.map(function(cust){cust.id==$scope.order.buyer_company&&$scope.FilterBuyerDetails(cust)}),$scope.current_user.data&&$scope.current_user.data.company&&($scope.current_user.data.company.id==$scope.order.supplier_company?UserService.get({company:$scope.current_user.data.company.id}).then(function(data){data.data.results.length&&(FilterContacts({contact:data.data.results,addresses:data.data.results[0].company.addresses}),FetchOrderDetails())}):UserService.get({company:$scope.order.supplier_company}).then(function(data){data.data.results.length&&(FilterContacts({contact:data.data.results,addresses:data.data.results[0].company.addresses}),FetchOrderDetails())}))),result[1].data.results.length&&($scope.existingSOItems=result[1].data.results,$scope.totalItemsCount=$scope.existingSOItems.length,$scope.itemsLength=$scope.existingSOItems.length,$scope.currency=result[1].data.results[0].currency),$scope.showLoader=!1})}function inWords(num){var str;if((num=num.toString()).length>9)return"overflow";var n=("000000000"+num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);if(n){var str="";return str+=0!=n[1]?(a[Number(n[1])]||b[n[1][0]]+" "+a[n[1][1]])+"crore ":"",str+=0!=n[2]?(a[Number(n[2])]||b[n[2][0]]+" "+a[n[2][1]])+"lakh ":"",str+=0!=n[3]?(a[Number(n[3])]||b[n[3][0]]+" "+a[n[3][1]])+"thousand ":"",str+=0!=n[4]?(a[Number(n[4])]||b[n[4][0]]+" "+a[n[4][1]])+"hundred ":"",str+=0!=n[5]?(""!=str?"and ":"")+(a[Number(n[5])]||b[n[5][0]]+" "+a[n[5][1]])+"only ":""}}function FilterContacts(data){$scope.suppliersContact=[],$scope.supplierAddress=[];var suppliersInfo=data.contact,contactAddress=data.addresses;suppliersInfo.length&&suppliersInfo.forEach(function(item){var name;item.firstname&&(name=item.firstname),item.first_name&&(name=item.first_name),item.lastname&&(name+=item.lastname),item.last_name&&(name+=item.last_name),name&&(item.fullName=name),$scope.suppliersContact.push(item),$scope.order&&$scope.order.authorized_by&&$scope.suppliersContact.map(function(item){item.fullName==$scope.order.authorized_by&&($scope.order.authorizedBy=item)})}),contactAddress.length&&(contactAddress.map(function(data){var address;data.nameofaddress&&(address=data.nameofaddress),data.addressline1&&(address?address+=","+data.addressline1:address=data.addressline1),data.addressline2&&(address?address+=","+data.addressline2:address=data.addressline2),data.city&&(address?address+=","+data.city:address=data.city),data.state&&(address?address+=","+data.state:address=data.state),data.country&&(address?address+=","+data.country:address=data.country),$scope.supplierAddress.push({address:address,id:data.id})}),$stateParams.soId&&$scope.order&&($scope.order.supplier_address=$scope.order.supplier_address.id))}function FetchOrderDetails(){$scope.order.so_date&&($scope.order.soDate=dateService.convertDateToJS($scope.order.so_date)),$scope.order.delivery_date&&($scope.order.deliveryDate=dateService.convertDateToJS($scope.order.delivery_date)),$scope.order.supplier_contact_name&&$scope.suppliersContact.length&&$scope.suppliersContact.map(function(item){item.fullName==$scope.order.supplier_contact_name&&($scope.order.supplierContactName=item)}),$scope.order.buyer_company&&$scope.customers.length&&$scope.customers.map(function(item){item.id==$scope.order.buyer_company&&($scope.order.customer=item)}),$scope.order.buyer_contact_name&&$scope.buyerContact.length&&$scope.buyerContact.map(function(item){item.fullName==$scope.order.buyer_contact_name&&($scope.order.buyer_contact=item)}),$scope.order.authorized_by&&$scope.suppliersContact.map(function(item){item.fullName==$scope.order.authorized_by&&($scope.order.authorizedBy=item)})}function UpdateSalesAmount(type){var currency,totalSalesCost=null;SalesOrderService.getSOItems({soId:$scope.order.id}).then(function(data){if(data.data.results.length){$scope.totalItemsCount=data.data.results.length,data.data.results.map(function(item){item.total_price&&(currency=item.currency,totalSalesCost=totalSalesCost?parseInt(totalSalesCost)+parseInt(item.total_price):item.total_price)});var priceWords=inWords(totalSalesCost);SalesOrderService.update($scope.order.id,{price_number:totalSalesCost,currency:currency,price_words:priceWords}).then(function(res){$scope.order=res.data,$scope.disabledData=!1,$scope.disableImport=!1,type?Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}):Notification.success({message:"Successfully saved",positionX:"right",positionY:"top"})})}else $scope.totalItemsCount=0,$scope.existingSOItems=[],totalSalesCost=0,currency=null,priceWords=null,SalesOrderService.update($scope.order.id,{price_number:totalSalesCost,currency:currency,price_words:priceWords}).then(function(res){type?Notification.success({message:"Successfully deleted",positionX:"right",positionY:"top"}):Notification.success({message:"Successfully saved",positionX:"right",positionY:"top"}),$scope.disableCurrency=!1,$scope.order=res.data})})}$scope.showLoader=!0,$scope.SOTypes=[],$scope.projectNames=[],$scope.fileList=[],$scope.uploadedFilesList=[],$scope.order={},$scope.disabledOrder=!1,$scope.disabledData=!1,$scope.disableImport=!1,$scope.existingSOItems=[];var fileName;$scope.payment={};var currentData=[];$scope.showLoader=!1,$scope.disableSave=!1,$scope.disableCurrency=!1,$stateParams.soId||($scope.title="Create"),$stateParams.soId&&($scope.showLoader=!0),$q.all([POService.getPOType(),POService.getSupplyTypes(),ProjectService.getMainProjects(),CustomerService.get()]).then(function(result){$stateParams.soId&&LoadSOData(),result[0].data.results&&($scope.SOTypes=result[0].data.results),result[1].data.results&&($scope.supplyTypes=result[1].data.results),result[2].data&&($scope.projectsInfo=result[2].data,$scope.projectsInfo.forEach(function(item){$scope.projectNames.push({id:item.id,label:item.name})}),$scope.projectNames=_.uniqBy($scope.projectNames,"id")),result[3].data.results&&($scope.customers=result[3].data.results)}),CompanyService.getCurrencyType().then(function(data){$scope.currencyTypeList=data.data.results},function(err){console.log(err)}),$scope.current_user.data&&$scope.current_user.data.company&&!$stateParams.soId&&($scope.order.supplier_name=$scope.current_user.data.company.company_name,$scope.order.supplier_company=$scope.current_user.data.company.id,UserService.get({company:$scope.current_user.data.company.id}).then(function(data){data.data.results.length&&FilterContacts({contact:data.data.results,addresses:data.data.results[0].company.addresses})}));var a=["","one ","two ","three ","four ","five ","six ","seven ","eight ","nine ","ten ","eleven ","twelve ","thirteen ","fourteen ","fifteen ","sixteen ","seventeen ","eighteen ","nineteen "],b=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];$scope.subProject=function(project,value){$scope.subProjectNames=[],value||($scope.order.sub_project=null),ProjectService.getSubProjects(project).then(function(data){$scope.sub_projects=data.data,$scope.sub_projects&&($scope.sub_projects.forEach(function(item){$scope.subProjectNames.push({id:item.id,label:item.name})}),$stateParams.soId&&$scope.order.sub_project&&($scope.order.sub_project=$scope.order.sub_project.id))})},$scope.supplierDetails=function(contact){contact.phonenumber1&&($scope.order.supplier_contact_mobile=contact.phonenumber1),$scope.order.supplier_contact_mobile||contact.phonenumber2&&($scope.order.supplier_contact_mobile=contact.phonenumber2),contact.emailid1&&($scope.order.supplier_contact_email=contact.emailid1),$scope.order.supplier_contact_email||contact.emailid2&&($scope.order.supplier_contact_email=contact.emailid2),!$scope.order.supplier_contact_email&&contact.email&&($scope.order.supplier_contact_email=contact.email),!$scope.order.supplier_contact_mobile&&contact.contact_no&&($scope.order.supplier_contact_mobile=contact.contact_no)},$scope.buyerContactDetails=function(data){data.phonenumber1&&($scope.order.buyer_contact_mobile=data.phonenumber1),$scope.order.buyer_contact_mobile||data.phonenumber2&&($scope.order.buyer_contact_mobile=data.phonenumber2),data.emailid1&&($scope.order.buyer_contact_email=data.emailid1),$scope.order.buyer_contact_email||data.emailid2&&($scope.order.buyer_contact_email=data.emailid2)},$scope.save=function(data){return $scope.disableSave=!0,data.so_supply_type?data.authorizedBy?data.soDate?data.project?data.supplierContactName?data.supplier_address?data.buyer_contact?data.deliveryDate?($scope.showLoader=!0,data.soDate&&(data.so_date=dateService.convertDateToPython(data.soDate)),data.authorizedBy&&(data.authorized_by=data.authorizedBy.fullName,data.authorized_by_user=data.authorizedBy.id),data.deliveryDate&&(data.delivery_date=dateService.convertDateToPython(data.deliveryDate)),data.attachments=[],data.buyer_contact&&(data.buyer_contact_name=data.buyer_contact.fullName),data.supplierContactName&&(data.supplier_contact_name=data.supplierContactName.fullName),data.sub_project||delete data.sub_project,data.so_type||delete data.so_type,$scope.showLoader=!0,void(data.id?(delete data.enquiry,delete data.owner,SalesOrderService.update(data.id,data).then(function(res){$scope.disableSave=!1,$scope.order=res.data,$scope.disabledOrder=!0,$scope.disabledData=!1,$scope.disableImport=!1,$scope.showLoader=!1,$scope.tabIndex=1,FetchOrderDetails(),Notification.success({message:"Successfully updated",positionX:"right",positionY:"top"})},function(err){$scope.disableSave=!1})):(data.accepted_by_supplier=!0,data.so_status=1,SalesOrderService.post(data).then(function(res){$scope.showLoader=!1,$scope.disableSave=!1,$scope.order=res.data,$scope.disabledOrder=!0,$scope.tabIndex=1,FetchOrderDetails(),Notification.success({message:"Successfully Saved",positionX:"right",positionY:"top"})},function(error){$scope.disableSave=!1})))):(Notification.error({message:"please select delivery date",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select buyer contact",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select supplier address",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select supplier contact",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select project",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select date",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please enter authorized by",positionX:"right",positionY:"top"}),void($scope.disableSave=!1)):(Notification.error({message:"please select supply Type",positionX:"right",positionY:"top"}),void($scope.disableSave=!1))},$scope.FilterBuyerDetails=function(data){$stateParams.soId||($scope.order.buyer_company=data.id,$scope.order.buyer_company_name=data.name),$scope.buyerContact=[],$scope.buyerAddress=[];var buyerInfo=data;buyerInfo.contacts.length&&buyerInfo.contacts.forEach(function(item){var name;item.firstname&&(name=item.firstname),item.lastname&&(name+=item.lastname),name&&(item.fullName=name),$scope.buyerContact.push(item)}),buyerInfo.addresses.length&&(buyerInfo.addresses.map(function(data){var address;data.nameofaddress&&(address=data.nameofaddress),data.addressline1&&(address?address+=","+data.addressline1:address=data.addressline1),data.addressline2&&(address?address+=","+data.addressline2:address=data.addressline2),data.city&&(address?address+=","+data.city:address=data.city),data.state&&(address?address+=","+data.state:address=data.state),data.country&&(address?address+=","+data.country:address=data.country),$scope.buyerAddress.push({address:address,id:data.id})}),$stateParams.soId&&$scope.order&&$scope.order.buyer_address&&($scope.order.buyer_address=$scope.order.buyer_address.id))},$scope.importData=function(csvfile){if(currentData=[],!fileName)return void Notification.error({message:"please select file to import",positionX:"right",positionY:"top"});$scope.data=CsvService.csvParser(csvfile,"SalesOrderService"),currentData.push($scope.data),$scope.fileList.push($scope.data),$scope.uploadedFilesList.push({fileName:fileName,save:!1}),Notification.success({message:"Successfully imported file",positionX:"right",positionY:"top"}),document.getElementById("sales-order-file").value=null,fileName=null;var file=document.getElementById("sales-order-file");file.value=null,$scope.disabledData=!0,$scope.fileContent=null,$scope.disableImport=!0},$scope.getFileName=function(){var file=document.getElementById("sales-order-file");fileName=file.value.split("\\").pop()},$scope.SaveItems=function($index,currency){if(!currency)return void Notification.error({message:"please select currency",positionX:"right",positionY:"top"});var error=!1,data=[];currentData.length&&(currentData.map(function(item){item.map(function(info){if(Object.keys(info).length){if(error)return;if(!info.quantity_ordered)return Notification.error({message:"please enter quantity_ordered",positionX:"right",positionY:"top"}),void(error=!0);if(!info.unit_measure)return Notification.error({message:"please enter units of measure",positionX:"right",positionY:"top"}),void(error=!0);if(!info.unit_price)return Notification.error({message:"please enter units price",positionX:"right",positionY:"top"}),void(error=!0);if(!info.delivery_date)return Notification.error({message:"please enter delivery date",positionX:"right",positionY:"top"}),void(error=!0)}})}),error||(currentData.map(function(item){item.map(function(info){if(info.title){info.total_price||(info.total_price=Number(info.quantity_ordered)*Number(info.unit_price)),info.delivery_date.includes("-")&&(info.delivery_date=info.delivery_date.split("-").join("/"));var totalTax=0;info.sgst&&(totalTax=Number(info.sgst)),info.cgst&&(totalTax=totalTax?Number(info.cgst)+Number(totalTax):Number(info.cgst)),info.igst&&(totalTax=0,totalTax=Number(info.igst)),info.vat&&(totalTax=0,totalTax=Number(info.vat)),info.other_charges&&(totalTax?totalTax+=Number(info.other_charges):totalTax=Number(info.other_charges));var total=Number(info.unit_price)*Number(info.quantity_ordered),value=(total*(totalTax/100)).toFixed(2);info.total_price_with_tax=Number(total)+Number(value),info.currency=currency,info.so=$scope.order.id,data.push(info)}})}),SalesOrderService.saveSOItems(data).then(function(res){var info=$scope.uploadedFilesList[$index];info.savedItems=res.data,info.save=!0,$scope.disableCurrency=!0,UpdateSalesAmount()})))},$scope.Edit=function(){$scope.disabledOrder=!1},$scope.ViewItems=function(ev,$index,currency){if(!currency)return void Notification.error({message:"please select currency",positionX:"right",positionY:"top"});var type,deleteItems,SoItem=$scope.uploadedFilesList[$index],items=[];if(SoItem.save&&SoItem.savedItems){var data=SoItem.savedItems;data.map(function(so,$index){so.title&&(so.checked=!1,so.total_price||(so.total_price=parseInt(so.quantity_ordered)*parseInt(so.unit_price)),deleteItems=!0,so.displayId=so.item_number.split("-").pop().split("_").pop(),type="edit",items.push(so))})}else{var data=$scope.fileList[$index];data.map(function(so,$index){so.title&&(so.so=$scope.order.id,so.currency=currency,so.checked=!1,so.total_price||(so.total_price=parseInt(so.quantity_ordered)*parseInt(so.unit_price)),type="add",deleteItems=!1,so.displayId=$index+1,so.id=$index+1,items.push(so))})}return $mdDialog.show({controller:"layout.standard.SOItemController",templateUrl:"assets/js/modules/sales-order/view-so-items/view-so-items.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{items:items,"delete":deleteItems,showCheckbox:deleteItems,SOId:$scope.order.id,save:SoItem.save,type:type}}}).then(function(data){if(data){$scope.disableCurrency=!0,$scope.disabledData=!1,$scope.disableImport=!1;var SoItem=$scope.uploadedFilesList[$index];SoItem.save=!0,$scope.totalItemsCount=data.totalLength,SoItem.savedItems=data.savedItems,$scope.order=data.SOData,$scope.order.price_number||($scope.disableCurrency=!1),data.savedItems.length||$scope.uploadedFilesList.splice($index,1)}},function(err){})},$scope.EditItems=function(ev){return $scope.existingSOItems=$scope.existingSOItems.map(function(so,$index){if(so.title)return so.checked=!1,so.total_price||(so.total_price=parseInt(so.quantity_ordered)*parseInt(so.unit_price)),so.displayId=so.item_number.split("-").pop().split("_").pop(),so}),$mdDialog.show({controller:"layout.standard.SOItemController",templateUrl:"assets/js/modules/sales-order/view-so-items/view-so-items.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{items:$scope.existingSOItems,"delete":!0,save:!1,showCheckbox:!0,SOId:$scope.order.id,type:"edit"}}}).then(function(data){data&&($scope.existingSOItems=data.savedItems,$scope.order=data.SOData,$scope.existingSOItems.length||($scope.uploadedFilesList=[]),$scope.order.price_number||($scope.disableCurrency=!1),$scope.existingItemsPrice=$scope.order.price_number,data.savedItems.length||($scope.existingSOItems=[]),$scope.totalItemsCount=data.totalLength)},function(err){})},$scope.Done=function(){$state.go("supplierDashboard.SO.list")},$scope.cancel=function(){$state.go("supplierDashboard.SO.list")},$scope.DeleteSO=function($index){var arr=[],data=$scope.uploadedFilesList[$index];data&&data.savedItems?data.savedItems.map(function(del){SalesOrderService.deleteSOItems(del.id).then(function(res){arr.push(res.data),data.savedItems.length==arr.length&&($scope.disabledData=!1,$scope.disableImport=!1,$scope.uploadedFilesList.splice($index,1),$scope.fileList.splice($index,1),UpdateSalesAmount(!0))},function(err){$scope.disabledData=!1,$scope.disableImport=!1})}):($scope.disabledData=!1,$scope.disableImport=!1,$scope.uploadedFilesList.splice($index,1),$scope.fileList.splice($index,1))},$scope.SOPaymentTerms=function(ev){$scope.order&&$scope.order.id?$mdDialog.show({controller:"SO.Payment.Controller",templateUrl:"assets/js/modules/sales-order/SO-payment-terms/so-payment-terms.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,locals:{$dialogScope:{so:$scope.order,paymentData:$scope.payment,installmentsData:$scope.installmentsData}}}).then(function(res){res&&($scope.payment=res.payment,$scope.installmentsData=res.installments)}):Notification.error({message:"Sales Order Must be Create",positionX:"right",positionY:"top"})}}])}();