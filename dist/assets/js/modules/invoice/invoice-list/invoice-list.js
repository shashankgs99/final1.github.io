"use strict";!function(){var app=angular.module("app");app.controller("InvoiceController",["$scope","$window","$modal","$log","$state","Notification","$http","s3Service","CustomerService","$rootScope","$stateParams","InvoiceService","$mdDialog","InvoicePackingService",function($scope,$window,$modal,$log,$state,Notification,$http,s3Service,CustomerService,$rootScope,$stateParams,InvoiceService,$mdDialog,InvoicePackingService){function NumInWords(number){for(var first=["","one ","two ","three ","four ","five ","six ","seven ","eight ","nine ","ten ","eleven ","twelve ","thirteen ","fourteen ","fifteen ","sixteen ","seventeen ","eighteen ","nineteen "],tens=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],mad=["","thousand","million","billion","trillion"],word="",i=0;i<mad.length;i++){var tempNumber=number%(100*Math.pow(1e3,i));0!==Math.floor(tempNumber/Math.pow(1e3,i))&&(word=Math.floor(tempNumber/Math.pow(1e3,i))<20?first[Math.floor(tempNumber/Math.pow(1e3,i))]+mad[i]+" "+word:tens[Math.floor(tempNumber/(10*Math.pow(1e3,i)))]+"-"+first[Math.floor(tempNumber/Math.pow(1e3,i))%10]+mad[i]+" "+word),tempNumber=number%Math.pow(1e3,i+1),0!==Math.floor(tempNumber/(100*Math.pow(1e3,i)))&&(word=first[Math.floor(tempNumber/(100*Math.pow(1e3,i)))]+"hunderd "+word)}return word}function loadInvoiceList(data){InvoiceService.get(data).then(function(data){$scope.showLoader=!1,$scope.count=data.data.count,$scope.invoiceList=data.data.results},function(err){$scope.showLoader=!1})}function PrintPackingItems(items){var data=items[0],listno=data.invoice_number.split("-"),pllist_no="PL-"+listno[1]+"-"+listno[2];console.log(pllist_no);var plData={pl_number:pllist_no,invoice_number:data.invoice_number,invoice_date:data.invoice_date,supplier_name:data.invoice_from_name,invoice_from_address:{addressline1:data.invoice_from_address.addressline1,addressline2:data.invoice_from_address.addressline2,cityname:data.invoice_from_address.cityname,state:data.invoice_from_address.state,country:data.invoice_from_address.country},buyer_name:data.invoice_to_name,ship_to_name:data.invoice_ship_to_name};if(data.invoice_ship_to_address){var invoice_ship_to_address={addressline1:data.invoice_ship_to_address.addressline1,addressline2:data.invoice_ship_to_address.addressline2,cityname:data.invoice_ship_to_address.cityname,state:data.invoice_ship_to_address.state,country:data.invoice_ship_to_address.country};plData.invoice_ship_to_address=invoice_ship_to_address}if(data.invoice_to_address){var invoice_to_address={addressline1:data.invoice_to_address.addressline1,addressline2:data.invoice_to_address.addressline2,cityname:data.invoice_to_address.cityname,state:data.invoice_to_address.state,country:data.invoice_to_address.country};plData.invoice_to_address=invoice_to_address}$scope.current_user.data.company&&($scope.current_user.data.company.logo&&(plData.logo=$scope.current_user.data.company.logo),$scope.current_user.data.company.addresses&&$scope.current_user.data.company.addresses.length&&$scope.current_user.data.company.addresses.map(function(item){item.id==data.so.supplier_address&&(plData.company_addressline1=item.addressline1,plData.company_addressline2=item.addressline2,plData.company_city=item.cityname,plData.company_state=item.state,plData.company_country=item.country)}),plData.company_name=$scope.current_user.data.company.company_name),plData.items=items.packingItems,plData.so_number=data.so.so_number,plData.so_date=data.so.so_date;var body={plData:plData};$http.post("/backend/print-packing-items/",body).then(function(response){$scope.tempalte=response.data,OpenPLTemplate($scope.tempalte),Notification.success({message:"Successfully Printed",positionX:"right",positionY:"top"})})["catch"](function(error){Notification.error({message:"Not Successfully Printed",positionX:"right",positionY:"top"})})}function OpenPLTemplate(data){var content=window.open("","newWindow","width=1200,height=800");content.document.body.innerHTML=data}function OpenTemplate(data){var content=window.open("","newWindow","width=1200,height=800");content.document.body.innerHTML=data}$scope.selectedInvoice=[],$scope.showLoader=!0,loadInvoiceList({page_size:10,page:1}),$scope.currentPage=1,$scope.maxSize=10,$scope.$on("InvoiceFilters",function(event,data){data&&loadInvoiceList(data)}),$scope.selectedValue=function(data,index,value){value?$scope.selectedInvoice.push(data):$scope.selectedInvoice.splice(index,1)},$scope.AddInvoice=function(){$state.current.name.includes("supplierDashboard")?$state.go("supplierDashboard.invoice.create"):$state.go("buyerDashboard.invoice.create")},$scope.setPage=function(pageNo){$scope.currentPage=pageNo,loadInvoiceList(10,pageNo)},$scope.EditInvoice=function(data){return $scope.selectedInvoice.length>1?void Notification.error({message:"please select one item to edit",positionX:"right",positionY:"top"}):$scope.selectedInvoice.length<1?void Notification.error({message:"please select atleast one item to edit",positionX:"right",positionY:"top"}):void $state.go("supplierDashboard.invoice.edit",{invoiceId:$scope.selectedInvoice[0].id})},$scope.Viewinvoice=function(data){return data.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):data.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):void $state.go("supplierDashboard.invoice.view",{invoiceId:data.id})},$scope.PackingList=function(data,ev){return data.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):data.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):void InvoicePackingService.get({invoice:data[0].id}).then(function(response){$scope.count=response.data.count,$scope.packingItems=response.data.results,$scope.packingItems.length?(data.packingItems=$scope.packingItems,PrintPackingItems(data)):InvoiceService.getInvoiceItems({invoice:data[0].id}).then(function(res){return $scope.invoiceItems=res.data.results,$scope.invoiceItems.length?($scope.invoiceItems=$scope.invoiceItems.map(function(item){return item.invoice=data[0].id,item}),$mdDialog.show({controller:"layout.invoice.PackingListController",templateUrl:"assets/js/modules/invoice/packing-list/invoice-packing-list.html",parent:angular.element(document.body),targetEvent:ev,multiple:!0,clickOutsideToClose:!0,locals:{$dialogScope:{items:$scope.invoiceItems}}}).then(function(data){},function(err){})):void Notification.error({message:"No Items in invoice",positionX:"right",positionY:"top"})})})},$scope.PrintInvoice=function(info){if(info.length>1)return void Notification.error({message:"please select one item",positionX:"right",positionY:"top"});if(info.length<1)return void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"});var data=info[0],invoiceData={invoice_number:data.invoice_number,invoice_date:data.invoice_date,order_number:data.order_number,order_date:data.order_date,total_price:data.total_price.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),vat_value:data.vat_value,total_price_with_tax:data.total_price_with_tax,created:data.created,invoice_from_address:{addressline1:data.invoice_from_address.addressline1,addressline2:data.invoice_from_address.addressline2,cityname:data.invoice_from_address.cityname,state:data.invoice_from_address.state,country:data.invoice_from_address.country},invoice_title:data.invoice_title,invoice_type:data.invoice_type};if(data.invoice_from_name&&(invoiceData.invoice_from_name=data.invoice_from_name),data.invoice_to_name&&(invoiceData.invoice_to_name=data.invoice_to_name),data.invoice_ship_to_name&&(invoiceData.invoice_ship_to_name=data.invoice_ship_to_name),data.payment_terms&&(invoiceData.payment_terms=data.payment_terms),data.payment_through&&(invoiceData.payment_through=data.payment_through),data.invoice_from_contact_details&&(invoiceData.invoice_from_contact=data.invoice_from_contact_details),data.invoice_ship_to_contact_details&&(invoiceData.invoice_ship_to_contact_details=data.invoice_ship_to_contact_details),data.invoice_to_contact_details&&(invoiceData.invoice_to_contact_details=data.invoice_to_contact_details),data.invoice_ship_to_address){var invoice_ship_to_address={addressline1:data.invoice_ship_to_address.addressline1,addressline2:data.invoice_ship_to_address.addressline2,cityname:data.invoice_ship_to_address.cityname,state:data.invoice_ship_to_address.state,country:data.invoice_ship_to_address.country};invoiceData.invoice_ship_to_address=invoice_ship_to_address}if(data){var invoice_to_address={addressline1:data.invoice_to_address.addressline1,addressline2:data.invoice_to_address.addressline2,cityname:data.invoice_to_address.cityname,state:data.invoice_to_address.state,country:data.invoice_to_address.country};invoiceData.invoice_to_address=invoice_to_address}$scope.current_user.data.company&&($scope.current_user.data.company.logo&&(invoiceData.logo=$scope.current_user.data.company.logo),$scope.current_user.data.company.addresses&&$scope.current_user.data.company.addresses.length&&$scope.current_user.data.company.addresses.map(function(item){item.id==data.so.supplier_address&&(invoiceData.company_addressline1=item.addressline1,invoiceData.company_addressline2=item.addressline2,invoiceData.company_city=item.cityname,invoiceData.company_state=item.state,invoiceData.company_country=item.country)}),invoiceData.company_name=$scope.current_user.data.company.company_name),invoiceData.totalPriceInWords=NumInWords(parseInt(invoiceData.total_price_with_tax)),invoiceData.total_price_with_tax=data.total_price_with_tax.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),invoiceData.items=data.invoice_items,invoiceData.items=invoiceData.items.map(function(item){return item.so_serial_number=Number(item.so_item.item_number.split("-").pop().split("_").pop()),item}),data.bank_details.length&&(invoiceData.beneficiary_name=data.bank_details[0].beneficiary_name,invoiceData.branch_address=data.bank_details[0].branch_address,invoiceData.bank_name=data.bank_details[0].bank_name,invoiceData.account_number=data.bank_details[0].account_number,invoiceData.city=data.bank_details[0].city,invoiceData.country=data.bank_details[0].country,invoiceData.iban_code=data.bank_details[0].iban_code,invoiceData.ifsc_code=data.bank_details[0].ifsc_code,invoiceData.micr_code=data.bank_details[0].micr_code,invoiceData.pin_code=data.bank_details[0].pin_code,invoiceData.swift_number=data.bank_details[0].swift_number,invoiceData.state=data.bank_details[0].state),invoiceData.so_number=data.so.so_number,invoiceData.so_date=data.so.so_date,invoiceData.currency=data.so.currency;var body={invoiceData:invoiceData};$http.post("/backend/print-invoice/",body).then(function(response){$scope.tempalte=response.data,OpenTemplate($scope.tempalte),Notification.success({message:"Successfully Printed",positionX:"right",positionY:"top"})})["catch"](function(error){Notification.error({message:"Not Successfully Printed",positionX:"right",positionY:"top"})})}}])}();