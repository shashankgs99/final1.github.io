"use strict";!function(){var app=angular.module("app");app.controller("OperationalInventoryController",["$scope","$window","$modal","ProjectService","$state","Notification","POService","$http","PurchaseRequisitionService","StoreService","$rootScope","$stateParams","MRService",function($scope,$window,$modal,ProjectService,$state,Notification,POService,$http,PurchaseRequisitionService,StoreService,$rootScope,$stateParams,MRService){function LoadCategories(){$scope.poItemsList=[],$scope.inventoryList.map(function(item){item.po_item.pr_item_number&&PurchaseRequisitionService.get({item_number:item.po_item.pr_item_number}).then(function(res){$scope.poItemsList=$scope.poItemsList.concat(res.data.results),$scope.inventoryList.length==$scope.poItemsList.length&&($scope.inventoryList=$scope.inventoryList.map(function(record){record.pr_item=_.find($scope.poItemsList,function(o){return o.item_number==record.po_item.pr_item_number});var category=null;return record.pr_item.category&&(category=record.pr_item.category),record.pr_item.sub_category&&(category=category?category+"-"+record.pr_item.sub_category:record.pr_item.sub_category),record.pr_item.sub_sub_category&&(category=category?category+"-"+record.pr_item.sub_sub_category:record.pr_item.sub_sub_category),record.pr_item.sub_sub_sub_category&&(category=category?category+"-"+record.pr_item.sub_sub_sub_category:record.pr_item.sub_sub_sub_category),record.category_tree=category,record}),$scope.UiGridOptions.data=$scope.inventoryList)})})}function LoadColumns(){$scope.UiGridOptions.columnDefs=[],$scope.UiGridOptions.columnDefs=[{name:"checked",displayName:"",width:45,cellTemplate:'<input type="checkbox" ng-model="row.entity.checked" ng-click="grid.appScope.rowClick(row.entity)">',visible:!$scope.showColumn},{name:"id",displayName:"INV ID#",width:65,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"po_item.title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"po_item.description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"category_tree",displayName:"Category",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"net_quantity",displayName:"Quantity",width:100,pinnedLeft:!0,enableCellEdit:!1},{field:"po_item.unit_measure",displayName:"Unit Of Measure",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.material",displayName:"Material of Construction",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.grade",displayName:"Material Grade",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.specification",displayName:"Standard & Specification",width:150,pinnedLeft:!0,enableCellEdit:!1}],$scope.itemDetails1.columnDefs=[{name:"id",displayName:"INV ID#",width:65,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"po_item.title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"po_item.description",displayName:"Description",width:250,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"pr_item.category",displayName:"Category",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.sub_category",displayName:"Sub Category",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.sub_sub_category",displayName:"Secondary Sub Category",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"pr_item.sub_sub_sub_category",displayName:"Tertiary Sub Category",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"net_quantity",displayName:"Quantity",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"po_item.unit_measure",displayName:"Unit Of Measure",width:150,pinnedLeft:!0,enableCellEdit:!1}],$scope.itemDetails2.columnDefs=[{field:"pr_item.material",displayName:"Material Of Construction",width:180,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.grade",displayName:"Material Grade",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.specification",displayName:"Standards & Specifications",width:150,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.dimension_a",displayName:"Dimension 'a'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.unit_a",displayName:"Unit 'a'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.dimension_b",displayName:"Dimension 'b'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.unit_b",displayName:"Unit 'b'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.dimension_c",displayName:"Dimension 'c'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"pr_item.unit_c",displayName:"Unit 'c'",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn}]}function getLocations(data){StoreService.getInventoryLocations({inventory:selectedInventories[0].id}).then(function(res){$scope.inventoryLocations=res.data.results,$scope.locationGridOptions.data=_.sortBy(res.data.results,"store.store_type.id")})}$scope.showTable="listTable",$scope.showLoader=!0,$scope.showColumn=!1;var colorRowTemplate="<div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.uid\" ui-grid-one-bind-id-grid=\"rowRenderIndex + '-' + col.uid + '-cell'\" class=\"ui-grid-cell\" ng-class=\"{'yellow':(row.entity.store.store_type.name == 'Sub-Vendors' || row.entity.store.store_type.name == 'Customer'),'green':(row.entity.store.store_type.name == 'Production'),'ui-grid-row-header-cell': col.isRowHeader }\"  role=\"{{col.isRowHeader ? 'rowheader' : 'gridcell'}}\" ui-grid-cell></div>",selectedInventories=[];$scope.filter={},$scope.UiGridOptions={enableColumnResizing:!0,enableFiltering:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},$scope.toHelp=function(){$state.go("layout.standard.help.stroes",{type:"inventory"})},$stateParams.inventoryId&&(selectedInventories=[],selectedInventories.push($stateParams.inventoryId),PurchaseRequisitionService.get({item_number:$stateParams.inventoryId.po_item.pr_item_number}).then(function(res){$scope.showTable="itemDetailTable",$scope.showColumn=!0,LoadColumns(),getLocations(),$scope.viewMR(),$scope.viewGRN();var data=$stateParams.inventoryId;data.pr_item=res.data.results[0],$scope.itemDetails1.data=[],$scope.itemDetails2.data=[],$scope.itemDetails1.data.push(data),$scope.itemDetails2.data.push(data),$scope.inventoryItemDetail=angular.copy($scope.itemDetails2.data)})),$scope.itemDetails2={enableColumnResizing:!0,enableFiltering:!0,showGridFooter:!1,showColumnFooter:!1,fastWatch:!0,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},$scope.itemDetails1={enableColumnResizing:!0,enableFiltering:!0,showGridFooter:!1,showColumnFooter:!1,fastWatch:!0,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi}},ProjectService.getMainProjects().then(function(data){$scope.projectList=data.data}),$scope.current_user.data&&$scope.current_user.data.company&&POService.get({buyer_company_id:$scope.current_user.data.company.id}).then(function(data){$scope.POList=data.data.results}),LoadColumns(),$scope.current_user.data&&$scope.current_user.data.company&&($scope.poItemsList=[],StoreService.getInventoryItems({company:$scope.current_user.data.company.id}).then(function(res){$scope.inventoryList=res.data.results,LoadCategories(),$scope.showLoader=!1})),$scope.itemDetails=function(){return selectedInventories.length>1?void Notification.error({message:"please select one item",positionX:"right",positionY:"top"}):selectedInventories.length<1?void Notification.error({message:"please select atleast one item",positionX:"right",positionY:"top"}):void PurchaseRequisitionService.get({item_number:selectedInventories[0].po_item.pr_item_number}).then(function(res){$scope.showTable="itemDetailTable",$scope.showColumn=!0,LoadColumns(),getLocations(),$scope.viewMR(),$scope.viewGRN();var data=selectedInventories[0];data.pr_item=res.data.results[0],$scope.itemDetails1.data=[],$scope.itemDetails2.data=[],$scope.itemDetails1.data.push(data),$scope.itemDetails2.data.push(data),$scope.inventoryItemDetail=angular.copy($scope.itemDetails2.data)})},$scope.rowClick=function(data){if(data.checked)selectedInventories.push(data);else{var index=null;selectedInventories.map(function(item,$index){item.id==data.id&&(index=$index)}),selectedInventories.splice(index,1)}},$scope.grnGridOptions={enableColumnResizing:!0,enableFiltering:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,columnDefs:[{field:"quantity_received",displayName:"Quantity Received",width:80,pinnedLeft:!0,enableCellEdit:!1},{field:"manufacturer",displayName:"Manufacturer",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"batch",displayName:"Batch No",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"serial",displayName:"Serial No",width:125,pinnedLeft:!0,enableCellEdit:!1,visible:$scope.showColumn},{field:"production_date",displayName:"Production Date",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"expiry_date",displayName:"Expiry Date",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"yard_receipt_date",displayName:"Yard Receipt Date",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"grn.internal_reference_number",displayName:"GRN",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"imin_status.name",displayName:"IMIN",width:125,pinnedLeft:!0,enableCellEdit:!1},{field:"inspected_remarks",displayName:"IMIN Remarks",width:150,pinnedLeft:!0,enableCellEdit:!1}]},$scope.viewGRN=function(){POService.getGRNItems({po_item:selectedInventories[0].po_item.id}).then(function(res){$scope.stockInfo=res.data.results,$scope.grnGridOptions.data=res.data.results,POService.getOne(res.data.results[0].po_item.po).then(function(res){$scope.order=res.data})})},$scope.back=function(){"itemDetailTable"==$scope.showTable&&($scope.showTable="listTable",$scope.showColumn=!1,LoadColumns(),$scope.UiGridOptions.data=[],$scope.inventoryList=$scope.inventoryList.map(function(item){return item.checked=!1,item}),$scope.UiGridOptions.data=$scope.inventoryList,LoadCategories(),selectedInventories=[]),"grnTable"==$scope.showTable&&($scope.showTable="itemDetailTable"),"mrTable"==$scope.showTable&&($scope.showTable="itemDetailTable")},$scope.viewMR=function(){MRService.getItems({inventory:selectedInventories[0].id}).then(function(res){$scope.MRData=res.data.results,$scope.mrGridOptions.data=res.data.results,$scope.mrGridOptions.data=$scope.mrGridOptions.data.map(function(item){return item.owner.fullName=item.owner.first_name+" "+item.owner.last_name,item}),$scope.mrGridOptions.data=_.sortBy($scope.mrGridOptions.data,"id")})},$scope.mrGridOptions={data:[],enableFiltering:!0,showGridFooter:!0,showColumnFooter:!0,columnDefs:[{name:"MR.id",displayName:"MR #",width:70,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{name:"created",displayName:"Date",width:130,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"owner.fullName",displayName:"Requested By",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"MR.request_type.name",displayName:"Request Type",width:190,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"MR.purpose.name",displayName:"Purpose",width:155,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"MR.order_reference.so_number",displayName:"Order Reference",width:160,pinnedLeft:!0,enableSorting:!1,enableCellEdit:!1},{field:"MR.source_type.name",displayName:"Source",width:160,pinnedLeft:!0,enableCellEdit:!1},{field:"MR.destination_type.name",displayName:"Destination",width:160,pinnedLeft:!0,enableCellEdit:!1},{field:"issued_quantity",displayName:"Quantity(issued)",width:100,pinnedLeft:!0,enableCellEdit:!1}]},$scope.applyFilters=function(data){data.grnId&&delete data.poId,StoreService.getInventoryItems(data).then(function(res){$scope.inventoryList=res.data.results,$scope.UiGridOptions.data=[],LoadCategories()})},$scope.clear=function(){$scope.filter={},StoreService.getInventoryItems().then(function(res){$scope.inventoryList=res.data.results,LoadCategories()})},$scope.filterGrn=function(data){POService.getGRN({poId:data}).then(function(res){$scope.grnList=res.data.results})},$scope.locationGridOptions={enableColumnResizing:!0,enableFiltering:!0,showGridFooter:!0,showColumnFooter:!0,fastWatch:!0,rowTemplate:colorRowTemplate,importerDataAddCallback:function(grid,newObjects){$scope.myData=$scope.data.concat(newObjects)},onRegisterApi:function(registeredApi){$scope.gridApi=registeredApi},columnDefs:[{name:"inventory.id",displayName:"ID#",width:65,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0},{field:"inventory.po_item.title",displayName:"Title",width:150,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"inventory.po_item.description",displayName:"Description",width:200,pinnedLeft:!0,enableCellEdit:!1,enableSorting:!0,cellTemplate:'<div title="{{COL_FIELD}}">{{COL_FIELD}}</div>'},{field:"quantity",displayName:"Quantity",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"inventory.po_item.unit_measure",displayName:"Unit Of Measure",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"store.store_type.name",displayName:"Store Type",width:150,pinnedLeft:!0,enableCellEdit:!1},{field:"store.store_name",displayName:"Store Name",width:150,pinnedLeft:!0,enableCellEdit:!1}]}}])}();