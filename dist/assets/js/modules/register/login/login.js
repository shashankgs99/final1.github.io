"use strict";!function(){angular.module("app").controller("login.controller",["$scope","$stateParams","$location","UserService","$ocLazyLoad","Notification","$window","$timeout","$injector","$http","$log","$state","$mdDialog",function($scope,$stateParams,$location,UserService,$ocLazyLoad,Notification,$window,$timeout,$injector,$http,$log,$state,$mdDialog){function getCurrentUser(source){$scope.current_user.data={},$scope.current_user.token=UserService.getDataFromLocalStorage("token"),UserService.getCurrentUser().then(function(data){if(!data.data||!data.data.id){var redirectUrl=redirectUrls.filter(function(url){return window.location.pathname.contains(url)});return void(redirectUrl.length&&$window.open($state.href("login.default",{redirectUrl:window.location.pathname}),"_self"))}if($scope.current_user.data=data.data,$scope.current_user.data.dashboards&&$scope.current_user.data.dashboards.length&&$scope.current_user.data.dashboards.map(function(record){"Supplier"==record.name&&($scope.current_user.data.is_seller=!0),"Buyer"==record.name&&($scope.current_user.data.is_buyer=!0),"Store"==record.name&&($scope.current_user.data.is_store=!0),"Finance"==record.name&&($scope.current_user.data.is_finance=!0)}),$scope.current_user.data.image_url=$scope.current_user.data.image_url?$scope.current_user.data.image_url:"/assets/img/user-img.png",$state.current.name.includes("layout.standard.companyIntro.intro"))$scope.current_user.data.token=$scope.current_user.token,$mdDialog.hide($scope.current_user.data);else{if(!data.data.is_email_verified)return Notification.error({message:"Email not verified. Please verfiy email and login.",positionX:"right",positionY:"top"}),void $timeout(function(){$scope.current_user.logout("/login")},3e3);"login"===source&&(Notification.success({message:"Successfully LoggedIn",positionX:"right",positionY:"bottom"}),$stateParams.redirectUrl&&window.open($stateParams.redirectUrl,"_self"))}})["catch"](function(response){})}function open(size,backdrop,itemCount,closeOnClick){var params={templateUrl:"forgot-password.html",resolve:{},controller:function($scope,$modalInstance,UserService){function forgotPassword(email){email?UserService.get({email:email}).then(function(response){console.log(response),response.data.count>0?$http.get("/sendgrid/forgot-password/",{params:{userEmail:email}}).then(function(response){Notification.success({message:"Sent email to the Email Address specified",positionX:"right",positionY:"top"}),$scope.ok()})["catch"](function(error){Notification.error({message:"Something went wrong. Please try again.",positionX:"right",positionY:"top"})}):Notification.error({message:"User with given email doesnt exist",positionX:"right",positionY:"top"})}):Notification.error({message:"Enter Email Address",positionX:"right",positionY:"top"})}$scope.forgotPassword=forgotPassword,$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};angular.isDefined(closeOnClick)&&(params.closeOnClick=closeOnClick),angular.isDefined(size)&&(params.size=size);var $modal=$injector.get("$modal"),modalInstance=$modal.open(params);modalInstance.result.then(function(selectedItem){},function(){$log.info("Modal dismissed at: "+new Date)})}$scope.cancel=function(){$mdDialog.cancel()},$stateParams.emailVerified&&Notification.success({message:"Email verified. Please login.",positionX:"right",positionY:"top"}),$state.current.name.includes("layout.standard.companyIntro.intro")&&($scope.current_user={});var redirectUrls=["/admin-dashboard","/supplier-dashboard","/buyer-dashboard","/market-dashboard","/stores-dashboard","/finance-dashboard"];$scope.selectList=function(type){$location.path(type)},$scope.dashboardsList=function(type){$scope.current_user&&Object.keys($scope.current_user.data).length&&$scope.current_user.data.id?$location.path(type):$window.open($state.href("login.default"),"_self")},$scope.login=function(){$window.open($state.href("login.default"),"_self")},$scope.pricing=function(){$window.open($state.href("layout.standard.pricing.page"),"_self")},$scope.register=function(){$window.open($state.href("register.options"),"_self")},getCurrentUser(),$scope.current_user.logout=function(route){UserService.deleteTokenFromLocalStorage(),UserService.logout().then(function(data){route?$window.location.assign(route):$window.location.assign("/")},function(err){})},$scope.current_user.login=function(data,valid_data){$scope.current_user.unsuccessful_attempt=!1,valid_data?UserService.getToken(data.username,data.password).then(function(response){$scope.current_user.token=response.data.token;var success=UserService.saveTokenToLocalStorage($scope.current_user.token);success&&getCurrentUser("login")})["catch"](function(response){$scope.current_user.unsuccessful_attempt=!0,Notification.error({message:"Incorrect username or password, please try again!",positionX:"right",positionY:"top"})}):Notification.error({message:"Please Enter Username and Password",positionX:"right",positionY:"top"})},$scope.current_user.updateUserProfile=function(data){console.log(data),UserService.update(data.id,data).then(function(data){$scope.success=!0,console.log("data saved");var Notification=$injector.get("Notification");Notification.success({message:"Data saved successfully",positionX:"right",positionY:"top"}),$timeout(function(){$state?(getCurrentUser(),$state.go($state.$current.parent.name+".view",{reload:!0})):getCurrentUser()},3e3)},function(err){$scope.error=err.data,console.log(err)})},$scope.getAccountSettings=function(){return $scope.current_user.data.is_superuser?$state.href("adminDashboard.myAccount.view"):$scope.current_user.data.is_superuser||$scope.current_user.data.is_seller?$state.href("supplierDashboard.myAccount.view"):$scope.current_user.data.is_superuser||$scope.current_user.data.is_buyer?$state.href("buyerDashboard.myAccount.view"):void 0},$scope.open=open,$scope.companySignUp=function(ev,data,$index){$mdDialog.show({controller:"company.login",templateUrl:"assets/js/modules/directory/states/list/views/content/modalpopup/companySignup.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,locals:{$dialogScope:{userInfo:$scope.current_user.data}}}).then(function(res){})}}])}();