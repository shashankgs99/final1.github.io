"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(root,factory){"undefined"!=typeof module&&module.exports?module.exports=factory(require("angular")):"function"==typeof define&&define.amd?define(["angular"],factory):factory(root.angular)}(window,function(angular){angular.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate",function($q,$parse,$http,$sce,$timeout,$templateCache,$interpolate){function link(scope,elem,attrs,ctrl){function handleInputChange(newval,initial){newval&&("object"===("undefined"==typeof newval?"undefined":_typeof(newval))?(scope.searchStr=extractTitle(newval),callOrAssign({originalObject:newval})):"string"==typeof newval&&newval.length>0?scope.searchStr=newval:console&&console.error&&console.error("Tried to set "+(initial?"initial":"")+" value of angucomplete to",newval,"which is an invalid value"),handleRequired(!0))}function clickoutHandlerForDropdown(event){mousedownOn=null,scope.hideResults(event),document.body.removeEventListener("click",clickoutHandlerForDropdown)}function ie8EventNormalizer(event){return event.which?event.which:event.keyCode}function callOrAssign(value){"function"==typeof scope.selectedObject?scope.selectedObject(value,scope.selectedObjectData):scope.selectedObject=value,handleRequired(value?!0:!1)}function callFunctionOrIdentity(fn){return function(data){return scope[fn]?scope[fn](data):data}}function setInputString(str){callOrAssign({originalObject:str}),scope.clearSelected&&(scope.searchStr=null),clearResults()}function extractTitle(data){return scope.titleField.split(",").map(function(field){return extractValue(data,field)}).join(" ")}function extractValue(obj,key){var keys,result;if(key){keys=key.split("."),result=obj;for(var i=0;i<keys.length;i++)result=result[keys[i]]}else result=obj;return result}function findMatchString(target,str){var result,matches,re;if(re=new RegExp(str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),target)return target.match&&target.replace||(target=target.toString()),matches=target.match(re),result=matches?target.replace(re,'<span class="'+scope.matchClass+'">'+matches[0]+"</span>"):target,$sce.trustAsHtml(result)}function handleRequired(valid){scope.notEmpty=valid,validState=scope.searchStr,scope.fieldRequired&&ctrl&&scope.inputName&&ctrl[scope.inputName].$setValidity(requiredClassName,valid)}function keyupHandler(event){var which=ie8EventNormalizer(event);if(which!==KEY_LF&&which!==KEY_RT)if(which===KEY_UP||which===KEY_EN)event.preventDefault();else if(which===KEY_DW)event.preventDefault(),!scope.showDropdown&&scope.searchStr&&scope.searchStr.length>=minlength&&(initResults(),scope.searching=!0,searchTimerComplete(scope.searchStr));else if(which===KEY_ES)clearResults(),scope.$apply(function(){inputField.val(scope.searchStr)});else{if(0===minlength&&!scope.searchStr)return;scope.searchStr&&""!==scope.searchStr?scope.searchStr.length>=minlength&&(initResults(),searchTimer&&$timeout.cancel(searchTimer),scope.searching=!0,searchTimer=$timeout(function(){searchTimerComplete(scope.searchStr)},scope.pause)):scope.showDropdown=!1,validState&&validState!==scope.searchStr&&!scope.clearSelected&&scope.$apply(function(){callOrAssign()})}}function handleOverrideSuggestions(event){!scope.overrideSuggestions||scope.selectedObject&&scope.selectedObject.originalObject===scope.searchStr||(event&&event.preventDefault(),$timeout.cancel(searchTimer),cancelHttpRequest(),setInputString(scope.searchStr))}function dropdownRowOffsetHeight(row){var css=getComputedStyle(row);return row.offsetHeight+parseInt(css.marginTop,10)+parseInt(css.marginBottom,10)}function dropdownHeight(){return dd.getBoundingClientRect().top+parseInt(getComputedStyle(dd).maxHeight,10)}function dropdownRow(){return elem[0].querySelectorAll(".angucomplete-row")[scope.currentIndex]}function dropdownRowTop(){return dropdownRow().getBoundingClientRect().top-(dd.getBoundingClientRect().top+parseInt(getComputedStyle(dd).paddingTop,10))}function dropdownScrollTopTo(offset){dd.scrollTop=dd.scrollTop+offset}function updateInputField(){var current=scope.results[scope.currentIndex];scope.matchClass?inputField.val(extractTitle(current.originalObject)):inputField.val(current.title)}function keydownHandler(event){var which=ie8EventNormalizer(event),row=null,rowTop=null;which===KEY_EN&&scope.results?(scope.currentIndex>=0&&scope.currentIndex<scope.results.length?(event.preventDefault(),scope.selectResult(scope.results[scope.currentIndex])):(handleOverrideSuggestions(event),clearResults()),scope.$apply()):which===KEY_DW&&scope.results?(event.preventDefault(),scope.currentIndex+1<scope.results.length&&scope.showDropdown&&(scope.$apply(function(){scope.currentIndex++,updateInputField()}),isScrollOn&&(row=dropdownRow(),dropdownHeight()<row.getBoundingClientRect().bottom&&dropdownScrollTopTo(dropdownRowOffsetHeight(row))))):which===KEY_UP&&scope.results?(event.preventDefault(),scope.currentIndex>=1?(scope.$apply(function(){scope.currentIndex--,updateInputField()}),isScrollOn&&(rowTop=dropdownRowTop(),rowTop<0&&dropdownScrollTopTo(rowTop-1))):0===scope.currentIndex&&scope.$apply(function(){scope.currentIndex=-1,inputField.val(scope.searchStr)})):which===KEY_TAB?scope.results&&scope.results.length>0&&scope.showDropdown?scope.currentIndex===-1&&scope.overrideSuggestions?handleOverrideSuggestions():(scope.currentIndex===-1&&(scope.currentIndex=0),scope.selectResult(scope.results[scope.currentIndex]),scope.$digest()):scope.searchStr&&scope.searchStr.length>0&&handleOverrideSuggestions():which===KEY_ES&&event.preventDefault()}function httpSuccessCallbackGen(str){return function(responseData,status,headers,config){status||headers||config||!responseData.data||(responseData=responseData.data),scope.searching=!1,processResults(extractValue(responseFormatter(responseData),scope.remoteUrlDataField),str)}}function httpErrorCallback(errorRes,status,headers,config){scope.searching=httpCallInProgress,status||headers||config||(status=errorRes.status),0!==status&&status!==-1&&(scope.remoteUrlErrorCallback?scope.remoteUrlErrorCallback(errorRes,status,headers,config):console&&console.error&&console.error("http error"))}function cancelHttpRequest(){httpCanceller&&httpCanceller.resolve()}function getRemoteResults(str){var params={},url=scope.remoteUrl+encodeURIComponent(str);scope.remoteUrlRequestFormatter&&(params={params:scope.remoteUrlRequestFormatter(str)},url=scope.remoteUrl),scope.remoteUrlRequestWithCredentials&&(params.withCredentials=!0),cancelHttpRequest(),httpCanceller=$q.defer(),params.timeout=httpCanceller.promise,httpCallInProgress=!0,$http.get(url,params).then(httpSuccessCallbackGen(str))["catch"](httpErrorCallback)["finally"](function(){httpCallInProgress=!1})}function getRemoteResultsWithCustomHandler(str){cancelHttpRequest(),httpCanceller=$q.defer(),scope.remoteApiHandler(str,httpCanceller.promise).then(httpSuccessCallbackGen(str))["catch"](httpErrorCallback)}function clearResults(){scope.showDropdown=!1,scope.results=[],dd&&(dd.scrollTop=0)}function initResults(){scope.showDropdown=displaySearching,scope.currentIndex=scope.focusFirst?0:-1,scope.results=[]}function getLocalResults(str){var i,match,s,value,searchFields=scope.searchFields.split(","),matches=[];for("undefined"!=typeof scope.parseInput()&&(str=scope.parseInput()(str)),i=0;i<scope.localData.length;i++){for(match=!1,s=0;s<searchFields.length;s++)value=extractValue(scope.localData[i],searchFields[s])||"",match=match||value.toString().toLowerCase().indexOf(str.toString().toLowerCase())>=0;match&&(matches[matches.length]=scope.localData[i])}return matches}function checkExactMatch(result,obj,str){if(!str)return!1;for(var key in obj)if(obj[key].toLowerCase()===str.toLowerCase())return scope.selectResult(result),!0;return!1}function searchTimerComplete(str){!str||str.length<minlength||(scope.localData?scope.$apply(function(){var matches;matches="undefined"!=typeof scope.localSearch()?scope.localSearch()(str,scope.localData):getLocalResults(str),scope.searching=!1,processResults(matches,str)}):scope.remoteApiHandler?getRemoteResultsWithCustomHandler(str):getRemoteResults(str))}function processResults(responseData,str){var i,description,image,text,formattedText,formattedDesc;if(responseData&&responseData.length>0)for(scope.results=[],i=0;i<responseData.length;i++)scope.titleField&&""!==scope.titleField&&(text=formattedText=extractTitle(responseData[i])),description="",scope.descriptionField&&(description=formattedDesc=extractValue(responseData[i],scope.descriptionField)),image="",scope.imageField&&(image=extractValue(responseData[i],scope.imageField)),scope.matchClass&&(formattedText=findMatchString(text,str),formattedDesc=findMatchString(description,str)),scope.results[scope.results.length]={title:formattedText,description:formattedDesc,image:image,originalObject:responseData[i]};else scope.results=[];scope.autoMatch&&1===scope.results.length&&checkExactMatch(scope.results[0],{title:text,desc:description||""},scope.searchStr)?scope.showDropdown=!1:0!==scope.results.length||displayNoResults?scope.showDropdown=!0:scope.showDropdown=!1}function showAll(){scope.localData?(scope.searching=!1,processResults(scope.localData,"")):scope.remoteApiHandler?(scope.searching=!0,getRemoteResultsWithCustomHandler("")):(scope.searching=!0,getRemoteResults(""))}var hideTimer,responseFormatter,unbindInitialValue,displaySearching,displayNoResults,inputField=elem.find("input"),minlength=MIN_LENGTH,searchTimer=null,requiredClassName=REQUIRED_CLASS,validState=null,httpCanceller=null,httpCallInProgress=!1,dd=elem[0].querySelector(".angucomplete-dropdown"),isScrollOn=!1,mousedownOn=null;elem.on("mousedown",function(event){event.target.id?(mousedownOn=event.target.id,mousedownOn===scope.id+"_dropdown"&&document.body.addEventListener("click",clickoutHandlerForDropdown)):mousedownOn=event.target.className}),scope.currentIndex=scope.focusFirst?0:null,scope.searching=!1,unbindInitialValue=scope.$watch("initialValue",function(newval){newval&&(unbindInitialValue(),handleInputChange(newval,!0))}),scope.$watch("fieldRequired",function(newval,oldval){newval!==oldval&&(newval?handleRequired(validState&&scope.currentIndex!==-1?!0:!1):ctrl[scope.inputName].$setValidity(requiredClassName,!0))}),scope.$on("angucomplete-alt:clearInput",function(event,elementId){elementId&&elementId!==scope.id||(scope.searchStr=null,callOrAssign(),handleRequired(!1),clearResults())}),scope.$on("angucomplete-alt:changeInput",function(event,elementId,newval){elementId&&elementId===scope.id&&handleInputChange(newval)}),scope.onFocusHandler=function(){scope.focusIn&&scope.focusIn(),0!==minlength||scope.searchStr&&0!==scope.searchStr.length||(scope.currentIndex=scope.focusFirst?0:scope.currentIndex,scope.showDropdown=!0,showAll())},scope.hideResults=function(){mousedownOn&&(mousedownOn===scope.id+"_dropdown"||mousedownOn.indexOf("angucomplete")>=0)?mousedownOn=null:(hideTimer=$timeout(function(){clearResults(),scope.$apply(function(){scope.searchStr&&scope.searchStr.length>0&&inputField.val(scope.searchStr)})},BLUR_TIMEOUT),cancelHttpRequest(),scope.focusOut&&scope.focusOut(),scope.overrideSuggestions&&scope.searchStr&&scope.searchStr.length>0&&scope.currentIndex===-1&&handleOverrideSuggestions())},scope.resetHideResults=function(){hideTimer&&$timeout.cancel(hideTimer)},scope.hoverRow=function(index){scope.currentIndex=index},scope.selectResult=function(result){scope.matchClass&&(result.title=extractTitle(result.originalObject),result.description=extractValue(result.originalObject,scope.descriptionField)),scope.clearSelected?scope.searchStr=null:scope.searchStr=result.title,callOrAssign(result),clearResults()},scope.inputChangeHandler=function(str){return str.length<minlength?(cancelHttpRequest(),clearResults()):0===str.length&&0===minlength&&showAll(),scope.inputChanged&&(str=scope.inputChanged(str)),str},scope.fieldRequiredClass&&""!==scope.fieldRequiredClass&&(requiredClassName=scope.fieldRequiredClass),scope.minlength&&""!==scope.minlength&&(minlength=parseInt(scope.minlength,10)),scope.pause||(scope.pause=PAUSE),scope.clearSelected||(scope.clearSelected=!1),scope.overrideSuggestions||(scope.overrideSuggestions=!1),scope.fieldRequired&&ctrl&&handleRequired(scope.initialValue?!0:!1),scope.inputType=attrs.type?attrs.type:"text",scope.textSearching=attrs.textSearching?attrs.textSearching:TEXT_SEARCHING,scope.textNoResults=attrs.textNoResults?attrs.textNoResults:TEXT_NORESULTS,displaySearching="false"!==scope.textSearching,displayNoResults="false"!==scope.textNoResults,scope.maxlength=attrs.maxlength?attrs.maxlength:MAX_LENGTH,inputField.on("keydown",keydownHandler),inputField.on("keyup compositionend",keyupHandler),responseFormatter=callFunctionOrIdentity("remoteUrlResponseFormatter"),$timeout(function(){var css=getComputedStyle(dd);isScrollOn=css.maxHeight&&"auto"===css.overflowY})}var KEY_DW=40,KEY_RT=39,KEY_UP=38,KEY_LF=37,KEY_ES=27,KEY_EN=13,KEY_TAB=9,MIN_LENGTH=3,MAX_LENGTH=524288,PAUSE=500,BLUR_TIMEOUT=200,REQUIRED_CLASS="autocomplete-required",TEXT_SEARCHING="Searching...",TEXT_NORESULTS="No results found",TEMPLATE_URL="/angucomplete-alt/index.html";return $templateCache.put(TEMPLATE_URL,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" tabindex="{{fieldTabindex}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results | limitTo: 5" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",selectedObjectData:"=",disableInput:"=",initialValue:"=",localData:"=",localSearch:"&",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",textSearching:"@",textNoResults:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",fieldTabindex:"@",inputName:"@",focusFirst:"@",parseInput:"&"},templateUrl:function(element,attrs){return attrs.templateUrl||TEMPLATE_URL},compile:function(tElement){var startSym=$interpolate.startSymbol(),endSym=$interpolate.endSymbol();if("{{"!==startSym||"}}"!==endSym){var interpolatedHtml=tElement.html().replace(/\{\{/g,startSym).replace(/\}\}/g,endSym);tElement.html(interpolatedHtml)}return link}}}])});